<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <title>The Learn'd Developer: Design Patterns - </title>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
    q { quotes: "“" "”" "‘" "’"; }
  </style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="stylesheets/styles.css">
  <meta name="viewport" content="width=device-width">
</head>
<body>
<p>
	<h1>The Learn'd Developer: Design Patterns</h1>
	<h3>By Rob Levin</h3>
	<h3><a href="http://twitter.com/roblevintennis">@roblevintennis</a></h3>
	<h3>Github: <a href="https://github.com/roblevintennis">https://github.com/roblevintennis</a></h3>
</p>
<nav id="TOC">
<ul>
<li><a href="#preface">Preface</a></li>
<li><a href="#introduction">Introduction</a><ul>
<li><a href="#tdd">TDD</a></li>
<li><a href="#design-patterns">Design Patterns</a><ul>
<li><a href="#pattern-structures">Pattern Structures</a></li>
</ul></li>
</ul></li>
<li><a href="#observer-pattern">Observer Pattern</a><ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#observer-pattern-class-diagram">Observer Pattern Class Diagram</a></li>
<li><a href="#implementing-observer-pattern-using-tdd">Implementing Observer Pattern using TDD</a><ul>
<li><a href="#refactoring">Refactoring</a></li>
<li><a href="#a-slight-detour-what-should-i-test">A Slight Detour: What should I test?</a><ul>
<li><a href="#structured-basis-testing">Structured Basis Testing</a></li>
<li><a href="#boundary-conditions-testing">Boundary Conditions Testing</a></li>
<li><a href="#known-error-testing">Known Error Testing</a></li>
<li><a href="#data-flow-testing">Data-Flow Testing</a></li>
<li><a href="#cross-checking">Cross Checking</a></li>
</ul></li>
<li><a href="#testing-both-the-happy-and-sad-paths">Testing both the <q>happy</q> and <q>sad</q> paths</a></li>
<li><a href="#implementing-observers">Implementing Observers</a></li>
</ul></li>
<li><a href="#final-implementation">Final Implementation</a><ul>
<li><a href="#observertests.php">ObserverTests.php</a></li>
<li><a href="#observer.php">Observer.php</a></li>
</ul></li>
<li><a href="#considerations">Considerations</a><ul>
<li><a href="#spl">SPL</a></li>
<li><a href="#push-vs.pull">Push vs. Pull</a></li>
<li><a href="#pitfalls">Pitfalls</a></li>
<li><a href="#example-uses">Example Uses</a></li>
</ul></li>
<li><a href="#exercises">Exercises</a></li>
<li><a href="#summary">Summary</a></li>
</ul></li>
<li><a href="#object-oriented-principles">Object Oriented Principles</a><ul>
<li><a href="#abstraction">Abstraction</a></li>
<li><a href="#class">Class</a></li>
<li><a href="#interface">Interface</a></li>
<li><a href="#dynamic-binding">Dynamic Binding</a></li>
<li><a href="#inheritance">Inheritance</a></li>
<li><a href="#encapsulation">Encapsulation</a></li>
<li><a href="#polymorphism">Polymorphism</a></li>
<li><a href="#s.o.l.i.d.-principles">S.O.L.I.D. Principles</a></li>
<li><a href="#srp-the-single-responsibility-principle">SRP: The Single Responsibility Principle</a></li>
<li><a href="#openclosed-principle">Open/Closed Principle</a></li>
<li><a href="#liskov-substitution-principle">Liskov Substitution Principle</a></li>
<li><a href="#interface-segregation-principle">Interface Segregation Principle</a></li>
<li><a href="#dependency-inversion-principle">Dependency Inversion Principle</a></li>
</ul></li>
<li><a href="#decorator-pattern">Decorator Pattern</a><ul>
<li><a href="#overview-1">Overview</a></li>
<li><a href="#decorator-pattern-class-diagram">Decorator Pattern Class Diagram</a></li>
<li><a href="#decorator-pattern-implementation">Decorator Pattern Implementation</a><ul>
<li><a href="#java-implementation">Java Implementation</a></li>
<li><a href="#php-implementation">PHP Implementation</a></li>
</ul></li>
<li><a href="#considerations-1">Considerations</a><ul>
<li><a href="#decorator-vs.inheritance">Decorator vs. Inheritance</a></li>
<li><a href="#transparency">Transparency</a></li>
</ul></li>
<li><a href="#pitfalls-1">Pitfalls</a></li>
<li><a href="#exercises-1">Exercises</a></li>
</ul></li>
<li><a href="#factory-pattern">Factory Pattern</a><ul>
<li><a href="#overview-2">Overview</a></li>
<li><a href="#factory-method">Factory Method</a><ul>
<li><a href="#factory-method-variations">Factory Method Variations</a></li>
<li><a href="#pitfalls-2">Pitfalls</a><ul>
<li><a href="#layers-of-indirection">Layers of indirection:</a></li>
<li><a href="#conditional-code">Conditional code:</a></li>
<li><a href="#complicated">Complicated:</a></li>
</ul></li>
</ul></li>
<li><a href="#abstract-factory">Abstract Factory</a><ul>
<li><a href="#pitfalls-3">Pitfalls</a><ul>
<li><a href="#adding-new-components">Adding new components:</a></li>
<li><a href="#complexity">Complexity:</a></li>
</ul></li>
</ul></li>
<li><a href="#static-factory">Static Factory</a><ul>
<li><a href="#pitfalls-4">Pitfalls</a></li>
</ul></li>
<li><a href="#final-thoughts">Final Thoughts</a></li>
</ul></li>
<li><a href="#singleton-pattern">Singleton Pattern</a><ul>
<li><a href="#overview-3">Overview</a></li>
<li><a href="#implementation">Implementation</a></li>
</ul></li>
<li><a href="#builder-pattern">Builder Pattern</a><ul>
<li><a href="#overview-4">Overview</a></li>
<li><a href="#participants-and-collaborations">Participants and Collaborations</a></li>
<li><a href="#implementation-1">Implementation</a><ul>
<li><a href="#implementation-2">Implementation</a></li>
</ul></li>
<li><a href="#pitfalls-5">Pitfalls</a></li>
<li><a href="#summary-1">Summary</a></li>
</ul></li>
<li><a href="#command-pattern">Command Pattern</a><ul>
<li><a href="#overview-5">Overview</a><ul>
<li><a href="#implementation-3">Implementation</a></li>
<li><a href="#the-very-simplest-command-pattern-implementation">The <q>Very Simplest</q> Command Pattern Implementation</a></li>
<li><a href="#naming-conventions">Naming Conventions</a></li>
</ul></li>
<li><a href="#example-a-user-interface-toolkit">Example: A user interface toolkit</a><ul>
<li><a href="#designing-on-the-go">Designing <q>on the go</q></a></li>
<li><a href="#implementation-4">Implementation</a></li>
<li><a href="#code-walk-through">Code walk-through</a></li>
</ul></li>
</ul></li>
<li><a href="#template-pattern">Template Pattern</a><ul>
<li><a href="#overview-6">Overview</a></li>
<li><a href="#hollywood-principle">Hollywood Principle</a></li>
<li><a href="#features">Features</a></li>
<li><a href="#hooks">Hooks</a></li>
<li><a href="#participants">Participants</a></li>
<li><a href="#implementation-5">Implementation</a></li>
<li><a href="#example-audio-decoder">Example: Audio Decoder</a></li>
<li><a href="#exercises-2">Exercises</a></li>
<li><a href="#pitfalls-6">Pitfalls</a></li>
<li><a href="#summary-2">Summary</a></li>
</ul></li>
<li><a href="#strategy-pattern">Strategy Pattern</a><ul>
<li><a href="#overview-7">Overview</a></li>
<li><a href="#features-1">Features</a></li>
<li><a href="#participants-1">Participants</a></li>
<li><a href="#implementation-6">Implementation</a></li>
<li><a href="#pitfalls-7">Pitfalls</a></li>
<li><a href="#summary-3">Summary</a></li>
</ul></li>
<li><a href="#state-pattern">State Pattern</a><ul>
<li><a href="#overview-8">Overview</a></li>
<li><a href="#participants-and-collaborations-1">Participants and Collaborations</a></li>
<li><a href="#design-process">Design Process</a><ul>
<li><a href="#states">States</a></li>
<li><a href="#actions">Actions</a></li>
<li><a href="#putting-it-all-together">Putting it all together</a></li>
</ul></li>
<li><a href="#case-study-audio-application">Case Study: Audio Application</a><ul>
<li><a href="#implementation-7">Implementation</a></li>
</ul></li>
<li><a href="#other-use-cases">Other Use Cases</a></li>
<li><a href="#exercises-3">Exercises</a></li>
<li><a href="#benefits">Benefits</a></li>
<li><a href="#issues">Issues</a></li>
<li><a href="#summary-4">Summary</a></li>
</ul></li>
<li><a href="#composite-pattern">Composite Pattern</a><ul>
<li><a href="#overview-9">Overview</a></li>
<li><a href="#implementation-8">Implementation</a></li>
<li><a href="#issues-1">Issues</a></li>
<li><a href="#summary-5">Summary</a></li>
</ul></li>
</ul>
</nav>
<h1 id="preface"><a href="#TOC">Preface</a></h1>
<p>I decided to write this book because I thought it would be interesting to cover Design Patterns using a test-driven approach—I’m a sucker for <q>killing two birds with one stone</q>. Because of this choice, the chapter on Observer pattern serves dual purposes with a particular focus on getting the reader up to speed on TDD basics. More advanced TDD topics like proper use of <em>test doubles</em>, writing testable code, etc., will not be addressed (although I try to provide links for further investigation where appropriate). All this said, the primary subject of this book is not TDD, it’s Design Patterns! Also, please be forwarned that we will not be able to be particularly rigorous in our test coverage and will likely be omitting a lot of defensive code that would be required of a <q>real system</q>. I have chosen understandibility over robustness for an obvious reason—I don’t want the reader to get lost in details that don’t really pertain to the point being made. This is a fairly typical approach, but I apologize in advanced if I somehow insult your sensibilities!</p>
<p><strong>Programming Languages</strong></p>
<p>Most of the examples will be in Java, PHP, and JavaScript, but some might use other languages. This should be fine since:</p>
<ul>
<li>TDD and Design Patterns should be language agnostic</li>
<li>The examples will be simple enough to follow (even if in an unfamiliar language)</li>
</ul>
<p><strong>Resources</strong></p>
<p>I’ve generally listed any resources as clickable web links that you can learn more from, or, as links to where you might purchase the book that I’m referencing.</p>
<p><strong>Line breaks in code</strong></p>
<p>I’ve taken the liberty of purposely wrapping long lines that won’t fit within the width of the page.</p>
<p><em>Also, I’ve found that the generated code samples for PHP do not show up correctly unless I start and end the sample code blocks out with corresponding PHP opening and closing tags. So that’s why every darn PHP code snippet has these!</em></p>
<p><strong>Contributions</strong></p>
<p>I am definitely open to collaborative authorship (hey, I did put it on github!), provided that other authors follow the general style and spirit of the book. At some point, I’ll try to define this all in a more concrete way. If you do want to contribute, you’ll probably want to have a good look at the commented Makefile, and also notice the use of <q>extra lines</q> between code samples. I’ve managed to find workarounds for the somewhat finicky pandoc/docbook tool-chain (and I’m thankful that it works at all since these tools really make life so much easier!)</p>
<p><strong>Special acknowledgement</strong></p>
<p>I feel obliged to commend Addy Osmani on his countless community contributions, particularly in developer education, and acknowledge that seeing the impact of his work inspired me to write myself. Also, the book: <a href="https://github.com/addyosmani">Essential JS Design Patterns</a> is where I shamelessly lifted the pandoc build process being used here!</p>
<h1 id="introduction"><a href="#TOC">Introduction</a></h1>
<p><strong>Why should we study design patterns?</strong></p>
<p>As design patterns help us to use object-oriented best practices, it is useful to already have some meaningful experience in object oriented programming before attempting a deep study of design patterns. In fact, we have seen some try to dissuade a study of design patterns until the reader has reached an architect or designer skill level (whatever exactly that means). Obviously, the more prerequisite knowledge you have, the faster and you’ll be able to grasp difficult abstract concepts; so perhaps there’s some truth to the level of readiness that’s ideal.</p>
<p>However, we would assert that you need not yet be an object oriented master to benefit from an initial study of design patterns. In fact, object oriented and good design go hand in hand—therefore, studying good design should reinforce your understanding of some object oriented concepts. Examples of design pattern implementations show object-oriented best practices <q>in action</q>, and, since many of us learn best by example, the study of the two at the same time just might be complimentary.</p>
<p>Before reading this book, please take some of the following disclaimers and suggestions in to account:</p>
<ul>
<li>design patterns are an ongoing study; you’ll likely learn new things when you return to the material at a later date</li>
<li>therefore, assume that you’ll need to return to the materials at later stages of your career</li>
<li>if we don’t explain something in a way that gets through to you, don’t give up; try to look at a few similar examples on the web, or in other design pattern books, and look for the similarities—it’ll start to make sense!</li>
<li>Our goal is simply to <q>get your feet wet</q> with design patterns and not to cover them exhaustively.</li>
</ul>
<h3 id="tdd"><a href="#TOC">TDD</a></h3>
<p>As we have stated, TDD is <em>not</em> the focus of this book, just an approach we’ve used to examine design patterns. However, unlike the majority of the book, the next chapter on Observer pattern <strong>does</strong> try to act as a sort of <q>TDD: up and running</q> tutorial—we painstakingly examine a TDD session (as we implement the Observer pattern) and go through each test case one by one in order to quickly bring you up to speed in TDD.</p>
<p><em>If you already have a lot of experience doing test-driven development, you may be <q>put off</q> by the verbosity of that chapter. Feel free to jump ahead, and, rest assured that subsequent chapters will be much more <q>to the point</q>.</em></p>
<h3 id="design-patterns"><a href="#TOC">Design Patterns</a></h3>
<p>We would be remiss not to mention the pioneers known as the <em>Gang of Four</em> who, with their book <a href="http://en.wikipedia.org/wiki/Design_Patterns">Design Patterns: Elements of Reusable Object-Oriented Software</a>, described several reusable patterns that can be used to solve common recurring software design dilemnas.</p>
<p>We will discuss several, but not all, of the <a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">GoF</a> patterns, since they lay the framework from which new design patterns have evolved. As every pattern has its pros and cons, we will list the ones we’ve noticed as applicable. As we cover each particular pattern, we will not be adhering to any rigid <em>pattern structures</em> like those presented in the following section. Our goal is to distill the material in an accessible way. Hence, we advise you to view this book as a supplementary material on the subject.</p>
<h4 id="pattern-structures"><a href="#TOC">Pattern Structures</a></h4>
<p>Formal design pattern descriptions are known to adhere to certain well-defined <em>pattern structures</em>. <a href="http://en.wikipedia.org/wiki/Christopher_Alexander">Christopher Alexandar</a> is an architecture academic who, while pioneering the whole design pattern concept in the first place, provided the <a href="http://c2.com/cgi/wiki?AlexandrianForm">Alexandrian Form</a>. The <em>Gang of Four</em> uses the <a href="http://c2.com/ppr/about/portland.html">Portland Form</a> (which includes no less than: <em>intent, motivation, applicability, structure, implementation, sample code, known uses, and related patterns sections</em>).</p>
<h1 id="observer-pattern"><a href="#TOC">Observer Pattern</a></h1>
<p><strong>Tip:</strong> <em>This is a long chapter that goes through the TDD process with a fine tooth comb. If you’re already comfortable with TDD, feel free to <a href="#final-implementation">skip to the bottom</a> to see the implementation.</em></p>
<h2 id="overview"><a href="#TOC">Overview</a></h2>
<p>Wikipedia describes the <a href="http://en.wikipedia.org/wiki/Observer_pattern" title="Observer Pattern - Wikipedia">Observer Pattern</a> as follows:</p>
<blockquote>
<p>The observer pattern is a software design pattern in which an object, called the subject, maintains a list of its dependents, called observers, and notifies them automatically of any state changes, usually by calling one of their methods…</p>
</blockquote>
<p>There are many event based systems that are quite <a href="https://github.com/millermedeiros/js-signals/wiki/Comparison-between-different-Observer-Pattern-implementations">similar</a> in spirit to the Observer pattern such as: <a href="http://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">Pub/Sub</a>, <a href="https://github.com/joyent/node/blob/master/lib/events.js">EventEmitter</a> (<a href="https://github.com/joyent/node">node.js</a>), <a href="https://developer.apple.com/library/mac/#documentation/Cocoa/Reference/Foundation/Classes/NSNotificationCenter_Class/Reference/Reference.html">NSNotification</a> (<a href="https://developer.apple.com/technologies/mac/cocoa.html">Cocoa</a>), etc. These all have in common the ability to dynamically notify one to many interested parties via some sort of broadcast mechanism. In the case of the Observer, a <em>subject</em> calls the <code>update</code> method of one to many <em>boserver</em> instances (it does this without needing to know anything specific about these parties other than that they implement a common interface to recieve said notifications). In object oriented circles, this decoupled use of composition and interfaces is called <a href="http://en.wikipedia.org/wiki/Design_Patterns#Introduction.2C_Chapter_1"><em>programming to an interface not an implementation</em></a>. This is a key object oriented principle that allows us to maintain orthogonality in our systems.</p>
<p>Another feature of this pattern is that observers can be added or removed at runtime—thus providing a means to <q>hot swap</q> components easily when needed.</p>
<p>At its core the pattern involves the following steps:</p>
<ol type="1">
<li><p>Allow <em>observers</em> to register (and also unregister) to recieve notifications.</p></li>
<li><p>Keep these observer instances in a suitable data structure such as a <em>List</em> or <em>Array</em>.</p></li>
<li><p>When state changes (e.g. a new article is published, a user logs in, a track is played, etc.) these observers are notified by the <em>subject</em> who calls an interface defined <code>update</code> method on each of the observers.</p></li>
</ol>
<h2 id="observer-pattern-class-diagram"><a href="#TOC">Observer Pattern Class Diagram</a></h2>
<p>The following is a class diagram that represents the Observer Pattern we’ll be discussing in this chapter:</p>
<figure>
<img src="img/observer.png" title="Observer Pattern UML Class Diagram" alt="Observer Pattern Class Diagram"><figcaption>Observer Pattern Class Diagram</figcaption>
</figure>
<p><em>Note that there can be 1..* concrete subjects or observers.</em></p>
<h2 id="implementing-observer-pattern-using-tdd"><a href="#TOC">Implementing Observer Pattern using TDD</a></h2>
<p>Let’s use TDD to implement this pattern. Specifically, we’ll be writing <a href="http://en.wikipedia.org/wiki/Unit_testing">unit tests</a> to test our Observer Pattern implementation as an isolated unit. Please be forwarned that I’ll start out going through each and every <q>Red, Green, Refactor</q> cycle (so you can get a feel for this process), but will eventually start to condense things as we move forward. We’ll be using the <a href="http://www.phpunit.de/manual/current/en/index.html">phpunit framework</a> for this chapter so make sure you have that installed if you’d like to follow along.</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">require_once</span><span class="ot">(</span><span class="st">&#39;Observer.php&#39;</span><span class="ot">);</span>

<span class="kw">class</span> ObserverTests <span class="kw">extends</span> PHPUnit_Framework_TestCase
{
    <span class="kw">public</span> <span class="kw">function</span> testSubscribing<span class="ot">()</span>
    {
        <span class="kw">$publisher</span> = <span class="kw">new</span> Subject<span class="ot">();</span>
        
    }
}
<span class="kw">?&gt;</span></code></pre>
<p>And when we run phpunit we get:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ phpunit ObserverTest.php <span class="co"># outputs:</span>
Fatal error: Class <span class="st">&#39;Subject&#39;</span> not found <span class="kw">in</span>
/Users/rlevin/programming/labs/BOOK/research/observer/ObserverTests.php on line 8</code></pre>
<p>So now we add the appropriate minimal code to get it green:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">abstract</span> <span class="kw">class</span> Subject
{
}
<span class="kw">class</span> ConcreteSubject <span class="kw">extends</span> Subject
{
}</code></pre>
<p>And then we move on to finishing up our spec:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">class</span> ObserverTests <span class="kw">extends</span> PHPUnit_Framework_TestCase
{
    <span class="kw">public</span> <span class="kw">function</span> testSubscribing<span class="ot">()</span>
    {
        <span class="kw">$observer</span> = <span class="fu">array</span><span class="ot">();</span>
        <span class="kw">$subject</span> = <span class="kw">new</span> ConcreteSubject<span class="ot">();</span>
        <span class="kw">$subject</span>-&gt;register<span class="ot">(</span><span class="kw">$observer</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">1</span><span class="ot">,</span> <span class="kw">$subject</span>-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Subscriber should have 1 observer when 1 registered.&quot;</span><span class="ot">);</span>
    }
}
<span class="kw">?&gt;</span></code></pre>
<p>Running phpunit again:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ phpunit ObserverTest.php <span class="co"># outputs:</span>
Fatal error: Call to undefined method <span class="fu">ConcreteSubject::register()</span> <span class="kw">in</span> 
/Users/rlevin/programming/labs/BOOK/research/observer/ObserverTests.php on line 10</code></pre>
<p>So we add the two methods:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span><span class="kw">$observer</span><span class="ot">)</span>
{
}
<span class="kw">public</span> <span class="kw">function</span> getNumberOfObservers<span class="ot">()</span>
{
}
<span class="kw">?&gt;</span></code></pre>
<p>And get following:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ phpunit ObserverTests.php
Should be 1 observer when 1 added.
Failed asserting that null matches expected 1.</code></pre>
<p>So we need to create the data structure to hold our list of observers:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">abstract</span> <span class="kw">class</span> Subject
{
}
<span class="kw">class</span> ConcreteSubject <span class="kw">extends</span> Subject
{
    <span class="kw">private</span> <span class="kw">$observers</span> = <span class="fu">array</span><span class="ot">();</span>
    <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span><span class="kw">$observer</span><span class="ot">)</span>
    {
        <span class="fu">array_push</span><span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">,</span> <span class="kw">$observer</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> getNumberOfObservers<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="fu">count</span><span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">);</span>
    }
}
<span class="kw">?&gt;</span></code></pre>
<h3 id="refactoring"><a href="#TOC">Refactoring</a></h3>
<p>So now that we have our first test spec defined (and we’re all green), we can take a step back and think about what in this code could be better. This is called <strong>refactoring</strong> (or <a href="http://en.wikipedia.org/wiki/Code_refactoring">Code Refactoring</a>). Note that we only start refactoring when our tests are green.</p>
<p>So, is there something about this code that strikes you as odd? It should! We have an abstract class but we’re not defining any abstract methods. In this case, the <em>register</em> method is really part of our Subject interface so we should add that abstract method to Subject:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">abstract</span> <span class="kw">class</span> Subject
{
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span><span class="kw">$observer</span><span class="ot">);</span>
    <span class="co">// abstract public function unregister($observer);</span>
}
<span class="kw">?&gt;</span></code></pre>
<p>Notice that we take the liberty of also adding the <code>unregister</code> abstract method, but we comment it out since we want to maintain a fairly fast <q>iterative rhythm</q>.</p>
<p>You may have also noticed that we made a pretend observer object (we could have used a <a href="http://en.wikipedia.org/wiki/Mock_object">fake object</a>, but in this case we knew we’d soon be implementing real observers). Let’s get rid of that and create a very simple but real observer now:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">public</span> <span class="kw">function</span> testSubscribing<span class="ot">()</span>
{
    <span class="kw">$observer</span> = <span class="kw">new</span> ConcreteObserver<span class="ot">();</span>
    <span class="st">...</span>
<span class="kw">?&gt;</span></code></pre>
<p>And we get a failure saying it’s not defined so…</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">interface</span> iObserver
{
}
<span class="kw">class</span> ConcreteObserver <span class="kw">implements</span> iObserver
{
} 
<span class="kw">?&gt;</span></code></pre>
<p>Ok, so we’ve proven that we can push an object on to a PHP array. <q>Big deal!</q>, you say. Sure, but we now have the benifit of having some test coverage to build on top of as we introduce more <q>exciting</q> features.</p>
<p><strong><q>Hot swapping</q> components</strong></p>
<p>One of the features of Observer pattern is the ability for observers to attach and detach themselves at runtime. There are many uses for this, but let’s say you wanted to temporarily re-route a minimal production logging system with a more verbose logging system to track down an issue. Rather than taking down the whole system, you could simply swap out the ProductionLogger observer and swap in a VerboseLogger simply calling <em>unregister</em> and <em>register</em> respectively. Then, upon fixing the issue, you could do the reverse, and thus, swap the components back as they were.</p>
<p>So let’s get to work on that <em>unregister</em> method…</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">public</span> <span class="kw">function</span> testUnsubscribing<span class="ot">()</span>
{
    <span class="kw">$observer1</span> = <span class="kw">new</span> ConcreteObserver<span class="ot">();</span>
    <span class="kw">$observer2</span> = <span class="kw">new</span> ConcreteObserver<span class="ot">();</span>
    <span class="kw">$subject</span> = <span class="kw">new</span> ConcreteSubject<span class="ot">();</span>
    <span class="kw">$subject</span>-&gt;register<span class="ot">(</span><span class="kw">$observer1</span><span class="ot">);</span>
    <span class="kw">$subject</span>-&gt;register<span class="ot">(</span><span class="kw">$observer2</span><span class="ot">);</span>
    <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">2</span><span class="ot">,</span> <span class="kw">$subject</span>-&gt;getNumberOfObservers<span class="ot">(),</span> 
        <span class="st">&quot;Should be 2 observers when 2 added.&quot;</span><span class="ot">);</span>
    <span class="kw">$subject</span>-&gt;unregister<span class="ot">(</span><span class="kw">$observer1</span><span class="ot">);</span>
    <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">1</span><span class="ot">,</span> <span class="kw">$subject</span>-&gt;getNumberOfObservers<span class="ot">(),</span>
        <span class="st">&quot;Should be 1 observer when 1 when one removed.&quot;</span><span class="ot">);</span>
}
<span class="kw">?&gt;</span></code></pre>
<p>Of course we get:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">**Fatal error: Call to undefined method <span class="fu">ConcreteSubject::unregister()</span></code></pre>
<p><em>At this point I’m not going to be listing every step (like when we define a class or method when we have an undefined test error just to get the test to pass) but, if you’re following along, remember to take small steps between coding and running your tests.</em></p>
<p>We need to define an <em>unregister</em> method which we do as follows:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">public</span> <span class="kw">function</span> unregister<span class="ot">(</span><span class="kw">$observer</span><span class="ot">)</span>
{
    <span class="kw">foreach</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;observers <span class="kw">as</span> <span class="kw">$k</span> =&gt; <span class="kw">$v</span><span class="ot">)</span>
    {
        <span class="kw">if</span> <span class="ot">(</span><span class="kw">$observer</span> == <span class="kw">$v</span><span class="ot">)</span>
        {
            <span class="fu">unset</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">[</span><span class="kw">$k</span><span class="ot">]);</span>
            <span class="kw">return</span> <span class="kw">true</span><span class="ot">;</span>
        }
    }
    <span class="kw">return</span> <span class="kw">false</span><span class="ot">;</span>
}
<span class="kw">?&gt;</span></code></pre>
<p>And we’re all green again. Our implementation so far is:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">abstract</span> <span class="kw">class</span> Subject
{
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span><span class="kw">$observer</span><span class="ot">);</span>
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> unregister<span class="ot">(</span><span class="kw">$observer</span><span class="ot">);</span>
}

<span class="kw">class</span> ConcreteSubject <span class="kw">extends</span> Subject
{
    <span class="kw">private</span> <span class="kw">$observers</span> = <span class="fu">array</span><span class="ot">();</span>

    <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span><span class="kw">$observer</span><span class="ot">)</span>
    {
        <span class="fu">array_push</span><span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">,</span> <span class="kw">$observer</span><span class="ot">);</span>
    }

    <span class="kw">public</span> <span class="kw">function</span> unregister<span class="ot">(</span><span class="kw">$observer</span><span class="ot">)</span>
    {
        <span class="kw">foreach</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;observers <span class="kw">as</span> <span class="kw">$k</span> =&gt; <span class="kw">$v</span><span class="ot">)</span>
        {
            <span class="kw">if</span> <span class="ot">(</span><span class="kw">$observer</span> == <span class="kw">$v</span><span class="ot">)</span>
            {
                <span class="fu">unset</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">[</span><span class="kw">$k</span><span class="ot">]);</span>
                <span class="kw">return</span> <span class="kw">true</span><span class="ot">;</span>
            }
        }
        <span class="kw">return</span> <span class="kw">false</span><span class="ot">;</span>
    }
    
    <span class="kw">public</span> <span class="kw">function</span> getNumberOfObservers<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="fu">count</span><span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">);</span>
    }
}

<span class="kw">interface</span> iObserver
{
}
<span class="kw">class</span> ConcreteObserver <span class="kw">implements</span> iObserver
{
} 
<span class="kw">?&gt;</span></code></pre>
<p><strong>Refactoring Pull Up</strong></p>
<p>At this point, it’s debatable whether Subject should be abstract or an interface since we aren’t supplying any default behavior. Having a quick look, it seems we can <a href="http://en.wikipedia.org/wiki/Pull_Up_refactoring"><q>pull up</q></a> the getNumberOfObservers method. We pull it up into our abstract Subject class as follows:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">abstract</span> <span class="kw">class</span> Subject
{
    <span class="kw">protected</span> <span class="kw">$observers</span> = <span class="fu">array</span><span class="ot">();</span>
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span><span class="kw">$observer</span><span class="ot">);</span>
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> unregister<span class="ot">(</span><span class="kw">$observer</span><span class="ot">);</span>
    <span class="kw">public</span> <span class="kw">function</span> getNumberOfObservers<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="fu">count</span><span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">);</span>
    }
}
<span class="kw">?&gt;</span></code></pre>
<p><em>Note that getNumberOfObservers is a method that I took the liberty of creating to make the Subject more testable. It’s not actually part of the Observer pattern.</em></p>
<p><strong>DRY (don’t repeat yourself)</strong></p>
<p>Ok, that looks better but I don’t like our <code>testUnsubscribing</code> spec. It’s too long for such a simple test and also, if you look caefully at <code>testSubscribing</code>, you’ll see that we have duplicate code breaking the <a href="http://www.artima.com/intv/dry.html">DRY Principle</a>. Essentially, the DRY principle states that we want to avoid duplication since that requires us to maintain duplicate code bases in parallel.</p>
<p><strong>Setup and Teardown</strong></p>
<p>We can pull that duplicate code up in to a setUp method (setUp is used to set up state before each test case run; as expected, tearDown executes just after each test case run). Doing so will mean we have to go through and change our references from the local to class level like so:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">require_once</span><span class="ot">(</span><span class="st">&#39;Observer.php&#39;</span><span class="ot">);</span>

<span class="kw">class</span> ObserverTests <span class="kw">extends</span> PHPUnit_Framework_TestCase
{
    <span class="kw">private</span> <span class="kw">$observer</span> = <span class="kw">null</span><span class="ot">;</span>
    <span class="kw">private</span> <span class="kw">$observer2</span> = <span class="kw">null</span><span class="ot">;</span>
    <span class="kw">private</span> <span class="kw">$subject</span> = <span class="kw">null</span><span class="ot">;</span>

    <span class="kw">public</span> <span class="kw">function</span> setUp<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;observer = <span class="kw">new</span> ConcreteObserver<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;observer2 = <span class="kw">new</span> ConcreteObserver<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;subject = <span class="kw">new</span> ConcreteSubject<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> tearDown<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;observer = <span class="kw">null</span><span class="ot">;</span>
        <span class="kw">$this</span>-&gt;observer2 = <span class="kw">null</span><span class="ot">;</span>
        <span class="kw">$this</span>-&gt;subject = <span class="kw">null</span><span class="ot">;</span>
    }
    
    <span class="kw">public</span> <span class="kw">function</span> testSubscribing<span class="ot">()</span>
    {
        <span class="kw">$observers</span> = <span class="kw">$this</span>-&gt;registerMany<span class="ot">(</span><span class="dv">1</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">1</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Subscriber should have 1 observer when 1 observer registered.&quot;</span><span class="ot">);</span>
    }
    
    <span class="kw">public</span> <span class="kw">function</span> testUnsubscribing<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$this</span>-&gt;observer<span class="ot">);</span>
        <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$this</span>-&gt;observer2<span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">2</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Should be 2 observers when 2 added.&quot;</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;subject-&gt;unregister<span class="ot">(</span><span class="kw">$this</span>-&gt;observer<span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">1</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Should be 1 observer when 1 when one removed.&quot;</span><span class="ot">);</span>
    }
}
<span class="kw">?&gt;</span></code></pre>
<p>You should now notice that—since our last refactoring—the test case has become much more readable and easy to understand. Thus we didn’t just reduce duplication (but more importantly) made our tests <a href="http://en.wikipedia.org/wiki/Self-documenting">self documenting</a>.</p>
<p>For this exercise, we’re using phpunit’s setUp/tearDown combination (similar to JUnit if you’re a Java developer), but you’ll see other similar hooks in other frameworks like beforeEach/afterEach (<a href="http://pivotal.github.com/jasmine/">Jasmine</a>), begin/done (<a href="http://qunitjs.com/">QUnit</a>), etc. These methods are called just before and after each test case allowng you to set up (and tear down) state. This ensures that each test is ran in isolation not depending on any leftover state from previous test case runs.</p>
<p><strong>Helpers</strong></p>
<p>I’d like to do one more refactoring before moving on—I’m not happy with the way we’re registering our observers within each test case. Let us try moving that code in to a helper function:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> testUnsubscribing<span class="ot">()</span>
    {
        <span class="kw">$observers</span> = <span class="kw">$this</span>-&gt;registerMany<span class="ot">(</span><span class="dv">5</span><span class="ot">);</span>
<span class="st">...</span>
    <span class="kw">private</span> <span class="kw">function</span> registerMany<span class="ot">(</span><span class="kw">$n</span><span class="ot">)</span>
    {
        <span class="kw">$observers</span> = <span class="fu">array</span><span class="ot">();</span>
        <span class="kw">foreach</span> <span class="ot">(</span><span class="fu">range</span><span class="ot">(</span><span class="dv">0</span><span class="ot">,</span> <span class="kw">$n</span><span class="dv">-1</span><span class="ot">)</span> <span class="kw">as</span> <span class="kw">$key</span><span class="ot">)</span> {
            <span class="kw">$observers</span><span class="ot">[</span><span class="kw">$key</span><span class="ot">]</span> = <span class="kw">new</span> ConcreteObserver<span class="ot">();</span>
            <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$observers</span><span class="ot">[</span><span class="kw">$key</span><span class="ot">]);</span>
        }
        <span class="kw">return</span> <span class="kw">$observers</span><span class="ot">;</span>
    }
}
<span class="kw">?&gt;</span></code></pre>
<p><em>The above helper method is a direct lift from the <strong>rollMany</strong> helper function in the famous bowling game kata. If you haven’t heard of it you should take a quick look at <a href="http://butunclebob.com/ArticleS.UncleBob.TheBowlingGameKata">Uncle Bob’s Bowling Game Kata</a>. Read the short article and perhaps schedule time in your calendar to go through the power point presentation step by step. Better yet, play with the kata using your favorite language(s) in your <q>spare time</q>…it’s quite instructive. Here’s an example of using <a href="http://www.phpunit.de/manual/current/en/behaviour-driven-development.html#behaviour-driven-development.bowlinggame-example">phpunit with BDD to solve Bowling Game</a>.</em></p>
<h3 id="a-slight-detour-what-should-i-test"><a href="#TOC">A Slight Detour: What should I test?</a></h3>
<p>Determining just what to test is a difficult task but here are some general guidelines to help with that process.</p>
<h4 id="structured-basis-testing"><a href="#TOC">Structured Basis Testing</a></h4>
<p>The main idea of <a href="http://www.testingstandards.co.uk/living_glossary.htm#S">Structured Basis Testing</a> is that your test cases, for a particular peice of code, are derived from the code’s logic and you try to have tests in place for every possible branch. So at it’s simplest:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">function</span> foo<span class="ot">()</span> {  <span class="co">// count 1 for the function itself</span>
    <span class="kw">if</span> <span class="ot">(</span>something<span class="ot">)</span> { <span class="co">// count 2 for this condition</span>
        <span class="co">// ...</span>
    } <span class="kw">else</span> <span class="kw">if</span> <span class="ot">(</span>somethingElse<span class="ot">)</span> { <span class="co">// count 3 for this condition</span>
        <span class="co">// ...</span>
    } 
    <span class="co">// We count one for function itself because this might be</span>
    <span class="co">// all that&#39;s executed if neither above are truthy!</span>
    <span class="kw">return</span> <span class="kw">true</span><span class="ot">;</span>
}
<span class="kw">?&gt;</span></code></pre>
<p>This is also sometimes referred to as <em>logic coverage testing</em>. The programmer’s tome <a href="http://www.cc2e.com/Default.aspx">Code Complete 2</a> discusses this in depth in it’s <em>Chapter 22: Developer Testing</em>.</p>
<h4 id="boundary-conditions-testing"><a href="#TOC">Boundary Conditions Testing</a></h4>
<p><a href="http://www.informit.com/store/practice-of-programming-9780201615869">The Practice of Programming</a> tells us that we should:</p>
<blockquote>
<p>Test code at its boundaries…The idea is that most bugs occur at boundaries.</p>
</blockquote>
<p>When you test production code that can take a range of valid values, use just below minimum, minimum, maximum, and just below and exceeding maximum values. This takes discipline and time (but given that boundaries are likely places where errors creep up) it’s well worth the effort.</p>
<p><em>Also keep in mind that there might be compound boundaries when 2 or more variables interact. An obvious example is when you multiply two numbers. In this case, you have the potential to inadvertantly exceed the maximum value.</em></p>
<h4 id="known-error-testing"><a href="#TOC">Known Error Testing</a></h4>
<p>Is there an area that is likely to be problemattic? If so, make sure to test for that area.</p>
<p>An example might be if you were to implement a <q>time picker</q>. Setting aside time zone and daylight savings concerns, we’d want heavy coverage on times known to be error prone such as: 00:00, 12:00am, 12:00pm (keep in mind the user’s time format might be 12 or 24 hour format!) In addition, you may also want to use: 23:59, 11:59pm, 11:59am, 00:01, 12:01am, 12:01pm, etc.</p>
<h4 id="data-flow-testing"><a href="#TOC">Data-Flow Testing</a></h4>
<p>This is also discussed in the <a href="http://www.cc2e.com/Default.aspx">Code Complete 2</a> book, and you should turn to that resource for more in depth coverage. However, essentially, data-flow testing provides that <em>data usage</em> is just as problemattic as control flow, and that you therefore need to take into account of the various possible states your data structures might be in (e.g. Defined, Used, Killed, Entered, Exited, etc.) Data flow testing is beyond the scope of this book but you can read more in <a href="http://www.cs.swan.ac.uk/~csmarkus/CS339/dissertations/NewM.pdf">this paper</a> if you’re interested.</p>
<h4 id="cross-checking"><a href="#TOC">Cross Checking</a></h4>
<p>If you have to implement something that’s been reliably implemented elsewhere, you may be able to <em>cross check</em> your results against the existing implementation:</p>
<pre class="sourceCode java"><code class="sourceCode java">actual = MyMath.<span class="fu">squareRoot</span>(n);
expected = Math.<span class="fu">sqrt</span>(n); 
<span class="fu">assertEquals</span>(actual, expected,
<span class="st">&quot;My implementation of square root should be same as Java&#39;s&quot;</span>);</code></pre>
<p><em>In this chapter, we are focusing on using TDD to unit test our Observer implementation thus leaving out many other important types of testing: <a href="http://en.wikipedia.org/wiki/Integration_testing">Integration Testing</a>, <a href="http://en.wikipedia.org/wiki/System_testing">Systems Testing</a>, <a href="http://en.wikipedia.org/wiki/Stress_testing">Stress Testing</a>, etc. In a real system, you will ideally have a suite of complimentary tests that include all of the aformentioned within an <a href="http://en.wikipedia.org/wiki/Continuous_integration">Continuous Integration System</a>. You should also consider using a tool to measure your <a href="http://martinfowler.com/bliki/TestCoverage.html">test code coverage</a>.</em></p>
<h3 id="testing-both-the-happy-and-sad-paths"><a href="#TOC">Testing both the <q>happy</q> and <q>sad</q> paths</a></h3>
<p>Gary Bernhardt, of <a href="https://www.destroyallsoftware.com">Destroy All Software</a>, uses <q>happy</q> and <q>sad</q> to describe the normal and abnormal code paths. At minimum, both of these paths—sometimes also called the nominal and non-nominal paths (but I like Gary’s happy/sad better!)—should get proper test coverage. Perhaps so far we’ve been a bit too joyful!</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> testSubscribingWithFalsy<span class="ot">()</span>
    {
        <span class="kw">$observers</span> = <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">null</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">0</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Should be 0 observers if register called with a falsy.&quot;</span><span class="ot">);</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>Which results in:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">Failed asserting that 1 matches expected 0.</code></pre>
<p>So we change our system under test to be:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span><span class="kw">$observer</span><span class="ot">)</span>
    {
        <span class="kw">if</span> <span class="ot">(</span>!<span class="fu">empty</span><span class="ot">(</span>\<span class="kw">$observer</span><span class="ot">))</span>
        {
            <span class="kw">$this</span>-&gt;observers<span class="ot">[]</span> = <span class="kw">$observer</span><span class="ot">;</span>
        }
    }
<span class="kw">?&gt;</span></code></pre>
<p>And we’re back to passing. However, not only could we pass in falsy arguments, but we might also pass in a non-observer as well. So we need to defend against that as well:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> testSubscribingWithNonObserver<span class="ot">()</span>
    {
        <span class="kw">$nonObserver</span> = <span class="st">&quot;I&#39;m not a legal observer!&quot;</span><span class="ot">;</span>
        <span class="kw">$observers</span> = <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$nonObserver</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">0</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span> 
            <span class="st">&quot;Should be 0 observers if register called with a falsy.&quot;</span><span class="ot">);</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>Obviously, we need some type hinting help here and so we try to change our abstract Subject’s interface to be like:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">);</span>
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> unregister<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">);</span>
<span class="kw">?&gt;</span></code></pre>
<p>But doing this results in the following goliath error output:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">1) ObserverTests::testSubscribingWithFalsy
Argument 1 passed to <span class="fu">ConcreteSubject::register()</span>
must implement interface iObserver, null given...

2) ObserverTests::testSubscribingWithNonObserver
Argument 1 passed to <span class="fu">ConcreteSubject::register()</span>
must implement interface iObserver, string given...
...</code></pre>
<p>But if we look carefully at these errors, we see that the type hinting is actually doing it’s job thus disallowing us to pass both NULL and String to register! Let’s remove the following two test cases:</p>
<pre class="sourceCode php"><code class="sourceCode php">    // public function testSubscribingWithFalsy()
    // {
    //     $observers = $this-&gt;subject-&gt;register(null);
    //     $this-&gt;assertEquals(0, $this-&gt;subject-&gt;getNumberOfObservers(),
    //         &quot;Should be 0 observers when register called with a falsy.&quot;);
    // }
    // public function testSubscribingWithNonObserver()
    // {
    //     $nonObserver = &quot;I&#39;m not a legal observer&quot;;
    //     $observers = $this-&gt;subject-&gt;register($nonObserver);
    //     $this-&gt;assertEquals(0, $this-&gt;subject-&gt;getNumberOfObservers(),
    //         &quot;Should be 0 observers when register called with a falsy.&quot;);
    // }</code></pre>
<p>After said removal, we’re back to passing again, and we’ve made our production code easier to read:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;observers<span class="ot">[]</span> = <span class="kw">$observer</span><span class="ot">;</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>Obviously, in a real system we’d need to think of other <q>sad paths</q>, but it’s interesting to note that the mere process of testing has helped us to remove needless code. For example, we don’t have to add code like:</p>
<pre class="sourceCode php"><code class="sourceCode php">    if (is_object($newSubject) &amp;&amp;
        $newSubject instanceof Subject) {
    ...</code></pre>
<p>Let’s continue to look for other possible <q>sad paths</q>:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> testUnsubscribingWhenNone<span class="ot">()</span>
    {
        <span class="kw">$actual</span> = <span class="kw">$this</span>-&gt;subject-&gt;unregister<span class="ot">(</span><span class="kw">new</span> ConcreteObserver<span class="ot">());</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="kw">false</span><span class="ot">,</span> <span class="kw">$actual</span><span class="ot">,</span> 
            <span class="st">&quot;Unregister returned status should be false if no observers&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testGetNumberObserversWhenNone<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">0</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Should be 0 observers when none.&quot;</span><span class="ot">);</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>We try the above and they both pass without any changes. Since the getNumberOfObservers is really just a helper to facilitate testing (and is quite simple), let’s remove that test. We only want <q>useful</q> tests.</p>
<p>Before we can implement our observers we need to add a capability to the subject. In order to be useful, we need to be able to set and get some sort of meaningful data from the Subject. Let’s do that now:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> testSubjectShouldHoldState<span class="ot">()</span>
    {
        <span class="kw">$stateAsString</span> = <span class="st">&quot;some state&quot;</span><span class="ot">;</span>
        <span class="kw">$this</span>-&gt;subject-&gt;setState<span class="ot">(</span><span class="kw">$stateAsString</span><span class="ot">);</span>
        <span class="kw">$actual</span> = <span class="kw">$this</span>-&gt;subject-&gt;getState<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="kw">$stateAsString</span><span class="ot">,</span> <span class="kw">$actual</span><span class="ot">,</span>
            <span class="st">&quot;Should get/set state as string&quot;</span><span class="ot">);</span>

        <span class="kw">$stateAsArray</span> = <span class="fu">array</span><span class="ot">(</span><span class="st">&#39;foo&#39;</span> =&gt; <span class="st">&#39;foo val&#39;</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;subject-&gt;setState<span class="ot">(</span><span class="kw">$stateAsArray</span><span class="ot">);</span>
        <span class="kw">$actual</span> = <span class="kw">$this</span>-&gt;subject-&gt;getState<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertSame<span class="ot">(</span><span class="kw">$stateAsArray</span><span class="ot">,</span> <span class="kw">$actual</span><span class="ot">,</span>
            <span class="st">&quot;Should get/set state as array&quot;</span><span class="ot">);</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>And the obvious implementation:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> setState<span class="ot">(</span><span class="kw">$state</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;state = <span class="kw">$state</span><span class="ot">;</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> getState<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;state<span class="ot">;</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>I’m not pleased with the length of the test case and don’t think it’s too useful to test both for types String and Array. It was the first time through but not for repeatable test suite runs. So I’ll remove the String part leaving just:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> testSubjectShouldHoldState<span class="ot">()</span>
    {
        <span class="kw">$stateAsArray</span> = <span class="fu">array</span><span class="ot">(</span><span class="st">&#39;foo&#39;</span> =&gt; <span class="st">&#39;foo val&#39;</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;subject-&gt;setState<span class="ot">(</span><span class="kw">$stateAsArray</span><span class="ot">);</span>
        <span class="kw">$actual</span> = <span class="kw">$this</span>-&gt;subject-&gt;getState<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertSame<span class="ot">(</span><span class="kw">$stateAsArray</span><span class="ot">,</span> <span class="kw">$actual</span><span class="ot">,</span>
            <span class="st">&quot;Should get/set state as array&quot;</span><span class="ot">);</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>Again, we want readable and meaningful tests so we sometimes have to make these sorts of judgement calls, and I’m going to favor brevity in this case.</p>
<p>Now that we have a way to hold state, we can start implementing our observer interface:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> testObserverGetsNotified<span class="ot">()</span>
    {
        <span class="kw">$subject</span> = <span class="kw">new</span> ConcreteSubject<span class="ot">();</span>
        <span class="kw">$observer</span> = <span class="kw">new</span> ConcreteObserver<span class="ot">(</span><span class="kw">$subject</span><span class="ot">);</span>
        <span class="kw">$state</span> = <span class="st">&#39;yogabbagabba&#39;</span><span class="ot">;</span>
        <span class="kw">$subject</span>-&gt;setState<span class="ot">(</span><span class="kw">$state</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="kw">$state</span><span class="ot">,</span> <span class="kw">$observer</span>-&gt;getState<span class="ot">(),</span>
            <span class="st">&quot;Setting state in subject notifies observer&quot;</span><span class="ot">);</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>And then:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">interface</span> iObserver
{
    <span class="kw">public</span> <span class="kw">function</span> update <span class="ot">(</span>iSubject <span class="kw">$subject</span><span class="ot">);</span>
}
<span class="kw">class</span> ConcreteObserver <span class="kw">implements</span> iObserver
{
    <span class="kw">private</span> <span class="kw">$state</span><span class="ot">;</span>
    <span class="kw">public</span> <span class="kw">function</span> update <span class="ot">(</span>iSubject <span class="kw">$subject</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;state = <span class="kw">$subject</span>-&gt;getState<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> getState<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;state<span class="ot">;</span>
    }
} 
<span class="kw">?&gt;</span></code></pre>
<p>Resulting in:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">1) ObserverTests::testObserverGetsNotified
Setting state <span class="kw">in</span> subject notifies observer
Failed asserting that null matches expected <span class="st">&#39;yogabbagabba&#39;</span>.</code></pre>
<p>Our observer looks ok, but it’s likely not getting notified (duh, we didn’t implement that yet!)…</p>
<h3 id="implementing-observers"><a href="#TOC">Implementing Observers</a></h3>
<p>So we’re at a sort of critical point here. We’ve implemented quite a bit of code, and we still have more (the notify observers routine for example). Moreover, we can feel our blood pressure rise and our confidence level dropping. What to do? Simply back up a step. Get those tests green again!</p>
<pre class="sourceCode php"><code class="sourceCode php">    // public function testObserverGetsNotified()
    // {
    //     $subject = new ConcreteSubject();
    //     $observer = new ConcreteObserver($subject);
    //     $state = &#39;yogabbagabba&#39;;
    //     $subject-&gt;setState($state);
    //     $this-&gt;assertEquals($state, $observer-&gt;getState(),
    //         &quot;Setting state in subject notifies observer&quot;);
    // }</code></pre>
<p>We’ve simply commented out our last test case, re-ran our tests and we’re green:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">OK, but incomplete or skipped tests!
Tests: 6, Assertions: 6, Incomplete: 1.</code></pre>
<p>We can take a deep breath feeling reassured that we haven’t created a 30 minute debugging session for ourselves. Also note that we’ve left the <q>partially implemented</q> changes in our production code. So we’ve actually made some progress given that, so far, we haven’t caused a regression. We’ll take a bit of a risk, and leave those change in while we implement notifications:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> testObserverGetsNotified<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$this</span>-&gt;observer<span class="ot">);</span>
        <span class="kw">$state</span> = <span class="st">&#39;yogabbagabba&#39;</span><span class="ot">;</span>
        <span class="kw">$this</span>-&gt;subject-&gt;setState<span class="ot">(</span><span class="kw">$state</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;subject-&gt;notify<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="kw">$state</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;observer-&gt;getState<span class="ot">(),</span>
            <span class="st">&quot;Setting state in subject notifies observer&quot;</span><span class="ot">);</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>This was derived from the test case we commented out earlier. If it’s not obvious, we’ve defined $this-&gt;observer in setUp. Here’s our full implementation so far:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">abstract</span> <span class="kw">class</span> Subject
{
    <span class="kw">protected</span> <span class="kw">$observers</span><span class="ot">;</span>
    <span class="kw">protected</span> <span class="kw">$state</span><span class="ot">;</span>

    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">);</span>
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> unregister<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">);</span>
    
    <span class="kw">public</span> <span class="kw">function</span> getNumberOfObservers<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="fu">count</span><span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">);</span>
    }
}

<span class="kw">class</span> ConcreteSubject <span class="kw">extends</span> Subject
{
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__construct</span><span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;observers = <span class="fu">array</span><span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;observers<span class="ot">[]</span> = <span class="kw">$observer</span><span class="ot">;</span>
    }

    <span class="kw">public</span> <span class="kw">function</span> unregister<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">)</span>
    {
        <span class="kw">foreach</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;observers <span class="kw">as</span> <span class="kw">$k</span> =&gt; <span class="kw">$v</span><span class="ot">)</span>
        {
            <span class="kw">if</span> <span class="ot">(</span><span class="kw">$observer</span> == <span class="kw">$v</span><span class="ot">)</span>
            {
                <span class="fu">unset</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">[</span><span class="kw">$k</span><span class="ot">]);</span>
                <span class="kw">return</span> <span class="kw">true</span><span class="ot">;</span>
            }
        }
        <span class="kw">return</span> <span class="kw">false</span><span class="ot">;</span>
    }

    <span class="kw">public</span> <span class="kw">function</span> notify<span class="ot">()</span>
    {
        <span class="kw">foreach</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;observers <span class="kw">as</span> <span class="kw">$observer</span><span class="ot">)</span> {
            <span class="kw">$observer</span>-&gt;update<span class="ot">(</span><span class="kw">$this</span><span class="ot">);</span>
        }
    }
    <span class="kw">public</span> <span class="kw">function</span> setState<span class="ot">(</span><span class="kw">$state</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;state = <span class="kw">$state</span><span class="ot">;</span>
    }

    <span class="kw">public</span> <span class="kw">function</span> getState<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;state<span class="ot">;</span>
    }
}

<span class="kw">interface</span> iObserver
{
    <span class="kw">public</span> <span class="kw">function</span> update <span class="ot">(</span>Subject <span class="kw">$subject</span><span class="ot">);</span>
}
<span class="kw">class</span> ConcreteObserver <span class="kw">implements</span> iObserver
{
    <span class="kw">private</span> <span class="kw">$state</span> = <span class="kw">null</span><span class="ot">;</span>
    <span class="kw">public</span> <span class="kw">function</span> update <span class="ot">(</span>Subject <span class="kw">$subject</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;state = <span class="kw">$subject</span>-&gt;getState<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> getState<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;state<span class="ot">;</span>
    }
}
<span class="kw">?&gt;</span> </code></pre>
<p>Notice that by using a sprinkle of <a href="http://php.net/manual/en/language.oop5.typehinting.php">type hinting</a>, we don’t have to resort to using things <a href="http://php.net/manual/en/function.method-exists.php">method_exists</a> checks to determine if the subject passed into <em>update</em> actually has a <em>getState</em> method…it can be safely assumed since <em>Subject</em> defines that as an abstract (thus required) method.</p>
<p><strong>Unique observers</strong> We’d like to prevent an exact observer instance getting included in our subject’s observer <em>List</em> twice. There are several approaches we could take to solve this, but let’s go with adding an id property to each observer instance and then utilizing <code>array_unique</code>.</p>
<p>First the ID part:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="co">// we add this test</span>
    <span class="kw">public</span> <span class="kw">function</span> testObserversHaveIds<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;assertNotNull<span class="ot">(</span><span class="kw">$this</span>-&gt;observer-&gt;getID<span class="ot">());</span>
    }

<span class="co">// and we add this to observer:</span>
    <span class="kw">private</span> <span class="kw">$state</span> = <span class="kw">null</span><span class="ot">;</span>
    <span class="kw">private</span> <span class="kw">$id</span><span class="ot">;</span>
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__construct</span><span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;state = <span class="kw">null</span><span class="ot">;</span>
        <span class="kw">$this</span>-&gt;id = <span class="fu">uniqid</span> <span class="ot">(</span><span class="fu">rand</span><span class="ot">(),</span> <span class="kw">true</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> getID<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;id<span class="ot">;</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>Now that our observers have IDs, we can have our subject enforce uniqueness in <em>register</em>. First let’s see this fail:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> testAddingDuplicates<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$this</span>-&gt;observer<span class="ot">);</span>
        <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$this</span>-&gt;observer<span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">1</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Should only add a particular observer instance once&quot;</span><span class="ot">);</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>This results in:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">1) ObserverTests::testAddingDuplicates
Should only add observer once
Failed asserting that 2 matches expected 1.</code></pre>
<p>In order to use <code>array_unique</code>we need to first implement a <code>__toString</code> in our observer.</p>
<p>We first comment out <code>testAddingDuplicates</code>, verify our tests are again passing, add the <code><strong>toString</code> method, and once more verify our tests are still passing. After safely adding <code></strong>toString</code>, we uncomment testAddingDuplicates and continue onwards on our mission to disallow duplicates. All we have to at this point is to call <code>array_unique</code> when we register our observers like so:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;observers<span class="ot">[]</span> = <span class="kw">$observer</span><span class="ot">;</span>
        <span class="kw">$this</span>-&gt;observers = <span class="fu">array_unique</span><span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">);</span>  
    }
<span class="kw">?&gt;</span></code></pre>
<p>Our test is now passing and we’ve ensured all our observers are, in fact, unique instances.</p>
<h2 id="final-implementation"><a href="#TOC">Final Implementation</a></h2>
<p>At this point, we have a fairly complete Observer implementation that could be further extended easily should we so desire.</p>
<h4 id="observertests.php"><a href="#TOC">ObserverTests.php</a></h4>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">require_once</span><span class="ot">(</span><span class="st">&#39;Observer.php&#39;</span><span class="ot">);</span>

<span class="kw">class</span> ObserverTests <span class="kw">extends</span> PHPUnit_Framework_TestCase
{
    <span class="kw">private</span> <span class="kw">$subject</span> = <span class="kw">null</span><span class="ot">;</span>
    <span class="kw">private</span> <span class="kw">$observer</span> = <span class="kw">null</span><span class="ot">;</span>

    <span class="kw">public</span> <span class="kw">function</span> setUp<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;subject = <span class="kw">new</span> ConcreteSubject<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;observer = <span class="kw">new</span> ConcreteObserver<span class="ot">(</span><span class="kw">$this</span>-&gt;subject<span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> tearDown<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;subject = <span class="kw">null</span><span class="ot">;</span>
        <span class="kw">$this</span>-&gt;observer = <span class="kw">null</span><span class="ot">;</span>
    }

    <span class="kw">public</span> <span class="kw">function</span> testSubscribing<span class="ot">()</span>
    {
        <span class="kw">$observers</span> = <span class="kw">$this</span>-&gt;registerMany<span class="ot">(</span><span class="dv">1</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">1</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Subscriber should have 1 observer when 1 observer registered.&quot;</span><span class="ot">);</span>
    }

    <span class="kw">public</span> <span class="kw">function</span> testUnsubscribing<span class="ot">()</span>
    {
        <span class="kw">$observers</span> = <span class="kw">$this</span>-&gt;registerMany<span class="ot">(</span><span class="dv">5</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">5</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Should be 5 observers when 5 added.&quot;</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;subject-&gt;unregister<span class="ot">(</span><span class="kw">$observers</span><span class="ot">[</span><span class="dv">0</span><span class="ot">]);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">4</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Should be 4 observers when 1 when one removed.&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testUnsubscribingWhenNone<span class="ot">()</span>
    {
        <span class="kw">$actual</span> = <span class="kw">$this</span>-&gt;subject-&gt;unregister<span class="ot">(</span><span class="kw">new</span> ConcreteObserver<span class="ot">());</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="kw">false</span><span class="ot">,</span> <span class="kw">$actual</span><span class="ot">,</span>
            <span class="st">&quot;Unregister returned status should be false if no observers&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testSubjectShouldHoldState<span class="ot">()</span>
    {
        <span class="kw">$stateAsArray</span> = <span class="fu">array</span><span class="ot">(</span><span class="st">&#39;foo&#39;</span> =&gt; <span class="st">&#39;foo val&#39;</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;subject-&gt;setState<span class="ot">(</span><span class="kw">$stateAsArray</span><span class="ot">);</span>
        <span class="kw">$actual</span> = <span class="kw">$this</span>-&gt;subject-&gt;getState<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertSame<span class="ot">(</span><span class="kw">$stateAsArray</span><span class="ot">,</span> <span class="kw">$actual</span><span class="ot">,</span>
            <span class="st">&quot;Should get/set state as array&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testCreateObserver<span class="ot">()</span>
    {
        <span class="kw">$actual</span> = <span class="kw">new</span> ConcreteObserver<span class="ot">(</span><span class="kw">new</span> ConcreteSubject<span class="ot">());</span>
        <span class="kw">$this</span>-&gt;assertNotNull<span class="ot">(</span><span class="kw">$actual</span><span class="ot">,</span> <span class="st">&quot;Should create observer&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testObserverGetsNotified<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$this</span>-&gt;observer<span class="ot">);</span>
        <span class="kw">$state</span> = <span class="st">&#39;yogabbagabba&#39;</span><span class="ot">;</span>
        <span class="kw">$this</span>-&gt;subject-&gt;setState<span class="ot">(</span><span class="kw">$state</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;subject-&gt;notify<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="kw">$state</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;observer-&gt;getState<span class="ot">(),</span>
            <span class="st">&quot;Setting state in subject notifies observer&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testObserversHaveIds<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;assertNotNull<span class="ot">(</span><span class="kw">$this</span>-&gt;observer-&gt;getID<span class="ot">());</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testAddingDuplicates<span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$this</span>-&gt;observer<span class="ot">);</span>
        <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$this</span>-&gt;observer<span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span><span class="dv">1</span><span class="ot">,</span> <span class="kw">$this</span>-&gt;subject-&gt;getNumberOfObservers<span class="ot">(),</span>
            <span class="st">&quot;Should only add a particular observer instance once&quot;</span><span class="ot">);</span>
    }
    <span class="kw">private</span> <span class="kw">function</span> registerMany<span class="ot">(</span><span class="kw">$n</span><span class="ot">)</span>
    {
        <span class="kw">$observers</span> = <span class="fu">array</span><span class="ot">();</span>
        <span class="kw">foreach</span> <span class="ot">(</span><span class="fu">range</span><span class="ot">(</span><span class="dv">0</span><span class="ot">,</span> <span class="kw">$n</span><span class="dv">-1</span><span class="ot">)</span> <span class="kw">as</span> <span class="kw">$key</span><span class="ot">)</span> {
            <span class="kw">$observers</span><span class="ot">[</span><span class="kw">$key</span><span class="ot">]</span> = <span class="kw">new</span> ConcreteObserver<span class="ot">();</span>
            <span class="kw">$this</span>-&gt;subject-&gt;register<span class="ot">(</span><span class="kw">$observers</span><span class="ot">[</span><span class="kw">$key</span><span class="ot">]);</span>
        }
        <span class="kw">return</span> <span class="kw">$observers</span><span class="ot">;</span>
    }
}
<span class="kw">?&gt;</span></code></pre>
<h4 id="observer.php"><a href="#TOC">Observer.php</a></h4>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">abstract</span> <span class="kw">class</span> Subject
{
    <span class="kw">protected</span> <span class="kw">$observers</span><span class="ot">;</span>
    <span class="kw">protected</span> <span class="kw">$state</span><span class="ot">;</span>

    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">);</span>
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> unregister<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">);</span>
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> notify<span class="ot">();</span>
 
    <span class="kw">public</span> <span class="kw">function</span> getNumberOfObservers<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="fu">count</span><span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">);</span>
    }
}

<span class="kw">class</span> ConcreteSubject <span class="kw">extends</span> Subject
{
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__construct</span><span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;observers = <span class="fu">array</span><span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> register<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;observers<span class="ot">[]</span> = <span class="kw">$observer</span><span class="ot">;</span>
        <span class="kw">$this</span>-&gt;observers = <span class="fu">array_unique</span><span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">);</span>  
    }

    <span class="kw">public</span> <span class="kw">function</span> unregister<span class="ot">(</span>iObserver <span class="kw">$observer</span><span class="ot">)</span>
    {
        <span class="kw">foreach</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;observers <span class="kw">as</span> <span class="kw">$k</span> =&gt; <span class="kw">$v</span><span class="ot">)</span>
        {
            <span class="kw">if</span> <span class="ot">(</span><span class="kw">$observer</span> == <span class="kw">$v</span><span class="ot">)</span>
            {
                <span class="fu">unset</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;observers<span class="ot">[</span><span class="kw">$k</span><span class="ot">]);</span>
                <span class="kw">return</span> <span class="kw">true</span><span class="ot">;</span>
            }
        }
        <span class="kw">return</span> <span class="kw">false</span><span class="ot">;</span>
    }

    <span class="kw">public</span> <span class="kw">function</span> notify<span class="ot">()</span>
    {
        <span class="kw">foreach</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;observers <span class="kw">as</span> <span class="kw">$observer</span><span class="ot">)</span> {
            <span class="kw">$observer</span>-&gt;update<span class="ot">(</span><span class="kw">$this</span><span class="ot">);</span>
        }
    }
    <span class="kw">public</span> <span class="kw">function</span> setState<span class="ot">(</span><span class="kw">$state</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;state = <span class="kw">$state</span><span class="ot">;</span>
    }

    <span class="kw">public</span> <span class="kw">function</span> getState<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;state<span class="ot">;</span>
    }
}

<span class="kw">interface</span> iObserver
{
    <span class="kw">public</span> <span class="kw">function</span> update <span class="ot">(</span>Subject <span class="kw">$subject</span><span class="ot">);</span>
}
<span class="kw">class</span> ConcreteObserver <span class="kw">implements</span> iObserver
{
    <span class="kw">private</span> <span class="kw">$state</span> = <span class="kw">null</span><span class="ot">;</span>
    <span class="kw">private</span> <span class="kw">$id</span><span class="ot">;</span>
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__construct</span><span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;state = <span class="kw">null</span><span class="ot">;</span>
        <span class="kw">$this</span>-&gt;id = <span class="fu">uniqid</span> <span class="ot">(</span><span class="fu">rand</span><span class="ot">(),</span> <span class="kw">true</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> getID<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;id<span class="ot">;</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__toString</span><span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="st">&quot;id: &quot;</span> . <span class="kw">$this</span>-&gt;getID<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> update <span class="ot">(</span>Subject <span class="kw">$subject</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;state = <span class="kw">$subject</span>-&gt;getState<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> getState<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;state<span class="ot">;</span>
    }
} 
<span class="kw">?&gt;</span></code></pre>
<h2 id="considerations"><a href="#TOC">Considerations</a></h2>
<p>Here are some further considerations when implementing Observer pattern that we haven’t discussed…</p>
<h3 id="spl"><a href="#TOC">SPL</a></h3>
<p>It should be noted that we could have used the PHP 5 Standard Library’s SplObserver and SplSubject instead of rolling our own interfaces. However, doing so was helpful in getting a clear understanding of exactly how the Observer Pattern works. If you’re interested learning more about SPL, you may want to have a look at the following resources: <a href="http://php.net/manual/en/book.spl.php">SPL</a>, <a href="http://php.net/manual/en/class.splsubject.php">SplSubject</a>, and <a href="http://php.net/manual/en/class.splobserver.php">SplObserver</a>. <em>Note that instead of register/unregister they use the names attach/detach.</em></p>
<h3 id="push-vs.pull"><a href="#TOC">Push vs. Pull</a></h3>
<p>It should also be noted there are different strategies for how the state is obtained by the observers. In this chapter’s example, we used the <em>pull method</em> since our observers called:</p>
<pre class="sourceCode php"><code class="sourceCode php">$subject-&gt;getState()</code></pre>
<p>Thus, upon being notified, we <q>pulled in</q> the changes from the subject. However, the inverse is also possible—where the subject <em>pushes</em> changes down to the observers—and, approriately enough, is called the <em>push method</em>. An example of how <em>push method</em> might work is the following:</p>
<pre class="sourceCode php"><code class="sourceCode php">$observer-&gt;update($this, $user, $trackPlayed, 
    $action, [..more state info..]);</code></pre>
<p><em>Here, the subject has explicitly included the pertinent state information in the call to update.</em></p>
<p>The up side here is that the observers need not call:</p>
<pre class="sourceCode php"><code class="sourceCode php">subject-&gt;getState()</code></pre>
<p>However, there’s bigger downside—loss of reuse. When we keep the state object in the subject generic enough, it’s easy to reuse the Observer code (since the state object abstracts itself in a model, value object, etc.) However, if we (in contrast to using a generic state object) use a specific method signature to push state, we tightly couple our subject to the observers. In general, favor the <em>pull method</em> over the <em>push method</em>.</p>
<h3 id="pitfalls"><a href="#TOC">Pitfalls</a></h3>
<p><em>Warning: This section contains some opinionated suggestions. Use your own judgement and form your own opinions!</em></p>
<p>The following are some potential issues to look out for when implementing Observer pattern:</p>
<ul>
<li><p><strong>Cyclic dependencies</strong>: Allowing observers to set state reduces orthogonality. It is our opinion that another <q>impartial module</q> should be responsible for providing state updates to the subject. If you do need this coupling consider another design approach or implementing a Mediator to manage these interactions.</p></li>
<li><p><strong>Relationship hierarchies</strong>: Insidious coupling can occur if you allow observers to interact with each other. Strive to design observers to be completely unaware of each other.</p></li>
<li><p><strong>Wasteful updates</strong>: If an observer only has a particular <em>interest</em>, recieving all updates is wasteful. This can be remedied by adding an <em>interest</em> input to the <em>register</em> signature and checking on a per observer basis before broadcasting to that observer.</p></li>
<li><p><strong>Spurious updates</strong>: In a high throughput system with many observers, there are potential temporal issues. For example, a call to <code>setState()</code> before a previous state has been fully pushed out could result in notifications being sent to observers that have yet to receieve the previous state. The obvious workaround is to queue these states and only start notifications for the <q>newest state</q> once <q>previous state</q> notification are complete. This of course adds additional complexity.</p></li>
<li><p><strong>Unpredictable ordering</strong>: This pattern does not provide predictable ordering of observer updates and doing so increases coupling.</p></li>
<li><p><strong>Inconsistent state</strong>: If setting state is more than a simple assignment, you must ensure <em>consistent state</em> before broadcasting updates.</p></li>
<li><p><strong>Duplicate observers</strong>: It’s easy to inadvertandly create a system where an observer is recieving <q>double updates</q> as a result of duplicates observers having been registered.</p></li>
</ul>
<p><em>We have other decisions to make when we design our implementation (who should call notify? what happens when a subject is deleted? will there be orphaned observers?). These require further research and are beyond the scope of this chapter.</em></p>
<h3 id="example-uses"><a href="#TOC">Example Uses</a></h3>
<p><strong>What are some example applications that might benefit from the Observer Pattern?</strong></p>
<p>Here are a couple ideas:</p>
<ul>
<li><p><strong>Mailing List</strong>: Let’s say you have a system that periodically adds new articles to be published. Upon a new article becoming available, the system could make a call to <em>setState</em> and thereafter <em>notify</em> allowing observers: EmailObserver, RSSFeedObserver, GooglePlusObserver, FacebookObserver, etc., to deal with the particulars of broadcasting said article as appropriate for that broadcast method.</p></li>
<li><p><strong>Login system</strong>: Say you want provide notifications to various sub-systems when a user logs in. For example you want a <q>Security Observer</q> and perhaps a <q>User Stats Observer</q> (for the marketing department), Logger (for troubleshooting), etc. You could do so easily with the Observer pattern. <em>This article has a nice example <a href="http://www.craigsefton.com/programming/php-patterns-the-observer-pattern/">Login system using Observer</a>.</em></p></li>
<li><p><strong>Social Music</strong>: A social music application could choose to broadcast notifications when a user plays, pauses, stops, fast forwards, seeks, etc. Perhaps your company is fortunate enough to be partnered with Facebook and needs to broadcast to the Music Dashboard via the <a href="https://developers.facebook.com/docs/technical-guides/opengraph/opengraph-tutorial/">Open Graph API</a>. But then another partner comes along and offers a similar deal to broadcast to the <a href="http://tunein.com">tunein</a> online radio site. And then another…</p></li>
</ul>
<p>In the above example, each partner’s API is likely to be quite different. You’d want your user tracking system to be <a href="http://en.wikipedia.org/wiki/Orthogonality#Computer_science">completely orthogonal</a> from the various broadcasting modules that will integrate with the above APIs. <em><a href="http://pragprog.com/book/tpp/the-pragmatic-programmer">The Pragmatic Programmer</a> book has a wonderful chapter on the advantages of writing orthogonal software if you’re interested in further investigating the concept.</em></p>
<ul>
<li><strong>GUI Notifications</strong>: You have some <q>live stats</q> that need to be reflected in real time by various components. For example, when the price of Apple stock changes, you need to update corresponding charts, graphs, text in callout boxes, etc.</li>
</ul>
<h2 id="exercises"><a href="#TOC">Exercises</a></h2>
<p>Do one of the following:</p>
<ul>
<li>Implement one of these systems using simple print statements. For example, when the RSSFeedObserver’s <em>update</em> is called you can just do something like:</li>
</ul>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">public</span> <span class="kw">function</span> update<span class="ot">(</span><span class="kw">$subject</span><span class="ot">)</span>
{
    <span class="kw">$article</span> = <span class="kw">$subject</span>-&gt;getState<span class="ot">();</span> 
    <span class="fu">print</span> <span class="st">&quot;RSSFeedObserver::update called: &quot;</span> .
        <span class="st">&quot;About to syndicate article &quot;</span> . <span class="kw">$article</span>-&gt;getTitle<span class="ot">();</span>
}
<span class="kw">?&gt;</span></code></pre>
<ul>
<li>Come up with your own problem that lends itself to the Observer pattern and implement it.</li>
</ul>
<h2 id="summary"><a href="#TOC">Summary</a></h2>
<p>In this chapter we’ve taken a look at the <em>Observer Pattern</em> and learned the following:</p>
<ul>
<li><p>What the <em>Observer Pattern</em> is and how to implement it</p></li>
<li><p>Observer allows us to <em>program to an interface, not an implementation</em>—subjects need not know about what the observers will do with state…they just call the <em>update</em> method—thus decoupling modules that interact</p></li>
<li><p>Observers can be <q>hot swapped</q> via the register and unregister routines</p></li>
<li><p>We discussed the differences and trade offs between the <em>pull method</em> and the <em>push method</em> strategies</p></li>
<li><p>Programming to an interface can result in less boiler-plate <q>guard checks</q> if type hinting used within the <em>update</em> routine</p></li>
<li><p>We also learned about some of the subtleties of TDD as we iterated on our Observer implementation</p></li>
</ul>
<p><strong>Other references not linked above</strong></p>
<p><a href="http://www.informit.com/articles/article.aspx?p=1150294&amp;seqNum=5">Design Patterns in Ruby</a>, <a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">Gang of Four</a>, <a href="http://www.citrenz.ac.nz/conferences/2005/concise/eales_observer.pdf">Easles on Observer</a>, <a href="http://www.research.ibm.com/designpatterns/example.htm">IBM Article</a>, <a href="http://www.gofpatterns.com/design-patterns/module6/tradeoffs-implementing-observerPattern.php">GOF Patterns</a>, <a href="http://askldjd.wordpress.com/2010/03/18/pitfalls-of-observer-pattern/">Pitfalls of Observer Pattern</a>, <a href="http://coding.derkeiler.com/Archive/General/comp.object/2006-07/msg00234.html">Derkeiler on Observer</a>, <a href="http://www.bandgap.cs.rice.edu/classes/comp410/resources/CppResources/DesignPatterns/observer.html">Rice - CPP Resources</a>, <a href="https://github.com/addyosmani">Addy Osmani Patterns Book</a> <a href="http://www.evilprofessor.co.uk/211-php-design-patterns-observer-pattern/">PHP Design Patterns</a>, <a href="http://www.andypangus.com/tags/design-patterns">Andy Pangus Article</a></p>
<h1 id="object-oriented-principles"><a href="#TOC">Object Oriented Principles</a></h1>
<p>This book assumes fundamental knowledge of basic object oriented concepts—a prerequisite to understanding the patterns we’ll be covering in this book—and so the discussion here will be purposely short for for the sake of brevity. If you’re already an <q>object oriented guru</q>, feel free to skip this chapter (although may want to peruse the section on S.O.L.I.D. principles for review).</p>
<h2 id="abstraction"><a href="#TOC">Abstraction</a></h2>
<p>Dictionary.com provides the following definition for abstraction: &gt; Considering something as a general quality or characteristic, apart from concrete realities, specific objects, or actual instances.</p>
<p>From a programming perspective, an abstraction is a focused representation of the essential properties of a particular thing. Further, an <em>abstract date type</em> (ADT), will, typically, provide self-evident and immediate understanding of what that thing is. For example, when we mention the word <q>Car</q>, it is immediately understood that we are talking about a <em>specific type of thing</em> that can be driven, has a steering wheel, breaks, etc. So, although a car mechanic may additionally think of internal combustion systems, crankshafts, cylinders, pistons, etc.—your crazy Aunt Helen surely does not! It’s the first set of car qualities described that are at a <em>higher level of abstraction</em>, and therefore, easier to understand. When we make good use of abstraction while designing our interfaces, we keep the inner workings and gory details of our implementations hidden; they become <q>black boxes</q>, that, <q>just work</q>.</p>
<h2 id="class"><a href="#TOC">Class</a></h2>
<p>A class can be thought of as a blueprint that defines an abstract data type (or ADT; see above). Thinking in terms of the nouns in a problem statement (e.g. an employee, customer, bank account, etc.), one can derive classes from real world things.</p>
<p><em>For brevity’s sake, we assume you have some knowledge in this area. If not, see <a href="http://en.wikipedia.org/wiki/Class_(computer_programming)">Wikipedia’s page on Classes</a>.</em></p>
<h2 id="interface"><a href="#TOC">Interface</a></h2>
<blockquote>
<p>The set of all signatures defined by an object’s operations is called the <em>interface</em> to the object. An object’s interface characterizes the complete set of requests that can be sent to the object … <em>type</em> is a name used to denote a particular interface … a type is a <em>subtype</em> of another if its interface contains the interface of its <em>supertype</em>—GoF</p>
</blockquote>
<p>The word type supports the notion that something is a <em>particular type of thing</em>, and so it may brings some semantic benefits in that it helps us to visualize that thing in our minds. We will, therefore, use it interchangably with interface .</p>
<h2 id="dynamic-binding"><a href="#TOC">Dynamic Binding</a></h2>
<p>Through the use of interfaces we can achieve <em>dynamic binding</em>—the run-time association of a method call on an object and one of its methods. Since an interface provides a guarantee that certain operations will be available, we can substitute objects that have identical interfaces for each other at run-time. This substitutability is, in fact, known as <em>polymorphism</em>, and will be discussed in more detail below.</p>
<h2 id="inheritance"><a href="#TOC">Inheritance</a></h2>
<p>A <em>superclass</em> (also known as a base, or parent class) contains the core properties of a type, and may be <q>inherited from</q> by a <em>subclass</em> (also known as a derived, extended, or child class). The ability to inherit provides a way to reuse fields and methods since sub-types are able to <em>derive</em> properties from their ancestors.</p>
<h2 id="encapsulation"><a href="#TOC">Encapsulation</a></h2>
<p><a href="http://www.amazon.com/Object-Oriented-Analysis-Design-Applications-3rd/dp/020189551X">Grady Booch</a> defines encapsulation as: &gt; <q>the process of compartmentalizing the elements of an abstraction that constitute its structure and behavior</q>.</p>
<p>Encapsulation is a means of achieving <em>information hiding</em> such that the internal properties of an object are only allowed to be accessed or modified in a centralized and controlled manner. This is typically done via accessors and mutators (also known as getters and setters). The encapsulated property can then be changed (or completely replaced, reimplemented, etc.), and—provided the public interface remains the same—external components will not be impacted.</p>
<p>Encapsulation provides another <q>protective benefit</q>—the prevention of internal data from being changed throughout a system—and, thus, helps us to maintain proper data integrity. Further, encapsulation reduces system complexity by limiting interdependencies between software components.</p>
<p>To recap, the following are benefits of encapsulation: * data management is centralized * data integrity is maintained * modules remain decoupled since each manage their own data</p>
<p>These concepts are explored in much greater detail in the seminal work by <a href="http://www.amazon.com/Object-Oriented-Analysis-Design-Applications-3rd/dp/020189551X">Grady Booch, Object-Oriented Analysis and Design with Applications</a>. The following two pages are also useful: <a href="http://en.wikipedia.org/wiki/Encapsulation_(object-oriented_programming)">Encapsulation</a>, and <a href="http://en.wikipedia.org/wiki/Information_hiding">Information Hiding</a> Wikipedia pages for more details.</p>
<h2 id="polymorphism"><a href="#TOC">Polymorphism</a></h2>
<p><a href="http://en.wikipedia.org/wiki/Polymorphism_(computer_science)">Wikipedia</a>: &gt;Polymorphism is a programming language feature that allows values of different data types to be handled using a uniform interface.</p>
<p>The word <em>polymorphism</em> refers to the ability for one thing to take on many different forms. Similarly, in programming, polymorphism is the ability for one interface to represent many implementations. This is generally achieved by having an <em>interface</em> that is implemented by one or more <em>sub-types</em> (concrete implementations of that interface). While the sub-types may contain varying implementation details, the fact that they all support the same interface allows them to be used interchangeably.</p>
<p>Computer programs can utilize polymorphism and achieve runtime flexibility. If we take our Car example from earlier, and assume the Car interface has a <em>drive</em> method, we can pass instances that implement this interface dynamically. The users of these instances will be able to <q>blindly</q> call <em>drive</em>:</p>
<pre class="sourceCode java"><code class="sourceCode java">Car honda = <span class="kw">new</span> <span class="fu">HondaAccord</span>();
Car toyota = <span class="kw">new</span> <span class="fu">ToyotaCamry</span>();
someObject.<span class="fu">doSomethingUsefulWithCars</span>(honda);
someObject.<span class="fu">doSomethingUsefulWithCars</span>(toyota);
...
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">doSomethingUsefulWithCars</span>(Car car) {
    <span class="co">// We don&#39;t have to care what kind of car it is, we just call drive:</span>
    car.<span class="fu">drive</span>();
}</code></pre>
<p>The most interesting part here is that—while we have instantiated two completely different car implementations (a Honda and a Toyota)—we have set them both to the type Car (an interface). In doing so, we guarantee that they have both have the <em>drive</em> method available. This is known as <q>programming to an interface not an implementation</q>, and becomes quite important as we strive for more flexibile systems. <em>See the chapter on Strategy pattern for a more detailed example.</em></p>
<p><a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">GoF</a> succinctly states some of polymorphism’s key benefits:</p>
<blockquote>
<p>Polymorphism simplifies the definitions of clients, decouples objects from each other, and lets them vary their relationships to each other at run-time.</p>
</blockquote>
<h2 id="s.o.l.i.d.-principles"><a href="#TOC">S.O.L.I.D. Principles</a></h2>
<p>The <a href="http://en.wikipedia.org/wiki/SOLID_(object-oriented_design)">mnemonic acronym SOLID was</a>: &gt; introduced by Michael Feathers for the <q>first five principles</q> identified by Robert C. Martin in the early 2000s that stands for five basic principles of object-oriented programming and design. The principles when applied together intend to make it more likely that a programmer will create a system that is easy to maintain and extend over time.</p>
<h2 id="srp-the-single-responsibility-principle"><a href="#TOC">SRP: The Single Responsibility Principle</a></h2>
<p>The SRP principle is related to a broader concept called <em>cohesion</em>—the degree to which elements of a class or module are related. If you have a Customer class that deals with saving this customer to a file or database, generating reports for the customer, etc., it would be said to have <em>low cohesion</em> since these are not the responsibilities of a customer.</p>
<p>The SRP provides that: <a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod">A class should have one, and only one, reason to change</a>. Inverting this we could say that: a class with only one responsibility only has one reason to change. For an interesting discussion on the SOLID principle see the <a href="http://hanselminutes.com/145/solid-principles-with-uncle-bob-robert-c-martin">Hanselminutes Podcast #145</a> where Robert Martin interviewed on the topic.</p>
<h2 id="openclosed-principle"><a href="#TOC">Open/Closed Principle</a></h2>
<p>The open/closed principle provides that: classes may be open for extension but closed for change. So, if we want augment a classes behavior, we must do so without actually modifying the class itself! Strategies for accomplishing this will be discussed in more detail in later chapters, but we may:</p>
<ul>
<li><p>Use <em>compositional delegation</em> to compose various abstractions at runtime, all acting in accordance with a common interface. <em>We will see this technique in action in the chapter on the Strategy pattern.</em></p></li>
<li><p>Use an asynchronous messaging scheme, where objects are notified on an <q>as-needed basis</q>, via a common defined interface.<em>This technique will be seen in the chapter on the Observer pattern.</em></p></li>
<li><p>Use a plugin based archetecture that instantiates dynamic plugins, perhaps, searching a common directory and/or using common naming conventions, etc.</p></li>
</ul>
<p>The take away, is that we should strive to design our modules, such that, once they’ve been fully tested and deployed in to production, we don’t have to make any more <em>direct changes</em> to them. While this may seem overly ambitious, it turns out to be accomplishable.</p>
<h2 id="liskov-substitution-principle"><a href="#TOC">Liskov Substitution Principle</a></h2>
<p>In his interview with Scott Hansen (<a href="http://hanselminutes.com/145/solid-principles-with-uncle-bob-robert-c-martin">show #145</a>), Robert C. Martin describes how the substitution principle may be understood in terms of how inherited instances may be used within a program: &gt; <q>If you have an expectation of some object or some entity and there are several possible sub-entities, we’ll call them sub-types that could implement that original entity. The caller of the original entity should not be surprised by anything that happens if one of the sub-entities is substituted. So, the simple way to think about this is, if you’re used to driving a Chevrolet you shouldn’t be too surprised when you got into a Volkswagen, you’d still be able to drive it. That’s the basic idea, there’s an interface, you can use that interface, lots of things implement that interface one way or another and none of them should surprise you.</q></p>
<p>He has also covered this in his writings by succinctly stating: <a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod"><q>Derived classes must be substitutable for their base classes.</q></a></p>
<p>Another example might be if we were to create a Stack class by inheriting from a LinkedList super class. Although we’d be able to conveniently use the list’s functionality to <em>push</em> and <em>pop</em> elements from off the front of the list, we could not pass around the <em>stack instance</em> without surprising users with inappropriate methods (those inherited from the linked list like: <em>contains</em>, <em>indexOf</em>, etc.) These operations are not what one might expect from a stack, and therefore, we’d be violating the substitution principle.</p>
<p>In this case, we should, instead, compose the Stack with an internal property that references an instance of linked list. With that in place, the Stack can then choose to expose only the appropriate <em>push</em> and <em>pop</em> operations—these would, in turn, delegate to the list <q>under the hood</q>. The concept of <em>delegation</em> can be distilled as:</p>
<ul>
<li>a class property holds a reference to another <em>module</em> (the delegate)</li>
<li>that property is used to call one of the delegate’s instance methods</li>
</ul>
<p>By using a list instance (rather than inheriting from list) and then delegating to it, we are <em>favoring composition over inheritance</em>. Here’s naive but easy to understand example of how that might work (please humor our assumptions):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Stack {
    <span class="co">// Here we are &quot;composing&quot; our stack with a list</span>
    <span class="co">// Assume we later initialized with: list=new LinkedList() </span>
    <span class="kw">private</span> List list;

    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">push</span>(Object someObject) {
        <span class="co">// Assume the linked list inserts at index 0</span>
        list.<span class="fu">insert</span>(someObject);
    }

    <span class="kw">public</span> Item <span class="fu">pop</span>() {
        <span class="co">// Assume the linked list returns the first item on delete</span>
        <span class="kw">return</span> list.<span class="fu">delete</span>();
    }
}</code></pre>
<p>If we were to now create an instance of this version of Stack class, it would no longer expose inappropriate list methods as it did before. Only <em>push</em> and <em>pop</em> are exposed (which is what one would expect of a simple Stack), and thus, it does not <em>surprise</em> it’s users. Incomplete as this implementation might be, it would not be in violation of the Liskov Substitution Principle.</p>
<p><strong>When ISA <q>falls down</q></strong> A heuristic that’s popular for determining class relationships is to check if the <q>ISA</q> statement holds true. For example, we could classify an Espresso by saying that it <em>isa</em> (yes, that’s one word!) type of beverage. It holds that if something is a type of something else, it must share some properties. For example, both a Beverage and an Espresso have a <em>density</em>. Since density is fairly <em>low level</em> thing, it’s nice to have that defined in Beverage, so Esspresso doesn’t have to deal with such details. We can then focus on more interesting features of Esspresso like <em>caffeine</em> and perhaps define an operation like: <em>getAmountOfCaffeine</em>. Therefore, we are able to contemplate Esspresso from a higher level of abstraction. Unfortunately, though, performing such classifications using the isa technique has some issues…</p>
<p><a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod">Robert Martin</a> provides that the above heuristic can break down with the canonical example: a square <em>is a</em> rectangle. While this holds (from a geometry perspective), if you derive a Square class from a Rectangle class, you will get inappropriate behavior. For example, <em>setHeight</em> from Rectangle, will not need to do anything to it’s width, whereas the Square must be sure to keep its width and height the same. In fact, the square might not even want to separate width and height, and prefer to have a <q>side</q> property instead (since a square’s sides will always have the same length!). Being lazy, you may decide that, <q>well, I can override setHeight, and put in a simple conditional check</q>). As you do so, you realize that you will also need the exact same conditional check in setWidth. Obviously, this scenario will result in an abysmal state of affairs for the poor maintainer of the inconsistent Square.</p>
<h2 id="interface-segregation-principle"><a href="#TOC">Interface Segregation Principle</a></h2>
<p>ISP, essentially, provides that one large interface must be <q>segregated</q> into (separated), more specific, individual interfaces. This is really a corollary to <em>single responsibility</em> and <em>cohesion</em> principles which provide that a particular module should have one, and only one, focused responsibility.</p>
<p><a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod"><q>Make fine grained interfaces that are client specific.</q></a>—Robert Martin</p>
<h2 id="dependency-inversion-principle"><a href="#TOC">Dependency Inversion Principle</a></h2>
<p>The dependency inversion explicity states that we should: <a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod"><q>depend on abstractions, not on concretions.</q></a>—Robert Martin. So, if you’re calling a function, it should be an abstract function; if you’re holding a reference to an object, that reference must point to an abstraction, etc. In practice, this is impossible to achieve throughout an entire system, since, at some point, somewhere, we’ll need to instantiate an object instance. We can, however, be mindful to encapsulate these object creations using creational patterns we’ll discuss later. By doing so, we compartmentalize areas that are likely to change.</p>
<h1 id="decorator-pattern"><a href="#TOC">Decorator Pattern</a></h1>
<h2 id="overview-1"><a href="#TOC">Overview</a></h2>
<p><a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">Design Patterns: Elements of Reusable Object-Oriented Software</a> provide the following intent for decorators:</p>
<blockquote>
<p>Attach additional responsibilities to an object dynamically. Decorators provide a flexible alternative to subclassing for extending functionality.</p>
</blockquote>
<p>They further state that decorators may be used to:</p>
<blockquote>
<p>add responsibilities to individual objects dynamically … for responsibilities that can be withdrawn … when extension by subclassing is impractical …</p>
</blockquote>
<p>Decorators, also known as <em>wrappers</em>, conform to the interface of the component they decorate. When the decorator is called, it in turn, calls the same method for the component it decorates (it can do so since they share a common interface). This arrangement allows us to nest decorators recursively, and add or remove them as needed.</p>
<h2 id="decorator-pattern-class-diagram"><a href="#TOC">Decorator Pattern Class Diagram</a></h2>
<p>The following is a class diagram that represents the Decorator Pattern we’ll be discussing in this chapter:</p>
<figure>
<img src="img/decorator.png" title="Decorator Pattern UML Class Diagram" alt="Decorator Pattern Class Diagram"><figcaption>Decorator Pattern Class Diagram</figcaption>
</figure>
<h2 id="decorator-pattern-implementation"><a href="#TOC">Decorator Pattern Implementation</a></h2>
<p>Here are the steps to implementing the decorator pattern:</p>
<ul>
<li><p>Define your main component’s interface</p></li>
<li><p>Define your concrete implementations of that interface</p></li>
<li><p>Define a Decorator interface or abstract class. It must also implement the main component’s interface!</p></li>
<li><p>Define concrete decorators that conform to above interface. <em>You may be able to <q>pull up</q> the method in to the above abstract Decorator if the decorated operation is simple and/or there is duplication (we did so in our examples below).</em></p></li>
<li><p>In the client code (code that uses the decorator(s) defined above):</p>
<ul>
<li>Instantiate the main component</li>
<li>Instatiate one or many decorators being careful to <q>wrap</q> each one around the main component</li>
<li>Call decorated operations as needed</li>
</ul></li>
</ul>
<h3 id="java-implementation"><a href="#TOC">Java Implementation</a></h3>
<p>Let us imagine that we have a store that sells tennis rackets that are set at various prices as expected. However, a customer may also choice to customize the string, grip, etc., when making their purchase. Thus we need a way to account for the change in price depending on these customizations. We can do so easily by simply wrapping each customization in respective decorators. Let’s look at how this might be implemented using Java…</p>
<p><em>Disclaimers: for the sake of brevity and understandability, we have not been <q>thorough</q> in either our tests or implementation. We may continue to take such liberties throughout the rest of the book. Also note that we have combined the tests and implementation below (whereas the project in the book’s repo has separate files)</em></p>
<pre class="sourceCode java"><code class="sourceCode java">
<span class="co">/**</span>
<span class="co"> </span>*<span class="co"> Tests </span>
<span class="co"> */</span>

<span class="kw">import static org.junit.Assert.*;</span>

<span class="kw">import org.junit.After;</span>
<span class="kw">import org.junit.Before;</span>
<span class="kw">import org.junit.Test;</span>


<span class="kw">public</span> <span class="kw">class</span> RacketTests {

    <span class="kw">private</span> ConcreteRacket racket;
    
    @Before
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setUp</span>() <span class="kw">throws</span> Exception {
        racket = <span class="kw">new</span> <span class="fu">ConcreteRacket</span>();
    }

    @After
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">tearDown</span>() <span class="kw">throws</span> Exception {
        racket = <span class="kw">null</span>;
    }

    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testShouldDecorateComponentWithSynthGut</span>() {
        RacketDecorator decorator = <span class="kw">new</span> <span class="fu">PrinceSyntheticGutStringDecorator</span>(racket);
        <span class="fu">assertEquals</span>(<span class="st">&quot;Should wrap with Synthgut decorator and add it&#39;s price&quot;</span>, 
                <span class="fl">105.00</span>, decorator.<span class="fu">getPrice</span>(), <span class="fl">0.01</span>);
    }
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testShouldDecorateComponentWithVSGut</span>() {
        RacketDecorator decorator = <span class="kw">new</span> <span class="fu">VSGutStringDecorator</span>(racket);
        <span class="fu">assertEquals</span>(<span class="st">&quot;Should wrap with Synthgut decorator and add it&#39;s price&quot;</span>, 
                <span class="fl">140.00</span>, decorator.<span class="fu">getPrice</span>(), <span class="fl">0.01</span>);
    }
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testShouldAddMultipleDecoratorTypes</span>() {
        RacketDecorator decorator = 
            <span class="kw">new</span> <span class="fu">WilsonProOvergripDecorator</span>( <span class="kw">new</span> <span class="fu">VSGutStringDecorator</span>(racket) );
        <span class="fu">assertEquals</span>(<span class="st">&quot;Should wrap with VSGut decorator and add it&#39;s price&quot;</span>, 
                <span class="fl">143.00</span>, decorator.<span class="fu">getPrice</span>(), <span class="fl">0.01</span>);
    }
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testShouldAddSameDecoratorsMultipleTimes</span>() {
        RacketDecorator decorator =
            <span class="kw">new</span> <span class="fu">WilsonProOvergripDecorator</span>( <span class="kw">new</span> <span class="fu">VSGutStringDecorator</span>(racket) );
        RacketDecorator wrappedAgain = <span class="kw">new</span> <span class="fu">WilsonProOvergripDecorator</span>( decorator );
        <span class="fu">assertEquals</span>(<span class="st">&quot;Should wrap with multiple decorators and adding all to price&quot;</span>, 
                <span class="fl">146.00</span>, wrappedAgain.<span class="fu">getPrice</span>(), <span class="fl">0.01</span>);
    }
}


<span class="co">/**</span>
<span class="co"> </span>*<span class="co"> Implementation </span>
<span class="co"> */</span>

<span class="kw">public</span> <span class="kw">interface</span> Racket {
    <span class="kw">public</span> <span class="dt">double</span> <span class="fu">getPrice</span>();
}

<span class="kw">public</span> <span class="kw">class</span> ConcreteRacket <span class="kw">implements</span> Racket {
    
    <span class="co">// In a &quot;real program&quot;, we&#39;d create a &quot;value object&quot;</span>
    <span class="kw">private</span> <span class="dt">double</span> price;

    <span class="kw">public</span> <span class="fu">ConcreteRacket</span>() {
        price = <span class="dv">100</span>;
    }
    
    @Override
    <span class="kw">public</span> <span class="dt">double</span> <span class="fu">getPrice</span>() {
        <span class="kw">return</span> price;
    }   
}

<span class="kw">public</span> <span class="kw">abstract</span> <span class="kw">class</span> RacketDecorator <span class="kw">implements</span> Racket {

    <span class="kw">protected</span> Racket racket;
    <span class="kw">protected</span> <span class="dt">double</span> price;
    
    <span class="kw">public</span> <span class="fu">RacketDecorator</span>(Racket component) {
        racket = component;
    }
    
    @Override
    <span class="kw">public</span> <span class="dt">double</span> <span class="fu">getPrice</span>() {
        <span class="kw">return</span> racket.<span class="fu">getPrice</span>() + price;
    }

}

<span class="kw">public</span> <span class="kw">class</span> PrinceSyntheticGutStringDecorator <span class="kw">extends</span> RacketDecorator {
    
    <span class="kw">public</span> <span class="fu">PrinceSyntheticGutStringDecorator</span>(Racket component) {
        <span class="kw">super</span>(component);
        <span class="kw">this</span>.<span class="fu">price</span> = <span class="dv">5</span>;
    }
}

<span class="kw">public</span> <span class="kw">class</span> VSGutStringDecorator <span class="kw">extends</span> RacketDecorator {
    <span class="kw">public</span> <span class="fu">VSGutStringDecorator</span>(Racket component) {
        <span class="kw">super</span>(component);
        <span class="kw">this</span>.<span class="fu">price</span> = <span class="dv">40</span>;
    }
}

<span class="kw">public</span> <span class="kw">class</span> WilsonProOvergripDecorator <span class="kw">extends</span> RacketDecorator {

    <span class="kw">public</span> <span class="fu">WilsonProOvergripDecorator</span>(Racket component) {
        <span class="kw">super</span>(component);
        <span class="kw">this</span>.<span class="fu">price</span> = <span class="dv">3</span>;
    }

}</code></pre>
<h3 id="php-implementation"><a href="#TOC">PHP Implementation</a></h3>
<p>Let us now look at the PHP version of this same implementation. It’s virtually identical!</p>
<pre class="sourceCode php"><code class="sourceCode php">
<span class="kw">&lt;?php</span>

<span class="kw">interface</span> iRacket 
{
    <span class="kw">public</span> <span class="kw">function</span> getPrice<span class="ot">();</span>
}

<span class="kw">class</span> Racket <span class="kw">implements</span> iRacket 
{
    <span class="kw">private</span> <span class="kw">$price</span><span class="ot">;</span>

    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__construct</span><span class="ot">()</span>
    {
        <span class="kw">$this</span>-&gt;price = <span class="dv">100</span><span class="ot">;</span>
    }

    <span class="kw">public</span> <span class="kw">function</span> getPrice<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;price<span class="ot">;</span>
    }
}

<span class="co">// We use abstract instead of interface here so we can define </span>
<span class="co">// the properties $component and $price properties just once</span>
<span class="co">// Also note that by implementing iRacket, it &quot;gets&quot; getPrice.</span>
<span class="kw">abstract</span> <span class="kw">class</span> RacketDecorator <span class="kw">implements</span> iRacket
{
    <span class="kw">protected</span> <span class="kw">$component</span><span class="ot">;</span>
    <span class="kw">protected</span> <span class="kw">$price</span><span class="ot">;</span>
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__construct</span><span class="ot">(</span><span class="kw">$racket</span><span class="ot">)</span>
    {
        <span class="kw">$this</span>-&gt;component = <span class="kw">$racket</span><span class="ot">;</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> getPrice<span class="ot">()</span>
    {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;component-&gt;getPrice<span class="ot">()</span> + <span class="kw">$this</span>-&gt;price<span class="ot">;</span>
    }
}

<span class="kw">class</span> PrinceSyntheticGutStringDecorator <span class="kw">extends</span> RacketDecorator
{
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__construct</span><span class="ot">(</span><span class="kw">$racket</span><span class="ot">)</span>
    {
        <span class="kw">parent</span>::<span class="fu">__construct</span><span class="ot">(</span><span class="kw">$racket</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;price = <span class="dv">5</span><span class="ot">;</span>
    }
}
<span class="kw">class</span> VSGutStringDecorator <span class="kw">extends</span> RacketDecorator
{
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__construct</span><span class="ot">(</span><span class="kw">$racket</span><span class="ot">)</span>
    {
        <span class="kw">parent</span>::<span class="fu">__construct</span><span class="ot">(</span><span class="kw">$racket</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;price = <span class="dv">40</span><span class="ot">;</span>
    }
}
<span class="kw">class</span> WilsonProOvergripDecorator <span class="kw">extends</span> RacketDecorator
{
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__construct</span><span class="ot">(</span><span class="kw">$racket</span><span class="ot">)</span>
    {
        <span class="kw">parent</span>::<span class="fu">__construct</span><span class="ot">(</span><span class="kw">$racket</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;price = <span class="dv">3</span><span class="ot">;</span>
    }
}

<span class="kw">?&gt;</span></code></pre>
<p><em>We have omitted the PHP tests to save space, but, if you’d like to see them, they are in the book’s repo.</em></p>
<p>We have coded the above implementation quite close to the racket <em>domain</em>, but we could have chosen to make a more general Product module, in place of what we called Racket, and thereafter embody various different types of products within Product. This might be useful in a general shopping cart scenario.</p>
<h2 id="considerations-1"><a href="#TOC">Considerations</a></h2>
<p>Let us now examine the benefits and drawbacks of this pattern, and also, look at why it might be a better choice than inheritance.</p>
<h3 id="decorator-vs.inheritance"><a href="#TOC">Decorator vs. Inheritance</a></h3>
<p>Decorators are often contrasted to using static inheritance to achieve the same thing—after all, we do have the option to simply create new sub-classes for each new responsibility discovered. In doing so, however, we increase the complexity of our system and pollute our base class with unrelated responsibilities.</p>
<p>Let’s take an example that leads to having child classes that need to share properties with each other. Many derived <em>Beverage</em> types might need to have a Milk property, for example: Egg Nog, Shake, Mocha, while others do not (Juice should <strong>not</strong> have a Milk property). This leads to the following quandary: if we add milk to each derived class we will end up with <em>duplication</em>, but, if we instead add milk to the base class we violate the <em>substitution principle</em> (as one will undoubtedly be <em>surprised</em> to find a Milk property in their <em>orange juice</em> instance!).</p>
<p>We can avoid these inheritance problems altogether as the decorator pattern allows us to: <em>change the skin of an object versus changing its guts</em>—<a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">GoF</a>. We simply add or remove decorators as needed. Doing so will simply <em>extend</em> the functionality of our classes, while acting in accordance with the open/closed principle—which, as you recall, states that we can extend a class, but must not not change it directly.</p>
<h3 id="transparency"><a href="#TOC">Transparency</a></h3>
<p>One key benefit of the decorator pattern is that, by using the component’s original interface, we can transparently add capabilities. This unburdens clients from having to keep track of things like: how many times has the component been decorated, in what way, etc. We simply add responsibilities, as needed, by merely wrapping the component with new decorators.</p>
<h2 id="pitfalls-1"><a href="#TOC">Pitfalls</a></h2>
<p><strong>Explosion of decorator objects</strong></p>
<p>Use of this pattern will often lead to a proliferation of small, similar classes, decreasing both understandability and maintainability. One can imagine a whole product catalog implemented this way (and get an immediate migrane headache as a result!)</p>
<p><strong>Identity tests</strong></p>
<p>Decorators are not identical to the components they wrap, and thus, tests for object types will not work.</p>
<p><strong>Removal/reordering of decorators</strong></p>
<p>As you recall, <a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">GoF</a> provides that you might use decorators:</p>
<blockquote>
<p>for responsibilities that can be withdrawn</p>
</blockquote>
<p>This would seem to imply the ability to withdraw decorators (perhaps at run-time). If we consider the underlying mechanics of how decorators reference one another—similar to a linked list, where one link has a direct relationship to the next or previous—one might simply manipulate references to achieve this. However, this would result in objects that <em>need to know too much</em>, adding complexity and coupling to a system. In practice, removal won’t be required, but, if you absolutely must have this functionality, you might want to consider another approach.</p>
<p><strong>It not be idiomatic for the language you’re using</strong></p>
<p>The decorator pattern is more pervasive in certain (usually statically typed) languages than others. Java and .NET, both use the decorator pattern extensively in their own I/O Stream implementations. Also, most GUI programming done in Java will involve the wrapping of nested UI components. Thus, if you’re on a team that’s doing Java, C#, etc., the decorator pattern might be perfectly appropriate. However, if you’re using a more dynamic language (like Ruby), it may not be an idiomatic choice. Since such languages allow you to add methods to objects at runtime—known as <em>duck typing</em> (<q>if it walks like a duck, and quacks like a duck, treat it as a duck</q>)—you might entirely avoid the decorator pattern.</p>
<h2 id="exercises-1"><a href="#TOC">Exercises</a></h2>
<p>We mentioned that while our implementation is quite specific to tennis rackets, one could implement a shopping cart system utilizing the decorator pattern to represent the products in that system. Do so. You don’t need to implement a <q>full blown</q> shopping cart system, simply use print statements to stub out details that are not pertinent to the exercise.</p>
<p>Once you’ve done the above, add more and more products to your store’s catalog. What do you notice?</p>
<h1 id="factory-pattern"><a href="#TOC">Factory Pattern</a></h1>
<h2 id="overview-2"><a href="#TOC">Overview</a></h2>
<p>In this chapter, we will discuss object creation, and specifically, how you can use factories to encapsulate such creational responsibilities. You’ll see that instantiation is a rather volatile affair that should be compartmentalized before it gets <q>out of control</q>. But before we dive in to factory patterns, let’s revisit some prerequisite object-oriented principles.</p>
<p><strong>Encapsulate what varies</strong></p>
<p>Any portion of code that instantiates a new object is taking on a creational responsibility; and further becomes coupled to the type being instantiated. This defeats our goal to create classes that are cohesive units that do <q>one thing well</q>. Even more insidious is the fact that there’s no guarantee what new objects we’ll need tomorrow…today we need an Oracle connection, tomorrow a MySQL connection…today we’re sending Email messages, tomorrow RSS feeds…and so on. We’ve already learned that we should encapsulate areas likely to change—and creational code, as we’ve seen, is always likely to change.</p>
<p><strong>Dependency Inversion Principle</strong></p>
<p>If you recall from our object-oriented chapter, we discussed the S.O.L.I.D. principles which included the <em>Dependency Inversion Principle</em>. Let’s dig a bit deeper into that principle which states that:</p>
<p>A. High-level modules should not depend on low-level modules. Both should depend on abstractions.</p>
<p>B. Abstractions should not depend upon details. Details should depend upon abstractions.</p>
<p>What are high and low level modules? High-level modules deal with larger sets of functionality, whereas lower level modules deal with more detailed operations. For example, a module that generates SQL, connects to a Database, and then executes that SQL’s query, would be a low-level module. A related, but higher-level module, might be a Persistance class responsible for allowing general data persistence. While it may use the aforementioned low-level database module to write to the database, it may also work with other low-level modules like an I/O module for writing to files, a Console module for writing to standard output, and so on. So, if in this example, our Persistance class directly creates instances of any of the lower-level classes (DB, I/O, Console, etc.), it breaks the Dependency Inversion Principle since instantiation causes a direct dependency.</p>
<p>Let’s make this all a bit more concrete with another example. Assume you have a Messenger module that’s in charge of sending things. Perhaps your first set of requirements state that the Messenger need only send via the post office (<q>snail mail</q>):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Messenger {
    <span class="kw">private</span> SnailMail mail;
    <span class="kw">public</span> <span class="fu">Messenger</span> () {
        mail = <span class="kw">new</span> <span class="fu">SnailMail</span>();
    }
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">send</span>(String destination, Package <span class="kw">package</span>) {
        mail.<span class="fu">send</span>(String destination, Package <span class="kw">package);</span>
    }
}   
<span class="kw">class</span> SnailMail {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">send</span>(String destination, Package <span class="kw">package</span>) {
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Postal service sending package&quot;</span>);
    }
}</code></pre>
<p>The key violation of DIP above is the <q>mail</q> property of type SnailMail. Since Messenger is a high level module, and it now depends on the SnailMail module, DIP has been violated. We can see why this violation matters if we imagine that tomorrow our Messenger needs to additionally support a Fedex sender. Having a crazy deadline to meet we nervously code up the following:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Messenger {
    <span class="kw">private</span> SnailMail mail;
    <span class="kw">private</span> Fedex fedex;
    <span class="kw">public</span> <span class="kw">enum</span> Speed {FAST, SLOW};

    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">send</span>(Speed speed,
            String destination, Package <span class="kw">package</span>)
    {
        <span class="kw">if</span> (speed == Speed.<span class="fu">FAST</span>) {
            <span class="kw">this</span>.<span class="fu">fedex</span> = <span class="kw">new</span> <span class="fu">Fedex</span>();
            <span class="kw">this</span>.<span class="fu">fedex</span>.<span class="fu">send</span>(String destination, Package <span class="kw">package);</span>
        } <span class="kw">else</span> {
            <span class="kw">this</span>.<span class="fu">mail</span> = <span class="kw">new</span> <span class="fu">SnailMail</span>();
            <span class="kw">this</span>.<span class="fu">mail</span>.<span class="fu">send</span>(String destination, Package <span class="kw">package);</span>
        }
    }
}   </code></pre>
<p>Hopefully, you find this code objectionable! We now have the following unfortunate code smells:</p>
<ul>
<li>the unfortunate addition of the <q>speed</q> enum property</li>
<li>extra type-based fields making code harder to read</li>
</ul>
<p>The rather inprecise <q>speed</q> property will be problematic when we add senders that send things at approximately the same speed, or have new speeds requiring us to add new enum values.</p>
<p>Also, what happens next week when we decide to support international mail and have opportunities to add new carriers? We’ll have to directly modify the conditional code adding these carriers (and we’ll be breaking the open/closed principle since we’ll have to modify our class directly!)</p>
<p>So how can we solve these sorts of problems without breaking DIP? Let’s see how the Factory Method might help to circumnavigate such issues.</p>
<h2 id="factory-method"><a href="#TOC">Factory Method</a></h2>
<p>The factory method is a creational design pattern that allows you to encapsulate the creation of concrete types by defining an abstraction through which objects are created:</p>
<blockquote>
<p><q>Define an interface for creating an object, but let subclasses decide which class to instantiate. Factory Method lets a class defer instantiation to subclasses.</q>—<a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">Gang of Four</a></p>
</blockquote>
<figure>
<img src="img/factory-method.png" alt="Factory Method"><figcaption>Factory Method</figcaption>
</figure>
<p>As we’ll see shortly, the Factory Method has two main variants, one using sub-classing, the other a parameterized factory method. We’ll start out looking at the sub-classing variant which is implemented as follows:</p>
<ul>
<li><em>Product</em> defines the interface for products</li>
<li><em>ConcreteProduct</em> implements the product interface</li>
<li>An abstract class <em>Creator</em> defines a factory method, which creates and returns a <em>Product</em></li>
<li>A ConcreteCreator overrides the factory method to return actual instances of a <em>ConcreteProduct</em></li>
</ul>
<p>Let’s toss our earlier Messenger code and try implementing a <em>Sender</em> that’s created using the Factory Method pattern. We’ll start with a test that ensures that we can generate an appropriate sender via its corresponding factory:</p>
<pre class="sourceCode php"><code class="sourceCode php">
<span class="kw">&lt;?php</span>
<span class="co">// ... code intentionally omitted</span>
    <span class="kw">public</span> <span class="kw">function</span> testFactoryBegetsProduct<span class="ot">()</span> {
        <span class="kw">$fedexFactory</span> = <span class="kw">new</span> FedexFactory<span class="ot">();</span>
        <span class="kw">$fedexProduct</span> = <span class="kw">$fedexFactory</span>-&gt;createSender<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertInstanceOf<span class="ot">(</span><span class="st">&#39;FedexSender&#39;</span><span class="ot">,</span> <span class="kw">$fedexProduct</span><span class="ot">,</span>
            <span class="st">&quot;Should get correct sender from factory&quot;</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertEquals<span class="ot">(</span>SenderTypes::Fedex<span class="ot">,</span> <span class="kw">$fedexProduct</span>-&gt;<span class="fu">getType</span><span class="ot">(),</span>
            <span class="st">&quot;Should be able to call sender&#39;s operations&quot;</span><span class="ot">);</span>
    }
<span class="co">// ... code intentionally omitted</span>
<span class="kw">?&gt;</span></code></pre>
<p>The test above simply confirms that a <q>Fedex Factory</q> should be able to generate a <q>Fedex Sender</q> product. Here’s the implemention…</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>

<span class="co">// Factories</span>
<span class="kw">interface</span> Factory {
    <span class="kw">public</span> <span class="kw">function</span> createSender<span class="ot">();</span>
}
<span class="kw">class</span> FedexFactory <span class="kw">implements</span> Factory {
    <span class="kw">public</span> <span class="kw">function</span> createSender<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">new</span> FedexSender<span class="ot">();</span> 
    }
}
<span class="kw">class</span> SnailMailFactory <span class="kw">implements</span> Factory {
    <span class="kw">public</span> <span class="kw">function</span> createSender<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">new</span> SnailMailSender<span class="ot">();</span> 
    }
}
<span class="kw">class</span> AramexFactory <span class="kw">implements</span> Factory {
    <span class="kw">public</span> <span class="kw">function</span> createSender<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">new</span> AramexSender<span class="ot">();</span> 
    }
}

<span class="co">// Products </span>
<span class="kw">class</span> SenderTypes {
    <span class="kw">const</span> SnailMail = <span class="dv">0</span><span class="ot">;</span>
    <span class="kw">const</span> Fedex = <span class="dv">1</span><span class="ot">;</span>
    <span class="kw">const</span> Aramex = <span class="dv">2</span><span class="ot">;</span>
}
<span class="kw">interface</span> Sender {
    <span class="kw">public</span> <span class="kw">function</span> send<span class="ot">(</span><span class="kw">$destination</span><span class="ot">,</span> <span class="kw">$package</span><span class="ot">);</span>
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">getType</span><span class="ot">();</span>
}
<span class="kw">class</span> FedexSender <span class="kw">implements</span> Sender {
    <span class="kw">public</span> <span class="kw">function</span> send<span class="ot">(</span><span class="kw">$destination</span><span class="ot">,</span> <span class="kw">$package</span><span class="ot">)</span> {
        <span class="fu">echo</span> <span class="ot">(</span><span class="st">&quot;Fedex sending...</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">getType</span><span class="ot">()</span> {
        <span class="kw">return</span> SenderTypes::Fedex<span class="ot">;</span>
    }
}
<span class="kw">class</span> SnailMailSender <span class="kw">implements</span> Sender {
    <span class="kw">public</span> <span class="kw">function</span> send<span class="ot">(</span><span class="kw">$destination</span><span class="ot">,</span> <span class="kw">$package</span><span class="ot">)</span> {
        <span class="fu">echo</span> <span class="ot">(</span><span class="st">&quot;Snail mail sending...</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">getType</span><span class="ot">()</span> {
        <span class="kw">return</span> SenderTypes::SnailMail<span class="ot">;</span>
    }
}
<span class="kw">class</span> AramexSender <span class="kw">implements</span> Sender {
    <span class="kw">public</span> <span class="kw">function</span> send<span class="ot">(</span><span class="kw">$destination</span><span class="ot">,</span> <span class="kw">$package</span><span class="ot">)</span> {
        <span class="fu">echo</span> <span class="ot">(</span><span class="st">&quot;Aramex sending international...</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">getType</span><span class="ot">()</span> {
        <span class="kw">return</span> SenderTypes::Aramex<span class="ot">;</span>
    }
}

<span class="kw">?&gt;</span></code></pre>
<p>With the above code in place, our messenger no longer needs to worry about which type of sender it’s working with; that burden becomes the client’s. For example, if a client wanted to send a package via Fedex it would simply do:</p>
<pre class="sourceCode java"><code class="sourceCode java">$fedexFactory = <span class="kw">new</span> <span class="fu">FedexFactory</span>();
$sender = $fedexFactory-&gt;<span class="fu">createSender</span>();
$sender-&gt;<span class="fu">send</span>($someDestination, $somePackage);</code></pre>
<p>While the client <em>does</em> have to instantiate the factory itself, the product gets created <q>behind the scenes</q>, and is therefore encapsulated.</p>
<h3 id="factory-method-variations"><a href="#TOC">Factory Method Variations</a></h3>
<p>We mentioned earlier that there are two main variations of Factory Method:</p>
<ul>
<li>The sub-class approach</li>
</ul>
<p>The Factory Method is defined in a base abstract class or interface (the Creator), and then overriden by concrete sub-classes (see the above Sender example).</p>
<ul>
<li>Parameterized Factory Method approach</li>
</ul>
<p>In this version, there is generally just one Creator who’s factory method takes a <q>type</q> parameter which is used to determine which type to of object create:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="co">// ... code intentionally omitted</span>
<span class="kw">class</span> SenderFactory {
    <span class="kw">public</span> <span class="kw">function</span> createSender<span class="ot">(</span><span class="kw">$type</span><span class="ot">)</span> {
        <span class="kw">$sender</span> = <span class="kw">null</span><span class="ot">;</span>

        <span class="kw">if</span> <span class="ot">(</span><span class="kw">$type</span> == SenderTypes::Fedex<span class="ot">)</span> {
            <span class="kw">$sender</span> = <span class="kw">new</span> FedexSender<span class="ot">();</span>
        } <span class="kw">else</span> <span class="kw">if</span> <span class="ot">(</span><span class="kw">$type</span> == SenderTypes::Snail<span class="ot">)</span> {
            <span class="kw">$sender</span> = <span class="kw">new</span> SnailMailSender<span class="ot">();</span>
        } <span class="kw">else</span> <span class="kw">if</span> <span class="ot">(</span><span class="kw">$type</span> == SenderTypes::Aramex<span class="ot">)</span> {
            <span class="kw">$sender</span> = <span class="kw">new</span> AramexSender<span class="ot">();</span>
        } <span class="kw">else</span> {
            <span class="co">// An arbitrary default might be snail mail</span>
            <span class="kw">$sender</span> = <span class="kw">new</span> SnailMailSender<span class="ot">();</span>
        }
        <span class="kw">return</span> <span class="kw">$sender</span><span class="ot">;</span>
    }
}
<span class="kw">?&gt;</span></code></pre>
<p>The above conditional would appear to be a flagrant abuse of open/closed principle (as you’ll have to directly modify the SenderFactory as soon as you need to add a new sender type). On the other hand, it might be more straightforward (since we don’t need to create sub-classes). In any event, both variants give us the benefit of <em>encapsulating that which varies</em>.</p>
<h3 id="pitfalls-2"><a href="#TOC">Pitfalls</a></h3>
<h4 id="layers-of-indirection"><a href="#TOC">Layers of indirection:</a></h4>
<p>The sub-class variant requires us to create an inheritance hierarchy which adds some complexity.</p>
<h4 id="conditional-code"><a href="#TOC">Conditional code:</a></h4>
<p>In the parameterized factory method variant we end up with ugly conditional code that violates open/closed principle.</p>
<h4 id="complicated"><a href="#TOC">Complicated:</a></h4>
<p>Using a constructor to create a new object is immediately understandable, whereas, a factory method might not be. This might be helped by standardizing on factory naming conventions throughout your code base.</p>
<h2 id="abstract-factory"><a href="#TOC">Abstract Factory</a></h2>
<p>The <a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">GoF</a> definition for Abstract Factory states that it:</p>
<blockquote>
<p>Provides an interface for creating families of related or dependent objects without specifying their concrete classes.</p>
</blockquote>
<figure>
<img src="img/abstract-factory.png" alt="Abstract Factory"><figcaption>Abstract Factory</figcaption>
</figure>
<ul>
<li>AbstractFactory defines the interface for product creation</li>
<li>ConcreteFactory creates the concrete products</li>
<li>AbstractProduct defines the interface for the product</li>
<li>ConcreteProduct defines the concrete product objects themselves</li>
</ul>
<p><em>It is easy to get confused when trying to diffrentiate the Factory Method and the Abstract Factory; especially, since the Abstract Factory may, in fact, use the Factory Method in its implementation! Try to remember that the primary intent of the Abstract Factory pattern is to allow us to return <q>familes of related objects</q>.</em></p>
<p>We’re going to use the Abstract Factory pattern to model a car factory which allows us to create families of car products. In order to keep things easier to follow, we’ll only worry about creating the engine and passenger compartment components.</p>
<p>Let’s start with some tests. We want to know that when we use a particular concrete factory, we can, in turn, receive the correct corresponding concrete component:</p>
<pre class="sourceCode php"><code class="sourceCode php">
<span class="kw">&lt;?php</span>
<span class="co">// ... code intentionally omitted</span>

    <span class="co">// Abstract Factory - Tests</span>
    <span class="kw">public</span> <span class="kw">function</span> testFactoriesGetCorrectStandardEnginePart<span class="ot">()</span> {
        <span class="kw">$standardCarFactory</span> = <span class="kw">new</span> StandardCarPartsFactory<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertInstanceOf<span class="ot">(</span><span class="st">&#39;CombustionEngine&#39;</span><span class="ot">,</span>
                <span class="kw">$standardCarFactory</span>-&gt;createEngine<span class="ot">(),</span>
                <span class="st">&quot;Standard gets correct CombustionEngine&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testFactoriesGetCorrectMuscleEnginePart<span class="ot">()</span> {
        <span class="kw">$muscleCarFactory</span> = <span class="kw">new</span> MuscleCarPartsFactory<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertInstanceOf<span class="ot">(</span><span class="st">&#39;V8Engine&#39;</span><span class="ot">,</span>
                <span class="kw">$muscleCarFactory</span>-&gt;createEngine<span class="ot">(),</span>
                <span class="st">&quot;Muscle gets correct V8Engine&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testFactoriesGetCorrectHybridEnginePart<span class="ot">()</span> {
        <span class="kw">$hybridCarFactory</span> = <span class="kw">new</span> HybridCarPartsFactory<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertInstanceOf<span class="ot">(</span><span class="st">&#39;HybridEngine&#39;</span><span class="ot">,</span>
                <span class="kw">$hybridCarFactory</span>-&gt;createEngine<span class="ot">(),</span>
                <span class="st">&quot;Hybrid car gets correct HybridEngine&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testGetCorrectStandardPassengerCompartment<span class="ot">()</span> {
        <span class="kw">$standardCarFactory</span> = <span class="kw">new</span> StandardCarPartsFactory<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertInstanceOf<span class="ot">(</span><span class="st">&#39;StandardPassengerCompartment&#39;</span><span class="ot">,</span>
                <span class="kw">$standardCarFactory</span>-&gt;createPassengerCompartment<span class="ot">(),</span>
                <span class="st">&quot;Standard gets correct StandardPassengerCompartment&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testGetCorrectMusclePassengerCompartment<span class="ot">()</span> {
        <span class="kw">$muscleCarFactory</span> = <span class="kw">new</span> MuscleCarPartsFactory<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertInstanceOf<span class="ot">(</span><span class="st">&#39;MusclePassengerCompartment&#39;</span><span class="ot">,</span>
                <span class="kw">$muscleCarFactory</span>-&gt;createPassengerCompartment<span class="ot">(),</span>
                <span class="st">&quot;Muscle car gets correct MusclePassengerCompartment&quot;</span><span class="ot">);</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> testGetCorrectHybridPassengerCompartment<span class="ot">()</span> {
        <span class="kw">$hybridCarFactory</span> = <span class="kw">new</span> HybridCarPartsFactory<span class="ot">();</span>
        <span class="kw">$this</span>-&gt;assertInstanceOf<span class="ot">(</span><span class="st">&#39;HybridPassengerCompartment&#39;</span><span class="ot">,</span>
                <span class="kw">$hybridCarFactory</span>-&gt;createPassengerCompartment<span class="ot">(),</span>
                <span class="st">&quot;Hybrid car gets correct HybridPassengerCompartment&quot;</span><span class="ot">);</span>
    }
<span class="kw">?&gt;</span></code></pre>
<p>And here’s the implementation.</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>

<span class="kw">abstract</span> <span class="kw">class</span> CarPartsFactory {
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> createEngine<span class="ot">();</span>
    <span class="kw">abstract</span> <span class="kw">public</span> <span class="kw">function</span> createPassengerCompartment<span class="ot">();</span>
    <span class="co">// ... Doors, Wheels, etc., etc.</span>
}

<span class="kw">class</span> StandardCarPartsFactory <span class="kw">extends</span> CarPartsFactory {
    <span class="kw">public</span> <span class="kw">function</span> createEngine<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">new</span> CombustionEngine<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> createPassengerCompartment<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">new</span> StandardPassengerCompartment<span class="ot">();</span>
    }
}

<span class="kw">class</span> MuscleCarPartsFactory <span class="kw">extends</span> CarPartsFactory {
    <span class="kw">public</span> <span class="kw">function</span> createEngine<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">new</span> V8Engine<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> createPassengerCompartment<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">new</span> MusclePassengerCompartment<span class="ot">();</span>
    }
}

<span class="kw">class</span> HybridCarPartsFactory <span class="kw">extends</span> CarPartsFactory {
    <span class="kw">public</span> <span class="kw">function</span> createEngine<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">new</span> HybridEngine<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> createPassengerCompartment<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">new</span> HybridPassengerCompartment<span class="ot">();</span>
    }
}

<span class="kw">interface</span> Engine {
    <span class="kw">public</span> <span class="kw">function</span> start<span class="ot">();</span>
    <span class="kw">public</span> <span class="kw">function</span> stop<span class="ot">();</span>
    <span class="kw">public</span> <span class="kw">function</span> accelerate<span class="ot">();</span>
}

<span class="kw">class</span> HybridEngine <span class="kw">implements</span> Engine {
    <span class="kw">public</span> <span class="kw">function</span> start<span class="ot">()</span> {
        <span class="fu">echo</span> <span class="st">&quot;Starting hybrid engine</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">;</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> stop<span class="ot">()</span> {
        <span class="fu">echo</span> <span class="st">&quot;Stopping hybrid engine</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">;</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> accelerate<span class="ot">()</span> {
        <span class="fu">echo</span> <span class="st">&quot;Accelerating hybrid engine</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">;</span>
    }
} 

<span class="kw">class</span> V8Engine <span class="kw">implements</span> Engine {
    <span class="kw">public</span> <span class="kw">function</span> start<span class="ot">()</span> {
        <span class="fu">echo</span> <span class="st">&quot;Starting V8 engine</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">;</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> stop<span class="ot">()</span> {
        <span class="fu">echo</span> <span class="st">&quot;Stopping V8 engine</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">;</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> accelerate<span class="ot">()</span> {
        <span class="fu">echo</span> <span class="st">&quot;Accelerating V8 engine</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">;</span>
    }
} 

<span class="kw">class</span> CombustionEngine <span class="kw">implements</span> Engine {
    <span class="kw">public</span> <span class="kw">function</span> start<span class="ot">()</span> {
        <span class="fu">echo</span> <span class="st">&quot;Starting Combustion engine</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">;</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> stop<span class="ot">()</span> {
        <span class="fu">echo</span> <span class="st">&quot;Stopping Combustion engine</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">;</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> accelerate<span class="ot">()</span> {
        <span class="fu">echo</span> <span class="st">&quot;Accelerating Combustion engine</span><span class="kw">\n</span><span class="st">&quot;</span><span class="ot">;</span>
    }
} 

<span class="kw">interface</span> PassengerCompartment {}
<span class="kw">class</span> StandardPassengerCompartment <span class="kw">implements</span> PassengerCompartment {}
<span class="kw">class</span> HybridPassengerCompartment <span class="kw">implements</span> PassengerCompartment {}
<span class="kw">class</span> MusclePassengerCompartment <span class="kw">implements</span> PassengerCompartment {}
<span class="kw">?&gt;</span></code></pre>
<p>With the above in place, client code can simply instantiate the desired factory, and then use that instance to create the parts as needed:</p>
<pre class="sourceCode php"><code class="sourceCode php">$factory = new MuscleCarPartsFactory();
$this-&gt;engine = $factory-&gt;createEngine(); 
$this-&gt;interior = $factory-&gt;createPassengerCompartment();
// ... and so on</code></pre>
<p>An alternative is create a <q>product</q> class that uses the factory to generate a <em>fully built product</em>. In the following we create a Car class that takes a parts factory in its constructor, and then, essentially, builds itself:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="kw">class</span> Car {
    <span class="kw">protected</span> <span class="kw">$engine</span> = <span class="kw">null</span><span class="ot">;</span>
    <span class="kw">protected</span> <span class="kw">$passengerCompartment</span> = <span class="kw">null</span><span class="ot">;</span>

    <span class="kw">public</span> <span class="kw">function</span> <span class="fu">__construct</span><span class="ot">(</span>CarPartsFactory <span class="kw">$partsFactory</span><span class="ot">)</span> {
        <span class="kw">$this</span>-&gt;engine = <span class="kw">$partsFactory</span>-&gt;createEngine<span class="ot">();</span>  
        <span class="kw">$this</span>-&gt;passengerCompartment = 
            <span class="kw">$partsFactory</span>-&gt;createPassengerCompartment<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> start<span class="ot">()</span> {
        <span class="kw">$this</span>-&gt;engine-&gt;start<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> stop<span class="ot">()</span> {
        <span class="kw">$this</span>-&gt;engine-&gt;stop<span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> accelerate<span class="ot">()</span> {
        <span class="kw">$this</span>-&gt;engine-&gt;accelerate<span class="ot">();</span>
    }
    <span class="kw">protected</span> <span class="kw">function</span> __ensureBuilt<span class="ot">()</span> {
        <span class="kw">if</span> <span class="ot">(</span><span class="kw">$this</span>-&gt;engine == <span class="kw">null</span><span class="ot">)</span> {
            <span class="kw">$this</span>-&gt;build<span class="ot">();</span>
        }
    }
    <span class="kw">public</span> <span class="kw">function</span> getEngine<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;engine<span class="ot">;</span>
    }
    <span class="kw">public</span> <span class="kw">function</span> getPassengerCompartment<span class="ot">()</span> {
        <span class="kw">return</span> <span class="kw">$this</span>-&gt;passengerCompartment<span class="ot">;</span>
    }
}
<span class="kw">?&gt;</span></code></pre>
<p><em>Allowing a Car class to essentially build itself, does add a creational responsibility to Car; but given that all objects that implement a constructor are, in essence, intializing themselves, we’d argue this hasn’t really weakened cohesion.</em></p>
<p>In this arrangement, we have the Car’s constructor taking the CarPartsFactory in its constructor (letting clients be burdened with deciding which type of car parts factory to use). This is called <a href="http://www.jamesshore.com/Blog/Dependency-Injection-Demystified.html">Dependency Injection</a>. Please do not confuse <em>injection</em> with <em>inversion</em> as it’s so easy to do (see <a href="http://lostechies.com/derickbailey/2011/09/22/dependency-injection-is-not-the-same-as-the-dependency-inversion-principle/">Dependency Injection Is NOT The Same As The Dependency Inversion Principle</a>).</p>
<p>By allowing client code to inject the <q>depended on component</q> (<a href="http://xunitpatterns.com/DOC.html">DOC</a>), we are afforded more flexibility in our tests (since our tests can create these depended on components and <q>pass them in</q>):</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
    <span class="kw">public</span> <span class="kw">function</span> testCarPartsFactoryCreateEngineCalled<span class="ot">()</span> {
        <span class="kw">$hybridEngine</span> = <span class="kw">new</span> HybridEngine<span class="ot">();</span>
        <span class="kw">$factoryStub</span> = <span class="kw">$this</span>-&gt;getMock<span class="ot">(</span><span class="st">&#39;HybridCarPartsFactory&#39;</span><span class="ot">);</span>
        <span class="kw">$factoryStub</span>-&gt;expects<span class="ot">(</span><span class="kw">$this</span>-&gt;once<span class="ot">())</span>
             -&gt;method<span class="ot">(</span><span class="st">&#39;createEngine&#39;</span><span class="ot">)</span>
             -&gt;will<span class="ot">(</span><span class="kw">$this</span>-&gt;returnValue<span class="ot">(</span><span class="kw">$hybridEngine</span><span class="ot">));</span>
        <span class="co">// Here we &quot;inject&quot; Car with a factory</span>
        <span class="kw">$car</span> = <span class="kw">new</span> Car<span class="ot">(</span><span class="kw">$factoryStub</span><span class="ot">);</span>
        <span class="kw">$car</span>-&gt;start<span class="ot">();</span>
    }
<span class="co">// ... code intentionally omitted</span>
<span class="kw">?&gt;</span></code></pre>
<p>In the above test, we are able to create a <a href="http://en.wikipedia.org/wiki/Mock_object">mock object</a>, which takes place of the hybrid factory, and confirm that it in fact gets called from within the Car’s constructor.</p>
<h3 id="pitfalls-3"><a href="#TOC">Pitfalls</a></h3>
<h4 id="adding-new-components"><a href="#TOC">Adding new components:</a></h4>
<p>The biggest issue with the Abstract Factory is that anytime you want to add an additional component, you will have to modify your factory and component code as such. For example, if we add a <q>createWheels</q> method, look at the hoops we must jump through:</p>
<ul>
<li>Add the new wheels component:
<ul>
<li>Add new abstract wheel product</li>
<li>Add new wheel implementation</li>
</ul></li>
<li>Add a <q>createWheels</q> to our abstract factory</li>
<li>Add a <q>createWheels</q> to <em>all</em> derived concrete factories: StandardCarPartsFactory, HybridCarPartsFactory, MuscleCarPartsFactory</li>
</ul>
<p>This is tedious at best. Also, since we’re having to reopen our code, we cannot assert conformance to the open/closed principle.</p>
<h4 id="complexity"><a href="#TOC">Complexity:</a></h4>
<p>Perhaps your reaction to the Car example above was, <q>Wow, that’s a lot of code there!</q>. We’d agree, and this is arguably another disadvantage of the Abstract Factory—the sheer number of classes involved. Imagine how complicated things will become when we start adding all the common car components you’d expect like the transmission, drive train, break system, wheels, doors, etc.</p>
<h2 id="static-factory"><a href="#TOC">Static Factory</a></h2>
<p>There is another way in which we may supply factory-like functionality which is not an official design pattern per se, but useful all the same. Joshua Bloch calls it a <em>static factory method</em>. In <a href="http://www.amazon.com/Effective-Java-2nd-Joshua-Bloch/dp/0321356683">Effective Java</a>, he describes this as simply:</p>
<blockquote>
<p>a static method that returns an instance of the class.</p>
</blockquote>
<p>He goes on to provide some advantages of static factories:</p>
<ul>
<li>they have descriptive names, unlike constructors</li>
<li>whereas a class can only have a single constructor with a given signature, you can have as many static factories as needed</li>
<li>they don’t have to create new objects each time called</li>
<li>they can return subtypes</li>
</ul>
<p>He goes on to provide an example of how a <em>service provider framework</em> might supply a mechanism for registering alternative implementations via a well-known <em>properties file</em> (similar to what <a href="http://pragprog.com/book/tpp/the-pragmatic-programmer">the Pragmatic Programmers</a> might call a <em>metadata-driven approach</em>). Using this metadata-driven approach, a client passes in a key to the provider framework’s static factory method, which is then used to look up and instantiate the appropriate class. The following is a variation on this theme:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
<span class="co">// ... code intentionally omitted</span>

    <span class="co">// Tests</span>
    <span class="kw">public</span> <span class="kw">function</span> testGetDefinedInstance<span class="ot">()</span> {
        <span class="kw">$returnedInstance</span> = ProviderFramework::getInstance<span class="ot">(</span><span class="st">&quot;moduleA&quot;</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertInstanceOf<span class="ot">(</span><span class="st">&#39;ModuleA&#39;</span><span class="ot">,</span> <span class="kw">$returnedInstance</span><span class="ot">,</span>
            <span class="st">&quot;Should get the correct instance&quot;</span><span class="ot">);</span>
    }

    <span class="kw">public</span> <span class="kw">function</span> testGetUndefinedInstanceReturnsDefault<span class="ot">()</span> {
        <span class="kw">$returnedInstance</span> = ProviderFramework::getInstance<span class="ot">(</span><span class="st">&quot;bogus&quot;</span><span class="ot">);</span>
        <span class="kw">$this</span>-&gt;assertInstanceOf<span class="ot">(</span><span class="st">&#39;DefaultModule&#39;</span><span class="ot">,</span> <span class="kw">$returnedInstance</span><span class="ot">,</span>
            <span class="st">&quot;Should fall back to a default instance if undefined key&quot;</span><span class="ot">);</span>
    }

<span class="co">// ... code intentionally omitted</span>

<span class="co">// Provider Framework - Implementation</span>
<span class="kw">class</span> Metadata {
    <span class="kw">public</span> <span class="kw">function</span> getModules<span class="ot">()</span> {
        <span class="co">// Let&#39;s imagine that in a &quot;real system&quot; we&#39;d be getting</span>
        <span class="co">// these from a known metadata configuration file.</span>
        <span class="kw">return</span> <span class="fu">array</span><span class="ot">(</span> 
            <span class="st">&quot;moduleA&quot;</span> =&gt; <span class="st">&quot;ModuleA&quot;</span><span class="ot">,</span>
            <span class="st">&quot;moduleB&quot;</span> =&gt; <span class="st">&quot;ModuleB&quot;</span><span class="ot">,</span>
        <span class="ot">);</span>
    }   
}

<span class="kw">class</span> DefaultModule {
}
<span class="kw">class</span> ModuleA {
}
<span class="kw">class</span> ModuleB {
}

<span class="kw">class</span> ProviderFramework {
    <span class="kw">private</span> <span class="kw">static</span> <span class="kw">$modules</span> = <span class="kw">null</span><span class="ot">;</span>

    <span class="kw">private</span> <span class="kw">static</span> <span class="kw">function</span> initMetadata<span class="ot">()</span> {
        <span class="kw">if</span> <span class="ot">(</span><span class="kw">self</span>::<span class="kw">$modules</span> == <span class="kw">null</span><span class="ot">)</span> {
            <span class="kw">$meta</span> = <span class="kw">new</span> Metadata<span class="ot">();</span>
            <span class="kw">self</span>::<span class="kw">$modules</span> = <span class="kw">$meta</span>-&gt;getModules<span class="ot">();</span>
        }
    }
    
    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">function</span> getInstance<span class="ot">(</span><span class="kw">$key</span><span class="ot">)</span> {
        <span class="kw">self</span>::initMetadata<span class="ot">();</span>
        <span class="kw">if</span> <span class="ot">(</span>!<span class="fu">isset</span><span class="ot">(</span><span class="kw">self</span>::<span class="kw">$modules</span><span class="ot">[</span><span class="kw">$key</span><span class="ot">]))</span> {
            <span class="kw">return</span> <span class="kw">new</span> DefaultModule<span class="ot">();</span>
        }
        <span class="kw">$klass</span> = <span class="kw">self</span>::<span class="kw">$modules</span><span class="ot">[</span><span class="kw">$key</span><span class="ot">];</span>
        <span class="kw">return</span> <span class="kw">new</span> <span class="kw">$klass</span><span class="ot">();</span>
    }
    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">function</span> <span class="fu">reset</span><span class="ot">()</span> {
        <span class="kw">self</span>::<span class="kw">$modules</span> = <span class="kw">null</span><span class="ot">;</span>
    }
}

<span class="kw">?&gt;</span></code></pre>
<h3 id="pitfalls-4"><a href="#TOC">Pitfalls</a></h3>
<p>Some disadvantages of the static factory approach are:</p>
<ul>
<li>we cannot subclass (due to the private constructor)</li>
<li>they’re not distinguishable from other static methods</li>
</ul>
<h2 id="final-thoughts"><a href="#TOC">Final Thoughts</a></h2>
<p>In this chapter we’ve presented three patterns to help aid in object creation (well, actually two patterns and one idiom—<em>static factory</em> isn’t really an <q>official pattern</q>). These patterns can help you to maintain cohesion in your modules, pushing any creational responsibility to encapsulated factories.</p>
<h1 id="singleton-pattern"><a href="#TOC">Singleton Pattern</a></h1>
<h2 id="overview-3"><a href="#TOC">Overview</a></h2>
<p>The Singleton pattern provides a means of ensuring that only one instance of a particular class is created. This is generally achieved by marking the constructor of that class as private, and then providing a public method that returns the one shared instance (e.g. <q>getInstance</q>).</p>
<p>Singletons may be applicable when:</p>
<blockquote>
<p><q>there must be exactly one instance of a class, and it must be accessible to clients from a well-known access point</q>—<a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">Gang of Four</a></p>
</blockquote>
<p>Singletons are probably the most controversial of the design patterns, bringing the following concerns:</p>
<ul>
<li>Meaningful unit testing becomes far more difficult</li>
</ul>
<p>If the system under test uses one or many singleton objects, it becomes hard to test that system in an isolated manner. Generally, it is advised to use <a href="http://www.jamesshore.com/Blog/Dependency-Injection-Demystified.html">dependency injection</a> instead.</p>
<ul>
<li>Global state</li>
</ul>
<p>While the issue of multi-threaded applications creating duplicate singletons can be circumnavigated by using <em>synchronized methods</em> or <q>eager instantiation</q>, the global state introduced by this pattern greatly <a href="http://en.wikipedia.org/wiki/Singleton_pattern#Drawbacks"><q>reduces the chance of parallelism within a program</q></a>.</p>
<p>Despite this controversy, we’ve decided to write this short chapter on Singletons, since you’ll likely encounter them in many projects and need to, at least, be familiar with how they work. That said, definitely think thrice before adding Singeltons to your project, and, perhaps read these posts first:</p>
<ul>
<li><a href="http://misko.hevery.com/code-reviewers-guide/" title="Guide: Writing Testable Code">Guide: Writing Testable Code</a></li>
<li><a href="http://scientificninja.com/blog/performant-singletons" title="Performant Singletons">Performant Singletons</a></li>
</ul>
<h2 id="implementation"><a href="#TOC">Implementation</a></h2>
<p>So you’ve read the <q>warning labels</q> and still want to see how this is implemented; well, with much trepidation, we present the Singleton pattern:</p>
<pre class="sourceCode java"><code class="sourceCode java">
<span class="kw">public</span> <span class="kw">class</span> Singleton {

    <span class="co">// Here we&#39;ve &quot;eager-initialized&quot; our Singleton instance.</span>
    <span class="co">// Using a synchronized getInstance or double locking are</span>
    <span class="co">// other options.</span>
    <span class="kw">private</span> <span class="dt">final</span> <span class="dt">static</span> Singleton instance = <span class="kw">new</span> <span class="fu">Singleton</span>();

    <span class="kw">private</span> <span class="fu">Singleton</span> () {}
    
    <span class="kw">public</span> <span class="dt">static</span> Singleton <span class="fu">getInstance</span>() {
        <span class="kw">return</span> instance;
    }
}

<span class="co">// ... code intentionally omitted</span>

    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testCreateSingleton</span>() {       
        <span class="fu">assertSame</span>(Singleton.<span class="fu">getInstance</span>(), Singleton.<span class="fu">getInstance</span>());
    }</code></pre>
<h1 id="builder-pattern"><a href="#TOC">Builder Pattern</a></h1>
<h2 id="overview-4"><a href="#TOC">Overview</a></h2>
<p>The Builder design pattern provides a way to:</p>
<blockquote>
<p>separate the construction of a complex object from its representation so that the same construction process can create different representations.—<a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">Gang of Four</a></p>
</blockquote>
<p>The Builder pattern is a creational pattern that allows for abstracting the creation of related but complex objects; this is done by utilizing concrete builders that independently construct and assemble products as appropriate.</p>
<figure>
<img src="img/builder-class.png" alt="Builder Pattern"><figcaption>Builder Pattern</figcaption>
</figure>
<h2 id="participants-and-collaborations"><a href="#TOC">Participants and Collaborations</a></h2>
<p>The participants in Builder are:</p>
<ul>
<li><strong>Builder:</strong> Provides an interface for building parts of the complex object</li>
<li><strong>ConcreteBuilder:</strong> Assembles the parts that make up the object</li>
<li><strong>Director:</strong> Builds complex objects by delegating to the Builder</li>
<li><strong>Product:</strong> Represents the complex object being constructed</li>
</ul>
<figure>
<img src="img/builder-sequence.png" alt="Builder Sequence Diagram"><figcaption>Builder Sequence Diagram</figcaption>
</figure>
<p>The assembly of the product involves the following collaborations:</p>
<ul>
<li>Client creates Builder and Director objects (injecting Director with Builder)</li>
<li>Client calls <em>construct</em> (or similar) on Director</li>
<li>Director calls appropriate series of Builder <em>build</em> operations</li>
<li>Director calls get<Product Name> on the Builder getting the fully assembled product.</li>
</ul>
<h2 id="implementation-1"><a href="#TOC">Implementation</a></h2>
<p>Imagine the following <em>happy hour</em> scenario:</p>
<ul>
<li>You order a drink from a waitress at a pub</li>
<li>The Waitress (the <em>Director</em>), takes down your order</li>
<li>She then asks the Bartender (the <em>Builder</em>) to prepare your drinks</li>
<li>Once the drinks are ready, she puts them on her tray, walks over and serves them to you</li>
</ul>
<p>If you think about it, the above happy hour scenario is really quite similar to how Builder pattern works. Let’s, in fact, put this example to code…first we’ll start with the tests:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">
<span class="co">// Install node.js, npm, mocha.js, and sinon.js:</span>
<span class="co">// $ npm install -g mocha</span>
<span class="co">// $ npm install sinon</span>
<span class="co">// $ mocha --ignore-leaks</span>
<span class="kw">var</span> sinon, assert, 
    IBartender, Bartender, Waitress, DrinkMenu;

assert = require(<span class="ch">&#39;assert&#39;</span>);
sinon = require(<span class="ch">&#39;sinon&#39;</span>);
IBartender = require(<span class="st">&quot;../builder.js&quot;</span>).<span class="fu">IBartender</span>;
Bartender = require(<span class="st">&quot;../builder.js&quot;</span>).<span class="fu">Bartender</span>;
Waitress = require(<span class="st">&quot;../builder.js&quot;</span>).<span class="fu">Waitress</span>;
DrinkMenu = require(<span class="st">&quot;../builder.js&quot;</span>).<span class="fu">DrinkMenu</span>;

describe(<span class="st">&quot;Builder tests&quot;</span>, <span class="kw">function</span>() {
    <span class="kw">var</span> bartender, waitress;
    beforeEach(<span class="kw">function</span>() {
        bartender = <span class="kw">new</span> Bartender();
        waitress = <span class="kw">new</span> Waitress(bartender, DrinkMenu);
    });
    afterEach (<span class="kw">function</span>() {
        bartender = null;
        waitress = null;
    });

    it(<span class="st">&quot;should take an order for mojito&quot;</span>, <span class="kw">function</span>() {
        <span class="kw">var</span> spy = <span class="kw">sinon</span>.<span class="fu">spy</span>(bartender, <span class="st">&quot;prepareMojito&quot;</span>);
        <span class="kw">waitress</span>.<span class="fu">takeOrder</span>([<span class="kw">DrinkMenu</span>.<span class="fu">mojito</span>]);
        assert(<span class="kw">spy</span>.<span class="fu">called</span>);
        <span class="kw">bartender.prepareMojito</span>.<span class="fu">restore</span>();
    });

    it(<span class="st">&quot;should take order for all drinks on menu&quot;</span>, <span class="kw">function</span>() {
        <span class="kw">var</span> allDrinks=[], 
            key, 
            allSpies={};

        <span class="co">// Spy on each of the Bartender&#39;s prepareXXX methods</span>
        <span class="kw">for</span>(key <span class="kw">in</span> DrinkMenu) {
            allSpies[key] = <span class="kw">sinon</span>.<span class="fu">spy</span>(bartender, DrinkMenu[key]);
            <span class="kw">allDrinks</span>.<span class="fu">push</span>(DrinkMenu[key]);
        }

        <span class="kw">waitress</span>.<span class="fu">takeOrder</span>(allDrinks);

        <span class="co">// Assert Bartender&#39;s prepareXXX methods called; restore</span>
        <span class="kw">for</span>(key <span class="kw">in</span> allSpies) {
            assert(allSpies[key].<span class="fu">called</span>);
        }
        <span class="kw">for</span>(key <span class="kw">in</span> DrinkMenu) {
            bartender[DrinkMenu[key]].<span class="fu">restore</span>();
        }
    });

    it(<span class="st">&quot;should only take Array of valid drink types&quot;</span>, <span class="kw">function</span>() {
        <span class="kw">var</span> result;
        result = <span class="kw">waitress</span>.<span class="fu">takeOrder</span>(<span class="st">&quot;invalid type&quot;</span>);
        <span class="kw">assert</span>.<span class="fu">equal</span>(null, result);
        result = <span class="kw">waitress</span>.<span class="fu">takeOrder</span>([<span class="ch">&#39;not_a_drink!&#39;</span>]);
        <span class="kw">assert</span>.<span class="fu">equal</span>(null, result);
        result = <span class="kw">waitress</span>.<span class="fu">takeOrder</span>([<span class="kw">DrinkMenu</span>.<span class="fu">mai</span>_<span class="fu">tai</span>,
                                    <span class="ch">&#39;not_a_drink!&#39;</span>,
                                    <span class="kw">DrinkMenu</span>.<span class="fu">pina</span>_<span class="fu">colada</span>]);
        <span class="kw">assert</span>.<span class="fu">equal</span>(null, result);
        result = <span class="kw">waitress</span>.<span class="fu">takeOrder</span>(undefined);
        <span class="kw">assert</span>.<span class="fu">equal</span>(null, result);
        result = <span class="kw">waitress</span>.<span class="fu">takeOrder</span>(null);
        <span class="kw">assert</span>.<span class="fu">equal</span>(null, result);
    });
    it(<span class="st">&quot;should return correct number of drinks&quot;</span>, <span class="kw">function</span>() {
        <span class="kw">var</span> drinksServed =
            <span class="kw">waitress</span>.<span class="fu">takeOrder</span>([<span class="kw">DrinkMenu</span>.<span class="fu">mojito</span>,
                                <span class="kw">DrinkMenu</span>.<span class="fu">mai</span>_<span class="fu">tai</span>]);
        <span class="kw">assert</span>.<span class="fu">equal</span>(<span class="dv">2</span>, <span class="kw">drinksServed</span>.<span class="fu">length</span>);
    });     
    it(<span class="st">&quot;should allow duplicate drinks to be ordered&quot;</span>, <span class="kw">function</span>() {
        <span class="kw">var</span> drinksServed =
            <span class="kw">waitress</span>.<span class="fu">takeOrder</span>([<span class="kw">DrinkMenu</span>.<span class="fu">mojito</span>,
                                <span class="kw">DrinkMenu</span>.<span class="fu">mai</span>_<span class="fu">tai</span>,
                                <span class="kw">DrinkMenu</span>.<span class="fu">mai</span>_<span class="fu">tai</span>,
                                <span class="kw">DrinkMenu</span>.<span class="fu">margarita</span>,
                                <span class="kw">DrinkMenu</span>.<span class="fu">mai</span>_<span class="fu">tai</span>]);
        <span class="kw">assert</span>.<span class="fu">equal</span>(<span class="dv">5</span>, <span class="kw">drinksServed</span>.<span class="fu">length</span>);
    });
});</code></pre>
<h3 id="implementation-2"><a href="#TOC">Implementation</a></h3>
<p>And here’s our implementation:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> DrinkMenu = {
    <span class="dt">beer</span>: <span class="st">&quot;prepareBeer&quot;</span>,
    <span class="dt">mojito</span>: <span class="st">&quot;prepareMojito&quot;</span>,
    <span class="dt">kamikaze</span>: <span class="st">&quot;prepareKamikaze&quot;</span>,
    <span class="dt">margarita</span>: <span class="st">&quot;prepareMargarita&quot;</span>,
    <span class="dt">mai_tai</span>: <span class="st">&quot;prepareMaiTai&quot;</span>,
    <span class="dt">pina_colada</span>: <span class="st">&quot;preparePinaColada&quot;</span>
};

<span class="kw">var</span> IBartender = <span class="kw">function</span>() {};
<span class="kw">IBartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">mojito</span>] = <span class="kw">function</span>() {
    <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
};
<span class="kw">IBartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">kamikaze</span>] = <span class="kw">function</span>() {
    <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
};
<span class="kw">IBartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">mai</span>_<span class="fu">tai</span>] = <span class="kw">function</span>() {
    <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
};
<span class="kw">IBartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">margarita</span>] = <span class="kw">function</span>() {
    <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
};
<span class="kw">IBartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">beer</span>] = <span class="kw">function</span>() {
    <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
};
<span class="kw">IBartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">pina</span>_<span class="fu">colada</span>] = <span class="kw">function</span>() {
    <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
};


<span class="kw">var</span> Bartender = <span class="kw">function</span>() {
    <span class="kw">this</span>.<span class="fu">drinks</span> = [];   
};
<span class="kw">Bartender</span>.<span class="fu">prototype</span> = <span class="kw">new</span> IBartender(); 
<span class="kw">Bartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">beer</span>] = <span class="kw">function</span>() {
    <span class="kw">this</span>.<span class="fu">drinks</span>.<span class="fu">push</span>(<span class="st">&quot;Beer&quot;</span>);
};
<span class="kw">Bartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">mojito</span>] = <span class="kw">function</span>() {
    <span class="kw">this</span>.<span class="fu">drinks</span>.<span class="fu">push</span>(<span class="st">&quot;Mojito&quot;</span>);
};
<span class="kw">Bartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">kamikaze</span>] = <span class="kw">function</span>() {
    <span class="kw">this</span>.<span class="fu">drinks</span>.<span class="fu">push</span>(<span class="st">&quot;Kamikaze&quot;</span>);
};
<span class="kw">Bartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">mai</span>_<span class="fu">tai</span>] = <span class="kw">function</span>() {
    <span class="kw">this</span>.<span class="fu">drinks</span>.<span class="fu">push</span>(<span class="st">&quot;Mai Tai&quot;</span>);
};
<span class="kw">Bartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">margarita</span>] = <span class="kw">function</span>() {
    <span class="kw">this</span>.<span class="fu">drinks</span>.<span class="fu">push</span>(<span class="st">&quot;Margarita&quot;</span>);
};
<span class="kw">Bartender</span>.<span class="fu">prototype</span>[<span class="kw">DrinkMenu</span>.<span class="fu">pina</span>_<span class="fu">colada</span>] = <span class="kw">function</span>() {
    <span class="kw">this</span>.<span class="fu">drinks</span>.<span class="fu">push</span>(<span class="st">&quot;Pina Colada&quot;</span>);
};
<span class="kw">Bartender.prototype</span>.<span class="fu">ordersUp</span> = <span class="kw">function</span>() {
    <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">drinks</span>;
};


<span class="kw">var</span> Waitress = <span class="kw">function</span>(bartender, menu) {
    <span class="kw">this</span>.<span class="fu">bartender</span> = bartender;
    <span class="kw">this</span>.<span class="fu">menu</span> = menu;
};

<span class="co">// Precondition: drinks elements must be valid DrinkMenu items </span>
<span class="kw">Waitress.prototype</span>.<span class="fu">takeOrder</span> = <span class="kw">function</span>(drinks) {
    <span class="kw">var</span> i, order = [], self = <span class="kw">this</span>;

    <span class="kw">function</span> isBartenderFunction(key) {
        <span class="kw">return</span> <span class="kw">typeof</span> <span class="kw">self</span>.<span class="fu">bartender</span>[key]===<span class="st">&quot;function&quot;</span>;
    }

    <span class="kw">if</span>(<span class="kw">Array</span>.<span class="fu">isArray</span>(drinks)) {
        <span class="kw">for</span> (i = <span class="dv">0</span>; i &lt; <span class="kw">drinks</span>.<span class="fu">length</span>; i++) {
            <span class="kw">if</span> (isBartenderFunction(drinks[i])) {
                <span class="kw">order</span>.<span class="fu">push</span>(<span class="kw">self</span>.<span class="fu">bartender</span>[drinks[i]]());
            } <span class="kw">else</span> {
                <span class="kw">return</span> null;
            }
        }
        <span class="kw">return</span> (<span class="kw">order</span>.<span class="fu">length</span>) ? <span class="kw">self.bartender</span>.<span class="fu">ordersUp</span>() : null;
    }
    <span class="kw">return</span> null;
};

<span class="kw">module.exports</span>.<span class="fu">IBartender</span> = IBartender;
<span class="kw">module.exports</span>.<span class="fu">Bartender</span> = Bartender;
<span class="kw">module.exports</span>.<span class="fu">Waitress</span> = Waitress;
<span class="kw">module.exports</span>.<span class="fu">DrinkMenu</span> = DrinkMenu;</code></pre>
<h2 id="pitfalls-5"><a href="#TOC">Pitfalls</a></h2>
<p>The BuilderPattern doesn’t seem to commit many flagrant violations of object-oriented principles. However, as with most design patterns, it does add some complexity. Also, there is a more modern version of Builder pattern that you’ll see that uses <a href="http://en.wikipedia.org/wiki/Fluent_interface">Fluent Interfaces</a>, but this is beyond the scope of this chapter. <a href="http://www.dzone.com/links/r/the_builder_pattern_in_practice.html">Here’s an interesting article</a> if you’d like to learn more about that approach.</p>
<h2 id="summary-1"><a href="#TOC">Summary</a></h2>
<p>The Builder pattern allows us to decouple our client code from the construction of complex objects. It can be used to make our code more testable. For example, if we have an object with a <a href="http://misko.hevery.com/code-reviewers-guide/flaw-constructor-does-real-work/"><q>busy constructor</q></a>(a constructor doing object instantiation; a big testability no no!), one option we have is to refactor to have the constructor take a builder object. It can then use the builder’s operations to initialize its member variables. This is really an alternative form of constructor <a href="http://www.jamesshore.com/Blog/Dependency-Injection-Demystified.html">dependency injection</a>, a technique that allows test code to control how an object under test’s dependents are constructed.</p>
<h1 id="command-pattern"><a href="#TOC">Command Pattern</a></h1>
<figure>
<img src="img/command-class.png" alt="Command Pattern"><figcaption>Command Pattern</figcaption>
</figure>
<h2 id="overview-5"><a href="#TOC">Overview</a></h2>
<p>The Command pattern is used to:</p>
<blockquote>
<p><q>Encapsulate a request as an object, thereby letting you parameterize clients with different requests, queue or log requests, and support undoable operations.</q>—<a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">Gang of Four</a></p>
</blockquote>
<p>Command is a behavioural pattern that decouples objects that invoke behaviour from objects that actually carry out those behaviours. Appropriately, we have an <em>Invoker</em> object that requests some behaviour, and a <em>Receiver</em> object that actually carries out that behaviour.</p>
<p>In the case of the Command pattern, however, the Invoker does not know nor communicate with the receiver directly—instead, it calls a Command object’s <em>execute</em> method, which takes care of invoking the receiver; the receiever then carries out the desired behaviour.</p>
<p>The command object is what decouples the invoker and receiver objects and provides the following benefits:</p>
<ul>
<li><p>The invoker needn’t know about the receiever’s interface</p></li>
<li><p>The behavior may be carried out asynchronously</p></li>
</ul>
<p>The defining characteristics of the command object are:</p>
<ul>
<li><p>an <em>execute</em> operation</p></li>
<li><p>a reference to a <em>Receiver</em> that has code to fulfil the request</p></li>
</ul>
<p>There are variations of command pattern that add functionality like <em>undo</em> and <em>batch commands</em>. We will look at some of these later in this chapter.</p>
<h3 id="implementation-3"><a href="#TOC">Implementation</a></h3>
<figure>
<img src="img/command-sequence.png" alt="Command Sequence Diagram"><figcaption>Command Sequence Diagram</figcaption>
</figure>
<p>The above sequence diagram should be fairly self-evident:</p>
<ul>
<li>a Client creates a Command Object, injecting it with a Receiever</li>
<li>the Client stores this <q>command object</q> on the Invoker</li>
<li>some period of time elapses</li>
<li>the Invoker calls <em>execute</em> on the Command Object</li>
<li>the Command Object, in turn, calls <em>action</em> on the Receiever</li>
</ul>
<h3 id="the-very-simplest-command-pattern-implementation"><a href="#TOC">The <q>Very Simplest</q> Command Pattern Implementation</a></h3>
<p>Before we do something useful with the Command pattern, let’s first create a <q>vanilla</q> Command implementation. As we’ve described, the core collaborations happen when the Invoker decides to trigger the Command’s <em>execute</em> or <em>undo</em> method. Let’s <em>Mock</em> the Receiver object and simply ensure that its appropriate operations get called:</p>
<pre class="sourceCode java"><code class="sourceCode java">
<span class="kw">import static org.junit.Assert.*;</span>

<span class="kw">import org.junit.After;</span>
<span class="kw">import org.junit.Before;</span>
<span class="kw">import org.junit.Test;</span>

<span class="co">// http://docs.mockito.googlecode.com/hg/org/mockito/Mockito.html</span>
<span class="kw">import static org.mockito.Mockito.*;</span>

<span class="kw">public</span> <span class="kw">class</span> CommandTests {

    <span class="kw">private</span> Invoker invoker;
    <span class="kw">private</span> Receiver mockReceiver;
    <span class="kw">private</span> Command command;

    @Before
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setUp</span>() <span class="kw">throws</span> Exception {
        <span class="kw">this</span>.<span class="fu">mockReceiver</span> = <span class="fu">mock</span>(Receiver.<span class="fu">class</span>);
        <span class="kw">this</span>.<span class="fu">command</span> = <span class="kw">new</span> <span class="fu">ConcreteCommand</span>(<span class="kw">this</span>.<span class="fu">mockReceiver</span>);
        <span class="kw">this</span>.<span class="fu">invoker</span> = <span class="kw">new</span> <span class="fu">Invoker</span>();
        <span class="kw">this</span>.<span class="fu">invoker</span>.<span class="fu">setCommand</span>(<span class="kw">this</span>.<span class="fu">command</span>);
    }

    @After
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">tearDown</span>() <span class="kw">throws</span> Exception {
        <span class="kw">this</span>.<span class="fu">command</span> = <span class="kw">null</span>;
        <span class="kw">this</span>.<span class="fu">invoker</span> = <span class="kw">null</span>;
        <span class="kw">this</span>.<span class="fu">mockReceiver</span> = <span class="kw">null</span>;
    }

    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testCommandCallsReceiver</span>() {
        <span class="co">// Test acting as &quot;client&quot; for now</span>
        <span class="kw">this</span>.<span class="fu">invoker</span>.<span class="fu">action</span>();
        <span class="fu">verify</span>(<span class="kw">this</span>.<span class="fu">mockReceiver</span>, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">doSomething</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testUndo</span>() {
        <span class="kw">this</span>.<span class="fu">invoker</span>.<span class="fu">undo</span>();
        <span class="fu">verify</span>(<span class="kw">this</span>.<span class="fu">mockReceiver</span>, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">undoSomething</span>();
    }

}</code></pre>
<p>The above tests are <em>code smells</em> since there’s no clear <em>system under test</em> (we’re asserting the our Receiver mock gets called as the result of invoking the Invoker; but Invoker, in turn, depends on ConcreteCommand. Generally, we should not mock dependents more then one level deep). Since our tests are merely acting as a confirmation that the pattern is working as we expect, we won’t bother refactoring. The tests pass with the following implementation:</p>
<pre class="sourceCode java"><code class="sourceCode java">
<span class="kw">public</span> <span class="kw">interface</span> Command {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>();
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>();
}

<span class="kw">public</span> <span class="kw">class</span> ConcreteCommand <span class="kw">implements</span> Command {
    <span class="kw">private</span> Receiver receiver;
    
    <span class="kw">public</span> <span class="fu">ConcreteCommand</span>(Receiver receiver) {
        <span class="kw">this</span>.<span class="fu">receiver</span> = receiver;
    }
    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>() {
        <span class="kw">this</span>.<span class="fu">receiver</span>.<span class="fu">doSomething</span>();
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>() {
        <span class="kw">this</span>.<span class="fu">receiver</span>.<span class="fu">undoSomething</span>();
    }
}

<span class="kw">public</span> <span class="kw">class</span> Receiver {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doSomething</span>() {
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Doing something useful...&quot;</span>);
    }
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undoSomething</span>() {
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Undoing &#39;something useful&#39;...&quot;</span>);
    }
}

<span class="kw">public</span> <span class="kw">class</span> Invoker {
    <span class="kw">private</span> Command command = <span class="kw">null</span>;
    
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setCommand</span>(Command command) {
        <span class="kw">this</span>.<span class="fu">command</span> = command;
    }
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">action</span>() {
        <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">command</span> != <span class="kw">null</span>) {
            command.<span class="fu">execute</span>();
        }
    }
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>() {
        <span class="kw">if</span> (<span class="kw">this</span>.<span class="fu">command</span> != <span class="kw">null</span>) {
            command.<span class="fu">undo</span>();
        }
    }
}</code></pre>
<p>Reading the above code, it should be clear the path that the code takes when Invoker’s <em>action</em> is called; the Concrete Command’s <em>execute</em> is called, which in turn, calls the Receiver’s <em>doSomething</em> method. The code path for <em>undoing</em> is equally simple. This is a purposely pedentic example, but does show the general collaborations between the Invoker, Command, and Receiver objects.</p>
<h3 id="naming-conventions"><a href="#TOC">Naming Conventions</a></h3>
<p>One of the difficulties we’re presented with when trying to use design patterns, is how to map the names of a pattern’s collaborating objects to those in the system we’re trying to build. Should we incorporate the pattern being used as a suffix (e.g. MyFooInvoker, and MyBarReceiver, etc.)? Although this does have the advantage of indicating the pattern objects being used, it may start to look like a form of <em>Hungarian Notation</em>. The real question, however, is whether the resulting name properly describes the thing it represents. In some cases, the suffix approach might work; we could have Command objects named DogSitCommand and DogSpeakCommand. These actually do represent the thing being modelled (while still including the pattern object as a suffix).</p>
<p>As <a href="http://www.cc2e.com/Default.aspx">Code Complete 2</a> advocates, we should strive to describe only the thing being represented itself:</p>
<blockquote>
<p>Does the name fully and accurately describe what the variable represents? … Names should be specific as possible. Names that are vague enough or general enough to be used for more than one purpose are usually bad names.</p>
</blockquote>
<p>The take away (in our opinion) is, to remain flexible, but use your judgement as to whether the suffix approach will detract from a good variable name or not.</p>
<h2 id="example-a-user-interface-toolkit"><a href="#TOC">Example: A user interface toolkit</a></h2>
<p>The quintessential problem that lends itself to the Command Pattern is a <em>user interface toolkit</em>. For example, the toolkit might have widgets that a user interacts with like menu items, toolbar items, keyboard shortcuts, etc., that trigger certain actions. Let’s try to implement a subset of such a system.</p>
<h3 id="designing-on-the-go"><a href="#TOC">Designing <q>on the go</q></a></h3>
<p>We need to take a couple of minutes to figure out how we’re going to map our GUI’s objects to those defined in the Command Pattern. We can use a sort of <q>watered down</q> <a href="http://www.codinghorror.com/blog/2009/05/pseudocode-or-code.html">pseudocode programming process</a> approach to come up with something like the following:</p>
<pre class="sourceCode java"><code class="sourceCode java">    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testGUIImplementationOfCommandPattern</span>() {
        <span class="co">// 1. Instantiate a document &quot;Receiver&quot;</span>
            <span class="co">// We&#39;ll call ours: DocumentOperations</span>
            <span class="co">// open, close, cut, paste, etc.</span>
        <span class="co">// 2. Then add menu items (Commands):</span>
            <span class="co">// MenuItemOpen, MenuItemClosed, etc.</span>
            <span class="co">// ToolBarItemOpen, ToolBarItemClosed, etc.</span>
        <span class="co">// 3. UIEventsManager will act as our &quot;Invoker&quot;. We&#39;ll support:</span>
            <span class="co">// handleMenuPressEvent </span>
            <span class="co">// handleUndoMenuPressEvent</span>
            <span class="co">// handleToolBarPressEvent</span>
            <span class="co">// handleUndoToolBarPressEvent</span>
            <span class="co">// ... etc.</span>
    }</code></pre>
<p>If we were using PPP formally, we’d put these sorts of comments in a production method, and then replace each section with actual implementation code. But, in this case, we were actually sitting inside our first test case, looking for a way to quickly get our thoughts down; this type of bastardized PPP works fine for that purpose (yes, pencil and paper would work as well).</p>
<p>As you can see, we’ve decided that our <em>Receiver</em> will be a DocumentOperations class, and support open, close, cut, paste, etc.; our <em>Concrete Commands</em> will be MenuItemOpen, MenuItemClose, ToolBarItemOpen, ToolBarItemClosed, etc.; and our <em>Invoker</em> will be the UIEventsManager (in a real system we’d likely separate this one into more classes as it’s taking on too many responsibilities; but for this example, we’ll overlook this shortcoming); this will provide the corresponding event registration and handling, etc.</p>
<h3 id="implementation-4"><a href="#TOC">Implementation</a></h3>
<p>Ok, so we have a basic sketch of our design. Let’s implement this thing! For brevity’s sake, we’ll just implement the open, close, cut, and paste operations.</p>
<p>First, here are the tests for the GUI application:</p>
<pre class="sourceCode java"><code class="sourceCode java">
<span class="kw">import static org.junit.Assert.*;</span>
<span class="kw">import org.junit.After;</span>
<span class="kw">import org.junit.Before;</span>
<span class="kw">import org.junit.Test;</span>

<span class="co">//http://docs.mockito.googlecode.com/hg/org/mockito/Mockito.html</span>
<span class="kw">import static org.mockito.Mockito.*;</span>

<span class="kw">public</span> <span class="kw">class</span> GUITests {
    
    <span class="kw">private</span> ICommand mockMenuOpenCommand;
    <span class="kw">private</span> ICommand mockMenuCloseCommand;
    <span class="kw">private</span> ICommand mockMenuCut;
    <span class="kw">private</span> ICommand mockMenuPaste;
    
    <span class="kw">private</span> ToolBarItemOpen mockToolbarOpenCommand;
    <span class="kw">private</span> ToolBarItemClose mockToolbarCloseCommand;
    <span class="kw">private</span> ToolBarItemCut mockToolbarCut;
    <span class="kw">private</span> ToolBarItemPaste mockToolbarPaste;
    
    <span class="kw">private</span> UIEventsManager eventManager;
    <span class="kw">private</span> DocumentOperations mockDocumentOperations;

    @Before
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setUp</span>() {
        mockMenuOpenCommand = <span class="fu">mock</span>(MenuItemOpen.<span class="fu">class</span>);
        mockMenuCloseCommand = <span class="fu">mock</span>(MenuItemClose.<span class="fu">class</span>);
        mockMenuCut = <span class="fu">mock</span>(MenuItemCut.<span class="fu">class</span>);
        mockMenuPaste = <span class="fu">mock</span>(MenuItemPaste.<span class="fu">class</span>);
        mockToolbarOpenCommand = <span class="fu">mock</span>(ToolBarItemOpen.<span class="fu">class</span>);
        mockToolbarCloseCommand = <span class="fu">mock</span>(ToolBarItemClose.<span class="fu">class</span>);
        mockToolbarCut = <span class="fu">mock</span>(ToolBarItemCut.<span class="fu">class</span>);
        mockToolbarPaste = <span class="fu">mock</span>(ToolBarItemPaste.<span class="fu">class</span>);
        mockDocumentOperations = <span class="fu">mock</span>(DocumentOperations.<span class="fu">class</span>);
        eventManager = <span class="kw">new</span> <span class="fu">UIEventsManager</span>();
    }
    
    @After
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">tearDown</span>() {
        mockMenuOpenCommand = <span class="kw">null</span>;
        mockMenuCloseCommand = <span class="kw">null</span>;
        mockMenuCut = <span class="kw">null</span>;
        mockMenuPaste = <span class="kw">null</span>;
        mockToolbarOpenCommand = <span class="kw">null</span>;
        mockToolbarCloseCommand = <span class="kw">null</span>;
        mockToolbarCut = <span class="kw">null</span>;
        mockToolbarPaste = <span class="kw">null</span>;
        mockDocumentOperations = <span class="kw">null</span>;
        eventManager = <span class="kw">null</span>;
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testDocumentOperationsReceiverCalledForMenuOpen</span>() {
        ICommand menuOpenCommand = 
            <span class="kw">new</span> <span class="fu">MenuItemOpen</span>(mockDocumentOperations, <span class="st">&quot;foofile.txt&quot;</span>);
        menuOpenCommand.<span class="fu">execute</span>();
        <span class="fu">verify</span>(mockDocumentOperations, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">open</span>(<span class="st">&quot;foofile.txt&quot;</span>);
    }
        
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testDocumentOperationsReceiverCalledForToolbarOpen</span>() {
        ICommand toolbarOpenCommand =
            <span class="kw">new</span> <span class="fu">ToolBarItemOpen</span>(mockDocumentOperations, <span class="st">&quot;foo2file.txt&quot;</span>);
        toolbarOpenCommand.<span class="fu">execute</span>();
        <span class="fu">verify</span>(mockDocumentOperations, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">open</span>(<span class="st">&quot;foo2file.txt&quot;</span>);
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testDocumentOperationsReceiverCalledForMenuClose</span>() {
        ICommand menuCloseCommand =
            <span class="kw">new</span> <span class="fu">MenuItemClose</span>(mockDocumentOperations, <span class="st">&quot;foofile.txt&quot;</span>);
        menuCloseCommand.<span class="fu">execute</span>();
        <span class="fu">verify</span>(mockDocumentOperations, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">close</span>(<span class="st">&quot;foofile.txt&quot;</span>);
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testDocumentOperationsReceiverCalledForToolbarClose</span>() {
        ICommand toolbarCloseCommand =
            <span class="kw">new</span> <span class="fu">ToolBarItemClose</span>(mockDocumentOperations, <span class="st">&quot;foo2file.txt&quot;</span>);
        toolbarCloseCommand.<span class="fu">execute</span>();
        <span class="fu">verify</span>(mockDocumentOperations, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">close</span>(<span class="st">&quot;foo2file.txt&quot;</span>);
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testDocumentOperationsReceiverCalledForMenuCut</span>() {
        ICommand menuCutCommand =
            <span class="kw">new</span> <span class="fu">MenuItemCut</span>(mockDocumentOperations);
        menuCutCommand.<span class="fu">execute</span>();
        <span class="fu">verify</span>(mockDocumentOperations, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">cut</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testDocumentOperationsReceiverCalledForToolbarCut</span>() {
        ICommand toolbarCutCommand =
            <span class="kw">new</span> <span class="fu">ToolBarItemCut</span>(mockDocumentOperations);
        toolbarCutCommand.<span class="fu">execute</span>();
        <span class="fu">verify</span>(mockDocumentOperations, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">cut</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testDocumentOperationsReceiverCalledForMenuPaste</span>() {
        ICommand menuPasteCommand = 
            <span class="kw">new</span> <span class="fu">MenuItemPaste</span>(mockDocumentOperations);
        menuPasteCommand.<span class="fu">execute</span>();
        <span class="fu">verify</span>(mockDocumentOperations, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">paste</span>();
        menuPasteCommand.<span class="fu">undo</span>();
        <span class="fu">verify</span>(mockDocumentOperations, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">undoPaste</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testDocumentOperationsReceiverCalledForToolbarPaste</span>() {
        ICommand toolbarPasteCommand =
            <span class="kw">new</span> <span class="fu">ToolBarItemPaste</span>(mockDocumentOperations);
        toolbarPasteCommand.<span class="fu">execute</span>();
        <span class="fu">verify</span>(mockDocumentOperations, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">paste</span>();
        toolbarPasteCommand.<span class="fu">undo</span>();
        <span class="fu">verify</span>(mockDocumentOperations, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">undoPaste</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testInvokerInvokesMenuOpenConcreteCommand</span>() {
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;open&quot;</span>, mockMenuOpenCommand);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;open&quot;</span>);
        <span class="fu">verify</span>(mockMenuOpenCommand, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">execute</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testInvokerInvokesToolbarOpenConcreteCommand</span>() {
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;open&quot;</span>, mockToolbarOpenCommand);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;open&quot;</span>);
        <span class="fu">verify</span>(mockToolbarOpenCommand, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">execute</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testInvokerInvokesMenuClosedConcreteCommand</span>() {
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;close&quot;</span>, mockMenuCloseCommand);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;close&quot;</span>);
        <span class="fu">verify</span>(mockMenuCloseCommand, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">execute</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testInvokerInvokesToolbarClosedConcreteCommand</span>() {
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;close&quot;</span>, mockToolbarCloseCommand);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;close&quot;</span>);
        <span class="fu">verify</span>(mockToolbarCloseCommand, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">execute</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testInvokerInvokesMenuCut</span>() {
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;cut&quot;</span>, mockMenuCut);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;cut&quot;</span>);
        <span class="fu">verify</span>(mockMenuCut, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">execute</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testInvokerInvokesToolbarCut</span>() {
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;cut&quot;</span>, mockToolbarCut);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;cut&quot;</span>);
        <span class="fu">verify</span>(mockToolbarCut, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">execute</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testInvokerInvokesMenuPaste</span>() {
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;paste&quot;</span>, mockMenuPaste);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;paste&quot;</span>);
        <span class="fu">verify</span>(mockMenuPaste, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">execute</span>();
    }
    
    @Test
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testInvokerInvokesToolbarPaste</span>() {
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;paste&quot;</span>, mockToolbarPaste);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;paste&quot;</span>);
        <span class="fu">verify</span>(mockToolbarPaste, <span class="fu">times</span>(<span class="dv">1</span>)).<span class="fu">execute</span>();
    }
}</code></pre>
<p>And here are the various implementation files for the GUI system:</p>
<pre class="sourceCode java"><code class="sourceCode java">
<span class="co">// IDocumentOperations acts as a &quot;Receiver&quot; (Command Pattern)</span>
<span class="kw">public</span> <span class="kw">interface</span> IDocumentOperations {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">open</span>(String fileName);
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">close</span>(String fileName);
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">cut</span>();
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undoPaste</span>();
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">paste</span>();
}

<span class="kw">public</span> <span class="kw">class</span> DocumentOperations <span class="kw">implements</span> IDocumentOperations {

    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">open</span>(String fileName) {
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Opening &quot;</span> + fileName + <span class="st">&quot;...&quot;</span>);
    }

    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">close</span>(String fileName) {
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Closing &quot;</span> + fileName + <span class="st">&quot;...&quot;</span>);
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">cut</span>() {
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Cutting some text...&quot;</span>);
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">paste</span>() {
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Pasting some text...&quot;</span>);
    }
    
    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undoPaste</span>() {
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Undoing last paste operation...&quot;</span>);
    }
}

<span class="kw">public</span> <span class="kw">interface</span> ICommand {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>();
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>();
}

<span class="co">// MenuItemOpen acts as a &quot;ConcreteCommand&quot; (Command Pattern)</span>
<span class="kw">public</span> <span class="kw">class</span> MenuItemOpen <span class="kw">implements</span> ICommand {

    <span class="kw">private</span> IDocumentOperations documentOperations;
    <span class="kw">private</span> String fileName;
    
    <span class="kw">public</span> <span class="fu">MenuItemOpen</span>(IDocumentOperations documentOperations, String fileName) {
        <span class="kw">this</span>.<span class="fu">documentOperations</span> = documentOperations;
        <span class="kw">this</span>.<span class="fu">fileName</span> = fileName;
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>() {
        <span class="kw">this</span>.<span class="fu">documentOperations</span>.<span class="fu">open</span>(<span class="kw">this</span>.<span class="fu">fileName</span>);
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>() {} <span class="co">// NOP</span>

}

<span class="co">//MenuItemClosed acts as a &quot;ConcreteCommand&quot; (Command Pattern)</span>
<span class="kw">public</span> <span class="kw">class</span> MenuItemClose <span class="kw">implements</span> ICommand {
    <span class="kw">private</span> IDocumentOperations documentOperations;
    <span class="kw">private</span> String fileName;
    
    <span class="kw">public</span> <span class="fu">MenuItemClose</span>(IDocumentOperations documentOperations, String fileName) {
        <span class="kw">this</span>.<span class="fu">documentOperations</span> = documentOperations;
        <span class="kw">this</span>.<span class="fu">fileName</span> = fileName;
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>() {
        <span class="kw">this</span>.<span class="fu">documentOperations</span>.<span class="fu">close</span>(<span class="kw">this</span>.<span class="fu">fileName</span>);
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>() {} <span class="co">//NOP</span>

}

<span class="kw">public</span> <span class="kw">class</span> MenuItemCut <span class="kw">implements</span> ICommand {
    <span class="kw">private</span> IDocumentOperations documentOperations;
    
    <span class="kw">public</span> <span class="fu">MenuItemCut</span>(IDocumentOperations documentOperations) {
        <span class="kw">this</span>.<span class="fu">documentOperations</span> = documentOperations;
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>() {
        <span class="kw">this</span>.<span class="fu">documentOperations</span>.<span class="fu">cut</span>();
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>() {} <span class="co">//NOP</span>
}

<span class="kw">public</span> <span class="kw">class</span> MenuItemPaste <span class="kw">implements</span> ICommand {

    <span class="kw">private</span> IDocumentOperations documentOperations;
    
    <span class="kw">public</span> <span class="fu">MenuItemPaste</span>(IDocumentOperations documentOperations) {
        <span class="kw">this</span>.<span class="fu">documentOperations</span> = documentOperations;
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>() {
        <span class="kw">this</span>.<span class="fu">documentOperations</span>.<span class="fu">paste</span>();
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>() {
        <span class="kw">this</span>.<span class="fu">documentOperations</span>.<span class="fu">undoPaste</span>();
    }

}

<span class="kw">public</span> <span class="kw">class</span> ToolBarItemOpen <span class="kw">implements</span> ICommand {

    <span class="kw">private</span> IDocumentOperations documentOperations;
    <span class="kw">private</span> String fileName;
    
    <span class="kw">public</span> <span class="fu">ToolBarItemOpen</span>(IDocumentOperations documentOperations, String fileName) {
        <span class="kw">this</span>.<span class="fu">documentOperations</span> = documentOperations;
        <span class="kw">this</span>.<span class="fu">fileName</span> = fileName;
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>() {
        <span class="kw">this</span>.<span class="fu">documentOperations</span>.<span class="fu">open</span>(<span class="kw">this</span>.<span class="fu">fileName</span>);
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>() {} <span class="co">// NOP</span>

}

<span class="kw">public</span> <span class="kw">class</span> ToolBarItemClose <span class="kw">implements</span> ICommand {
    <span class="kw">private</span> IDocumentOperations documentOperations;
    <span class="kw">private</span> String fileName;
    
    <span class="kw">public</span> <span class="fu">ToolBarItemClose</span>(IDocumentOperations documentOperations, String fileName) {
        <span class="kw">this</span>.<span class="fu">documentOperations</span> = documentOperations;
        <span class="kw">this</span>.<span class="fu">fileName</span> = fileName;
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>() {
        <span class="kw">this</span>.<span class="fu">documentOperations</span>.<span class="fu">close</span>(<span class="kw">this</span>.<span class="fu">fileName</span>);
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>() {} <span class="co">//NOP</span>

}

<span class="kw">public</span> <span class="kw">class</span> ToolBarItemCut <span class="kw">implements</span> ICommand {
    <span class="kw">private</span> IDocumentOperations documentOperations;
    
    <span class="kw">public</span> <span class="fu">ToolBarItemCut</span>(IDocumentOperations documentOperations) {
        <span class="kw">this</span>.<span class="fu">documentOperations</span> = documentOperations;
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>() {
        <span class="kw">this</span>.<span class="fu">documentOperations</span>.<span class="fu">cut</span>();
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>() {} <span class="co">//NOP</span>
}

<span class="kw">public</span> <span class="kw">class</span> ToolBarItemPaste <span class="kw">implements</span> ICommand {

    <span class="kw">private</span> IDocumentOperations documentOperations;
    
    <span class="kw">public</span> <span class="fu">ToolBarItemPaste</span>(IDocumentOperations documentOperations) {
        <span class="kw">this</span>.<span class="fu">documentOperations</span> = documentOperations;
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">execute</span>() {
        <span class="kw">this</span>.<span class="fu">documentOperations</span>.<span class="fu">paste</span>();
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">undo</span>() {
        <span class="kw">this</span>.<span class="fu">documentOperations</span>.<span class="fu">undoPaste</span>();
    }

}

<span class="kw">import java.util.HashMap;</span>
<span class="kw">import java.util.Map;</span>

<span class="kw">public</span> <span class="kw">class</span> UIEventsManager {
    <span class="kw">private</span> Map&lt;String, ICommand&gt; menuCommandsMap = <span class="kw">new</span> HashMap&lt;String, ICommand&gt;();
    <span class="kw">private</span> Map&lt;String, ICommand&gt; toolBarCommandsMap = <span class="kw">new</span> HashMap&lt;String, ICommand&gt;();
    
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">addMenuCommand</span>(String key, ICommand menuCommand) {
        <span class="kw">this</span>.<span class="fu">menuCommandsMap</span>.<span class="fu">put</span>(key, menuCommand);
    }
    
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">addToolBarCommand</span>(String key, ICommand toolbarCommand) {
        <span class="kw">this</span>.<span class="fu">toolBarCommandsMap</span>.<span class="fu">put</span>(key, toolbarCommand);
    }
    
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">handleMenuPressEvent</span>(String key) {
        ICommand menuCommand = <span class="kw">this</span>.<span class="fu">menuCommandsMap</span>.<span class="fu">get</span>(key);
        <span class="kw">if</span> (menuCommand != <span class="kw">null</span>) {
            menuCommand.<span class="fu">execute</span>();
        }
    }
    
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">handleUndoMenuPressEvent</span>(String key) {
        ICommand menuCommand = <span class="kw">this</span>.<span class="fu">menuCommandsMap</span>.<span class="fu">get</span>(key);
        <span class="kw">if</span> (menuCommand != <span class="kw">null</span>) {
            menuCommand.<span class="fu">undo</span>();
        }
    }
    
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">handleToolBarPressEvent</span>(String key) {
        ICommand toolbarCommand = <span class="kw">this</span>.<span class="fu">toolBarCommandsMap</span>.<span class="fu">get</span>(key);
        <span class="kw">if</span> (toolbarCommand != <span class="kw">null</span>) {
            toolbarCommand.<span class="fu">execute</span>();
        }
    }
    
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">handleUndoToolBarPressEvent</span>(String key) {
        ICommand toolbarCommand = <span class="kw">this</span>.<span class="fu">toolBarCommandsMap</span>.<span class="fu">get</span>(key);
        <span class="kw">if</span> (toolbarCommand != <span class="kw">null</span>) {
            toolbarCommand.<span class="fu">undo</span>();
        }
    }
}</code></pre>
<p>Since we’ve taken the liberty to add print statements in our DocumentOperations (the Receiver in this case), we’ve decided to include a manual test (in addition to our unit tests):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> GUIManualTest {

    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(String[] args) {
        UIEventsManager eventManager =
            <span class="kw">new</span> <span class="fu">UIEventsManager</span>();
        DocumentOperations docOperations =
            <span class="kw">new</span> <span class="fu">DocumentOperations</span>();
        ICommand menuOpenCommand =
            <span class="kw">new</span> <span class="fu">MenuItemOpen</span>(docOperations, <span class="st">&quot;myfile.txt&quot;</span>);
        ICommand menuCloseCommand =
            <span class="kw">new</span> <span class="fu">MenuItemClose</span>(docOperations, <span class="st">&quot;myfile.txt&quot;</span>);
        ICommand menuCutCommand =
            <span class="kw">new</span> <span class="fu">MenuItemCut</span>(docOperations);
        ICommand menuPasteCommand =
            <span class="kw">new</span> <span class="fu">MenuItemPaste</span>(docOperations);
        
        ICommand toolbarOpenCommand =
            <span class="kw">new</span> <span class="fu">ToolBarItemOpen</span>(docOperations, <span class="st">&quot;myfile2.txt&quot;</span>);
        ICommand toolbarCloseCommand =
            <span class="kw">new</span> <span class="fu">ToolBarItemClose</span>(docOperations, <span class="st">&quot;myfile2.txt&quot;</span>);
        ICommand toolbarCutCommand =
            <span class="kw">new</span> <span class="fu">ToolBarItemCut</span>(docOperations);
        ICommand toolbarPasteCommand =
            <span class="kw">new</span> <span class="fu">ToolBarItemPaste</span>(docOperations);
        
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;open&quot;</span>, menuOpenCommand);
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;close&quot;</span>, menuCloseCommand);
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;cut&quot;</span>, menuCutCommand);
        eventManager.<span class="fu">addMenuCommand</span>(<span class="st">&quot;paste&quot;</span>, menuPasteCommand);
        eventManager.<span class="fu">addToolBarCommand</span>(<span class="st">&quot;open&quot;</span>, toolbarOpenCommand);
        eventManager.<span class="fu">addToolBarCommand</span>(<span class="st">&quot;close&quot;</span>, toolbarCloseCommand);
        eventManager.<span class="fu">addToolBarCommand</span>(<span class="st">&quot;cut&quot;</span>, toolbarCutCommand);
        eventManager.<span class="fu">addToolBarCommand</span>(<span class="st">&quot;paste&quot;</span>, toolbarPasteCommand);
        
        
        <span class="co">// Here we &quot;trigger&quot; some pertinent events</span>
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Manually testing the menu-based commands...&quot;</span>);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;open&quot;</span>);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;cut&quot;</span>);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;paste&quot;</span>);
        eventManager.<span class="fu">handleUndoMenuPressEvent</span>(<span class="st">&quot;paste&quot;</span>);
        eventManager.<span class="fu">handleMenuPressEvent</span>(<span class="st">&quot;close&quot;</span>);
        
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;Manually testing the toolbar-based commands...&quot;</span>);
        eventManager.<span class="fu">handleToolBarPressEvent</span>(<span class="st">&quot;open&quot;</span>);
        eventManager.<span class="fu">handleToolBarPressEvent</span>(<span class="st">&quot;cut&quot;</span>);
        eventManager.<span class="fu">handleToolBarPressEvent</span>(<span class="st">&quot;paste&quot;</span>);
        eventManager.<span class="fu">handleUndoToolBarPressEvent</span>(<span class="st">&quot;paste&quot;</span>);
        eventManager.<span class="fu">handleToolBarPressEvent</span>(<span class="st">&quot;close&quot;</span>);
    }

}</code></pre>
<p>Running this gives the following output:</p>
<pre class="shell"><code>
Manually testing the menu-based commands...
Opening myfile.txt...
Cutting some text...
Pasting some text...
Undoing last paste operation...
Closing myfile.txt...
Manually testing the toolbar-based commands...
Opening myfile2.txt...
Cutting some text...
Pasting some text...
Undoing last paste operation...
Closing myfile2.txt...</code></pre>
<h3 id="code-walk-through"><a href="#TOC">Code walk-through</a></h3>
<p>Although there is quite a bit of code in the above example, if you take a look at the <em>main</em> method in GUIManualTest, you should be able to see that we have the exact same <q>code flow</q> as we did in the simple pedentic exercise we started with earlier in this chapter. Let’s take the recipe we defined earlier for Command Pattern and apply it to the GUI system:</p>
<ul>
<li>a Client creates a Command Object, injecting it with a Receiever</li>
</ul>
<p>In our case, the Receiver is the DocumentOperations class, and this step is carried out as follows:</p>
<pre class="sourceCode java"><code class="sourceCode java">
ICommand toolbarOpenCommand = 
    <span class="kw">new</span> <span class="fu">ToolBarItemOpen</span>(docOperations, <span class="st">&quot;myfile2.txt&quot;</span>);</code></pre>
<ul>
<li>the Client stores this <q>command object</q> on the Invoker</li>
</ul>
<p>In our case, the UIEventsManager is our Invoker, and we store the command objects as follows:</p>
<pre class="sourceCode java"><code class="sourceCode java">
eventManager.<span class="fu">addToolBarCommand</span>(<span class="st">&quot;open&quot;</span>, toolbarOpenCommand);</code></pre>
<p>We’re storing our commands within the UIEventsManager as <em>Maps</em>. So the first argument (<q>open</q> in the above example), is the key that will be used to later look up the appropriate command when we want to trigger <em>execute</em>.</p>
<ul>
<li>the Invoker calls <em>execute</em> on the Command Object</li>
</ul>
<p>In our case, we’re triggering an event that will cause the Invoker to do this:</p>
<pre class="sourceCode java"><code class="sourceCode java">
eventManager.<span class="fu">handleToolBarPressEvent</span>(<span class="st">&quot;open&quot;</span>);</code></pre>
<ul>
<li>the Command Object, in turn, calls <em>action</em> on the Receiever</li>
</ul>
<p>As we know, our various Menu and ToolBar commands are delegating to the DocumentOperations class (the Receiver) to actually carry out the corresponding operations.</p>
<h1 id="template-pattern"><a href="#TOC">Template Pattern</a></h1>
<figure>
<img src="img/template-class.png"><figcaption></figcaption>
</figure>
<h2 id="overview-6"><a href="#TOC">Overview</a></h2>
<p>The Template Method’s intent is as follows:</p>
<blockquote>
<p>Define the skeleton of an algorithm in an operation, deferring some steps to subclasses. Template Method lets subclasses redefine certain steps of an algorithm without changing the algorithm’s structure—<a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">Gang of Four</a></p>
</blockquote>
<p>In the Template Method, we define an operation in a base class that has a particular sequence of <q>sub-operations</q>. This sequencing of calls from the Template Method to these sub-operations is an invariant—in fact, the template method itself, is often marked <em>final</em> so that it cannot be changed.</p>
<h2 id="hollywood-principle"><a href="#TOC">Hollywood Principle</a></h2>
<p>The arrangement of having a Template Method in the base class that calls operations defined by sub-classes is an example of using the <em>Hollywood Principle</em>: <q>Don’t call us, we’ll call you.</q>—an analogy drawn from how a typical casting call process works: A pool of talent shows up to audition for a <em>part</em>. Perhaps there’s sign in table where the talent leaves a media package (e.g. head shots, credit list, contact information, etc.). They are told to go to a waiting room (where they possibly wait all day), but eventually, get a chance to perform their audition. <em>Casting directors</em> watch, take notes, and likely make faces of disapproval. Later, through a process of elimination, the casting directors come up with a <em>casting list</em>.</p>
<p>Once the talent has finished their audition, the casting director might say: <q>don’t call us, we’ll call you</q>. This is, essentially, a dismissive way of saying <q>don’t bother to pursue the part any further…we’ll get a hold of you if we feel like it!</q>. This analogy is similar to the arrangement we have in Template Method: Sub-classes do not call operations on the parent (<q>don’t call us</q>)—they may override operations and even implement hooks—but only the parent gets to decides if and when these overriden operations get called (<q>we’ll call you!</q>).</p>
<h2 id="features"><a href="#TOC">Features</a></h2>
<p>Template method provides the following benefits:</p>
<ul>
<li>The base class provides a single entry point for execution</li>
<li>The base class has control of the sequence of performed operations for an algorithm</li>
<li>Sub classes provide implementation details</li>
<li>The base class may define <em>hook methods</em> with empty implementations that lower-level classes can choose to override</li>
</ul>
<h2 id="hooks"><a href="#TOC">Hooks</a></h2>
<p>Hook methods allow lower level components to <q>hook in to</q> a system. High-level classes determine exactly at which point these hooks are called. They are generally defined with empty implementations so that, if not overriden, nothing happens when they’re called. In fact (in this case), the real difference between the abstract and hook methods is that the former are required, the later optional.</p>
<h2 id="participants"><a href="#TOC">Participants</a></h2>
<ul>
<li><strong>AbstractClass:</strong> Defines the Template Method which will, in turn, call any of the following if defined:
<ul>
<li><strong>Concrete methods:</strong> Generalized methods that provide any shared functionality</li>
<li><strong>Abstract methods:</strong> Operations that sub-classes must override (required)</li>
<li><strong>Hook methods:</strong> Operations that sub-classes may override (optional)</li>
</ul></li>
</ul>
<h2 id="implementation-5"><a href="#TOC">Implementation</a></h2>
<p>The following is about the simplest implementation of Template Method you could find, but will help us to get a firm grasp of how this pattern works:</p>
<p>```java abstract class AbstractClass { public abstract void operation1(); public abstract void operation2(); public void hook1() {} public void hook2() {} public final void templateMethod() { hook1(); operation1(); operation2(); hook2(); } } class ConcreteClass extends AbstractClass { private String className = this.getClass().getSimpleName(); public void operation1() { System.out.println(className + <q>: operation1 called…</q>); } public void operation2() { System.out.println(className + <q>: operation2 called…</q>); } public void hook1() { System.out.println(className + <q>: hook1 called…</q>); } } class ConcreteClass2 extends AbstractClass { private String className = this.getClass().getSimpleName(); public void operation1() { System.out.println(className + <q>: operation1 called…</q>); } public void operation2() { System.out.println(className + <q>: operation2 called…</q>); } public void hook2() { System.out.println(className + <q>: hook2 called…</q>); } }</p>
<p>public class Template { public static void main(String[] args) { ConcreteClass cc1 = new ConcreteClass(); cc1.templateMethod(); ConcreteClass2 cc2 = new ConcreteClass2(); cc2.templateMethod(); } } ``` Unsurprisingly, running this code prints out the following:</p>
<pre><code>ConcreteClass: hook1 called...
ConcreteClass: operation1 called...
ConcreteClass: operation2 called...
ConcreteClass2: operation1 called...
ConcreteClass2: operation2 called...
ConcreteClass2: hook2 called...
</code></pre>

<p>We define the abstract class with both abstract operations and concrete <q>hook</q> operations (notice the empty code blocks); it also has the <em>templateMethod</em> which calls each of the aformentioned operations. Notice that the hooks will <q>no op</q> if not implemented by a particular sub-class. For example, the first ConcreteClass only implements <em>hook1</em> (and we see that in the output), whereas ConcreteClass2 only implements <em>hook2</em> (also reflected in the output).</p>
<h2 id="example-audio-decoder"><a href="#TOC">Example: Audio Decoder</a></h2>
<p>Let’s take a look at a slightly more interesting (albeit, still not <q>real world ready</q>) example of implementing an Audio Decoder abstraction. We want to be able to handle both MP3’s and AAC lossy audio formats, and have access to libraries that implement the low-level native details for each. We may want to support Ogg at a later date, and possibly even lossless formats too. Therefore, we need to comply with open/closed, and make sure that any classes we define don’t have to later be <q>opened up</q>.</p>
<p>First our tests:</p>
<p>```java</p>
<p>import static org.junit.Assert.*;</p>
<p>import org.junit.After; import org.junit.Before; import org.junit.Test;</p>
<p>//http://docs.mockito.googlecode.com/hg/org/mockito/Mockito.html import static org.mockito.Mockito.*;</p>
<p>public class AudioDecoderTests { private INativeDecoder mockNativeMP3Decoder; private INativeDecoder mockNativeAACDecoder;</p>
<pre><code>@Before
public void setUp() throws Exception {
    mockNativeMP3Decoder = mock(NativeMP3Decoder.class);
    mockNativeAACDecoder = mock(NativeAACDecoder.class);
}

@After
public void tearDown() throws Exception {
    mockNativeMP3Decoder = null;
    mockNativeAACDecoder = null;
}

@Test
public void testPlaysMP3s() {
    MP3Decoder mp3Decoder = new MP3Decoder(mockNativeMP3Decoder, &quot;my_song.mp3&quot;);
    mp3Decoder.play();
    verify(mockNativeMP3Decoder, times(1)).decode(null);
}

@Test
public void testPlaysAACs() {
    AACDecoder aacDecoder = new AACDecoder(mockNativeAACDecoder, &quot;my_song.aac&quot;);
    aacDecoder.play();
    verify(mockNativeAACDecoder, times(1)).decode(null);
}</code></pre>
<p>} ``` And here’s our partial implementation (we’ve decided to err on the side of brevity for this example as actually implementing an audio decoder might distract from this chapter’s topic—the Template Method pattern):</p>
<pre class="sourceCode java"><code class="sourceCode java">
<span class="kw">class</span> AudioInputStream {}

<span class="kw">public</span> <span class="kw">abstract</span> <span class="kw">class</span> AudioDecoder {
    <span class="kw">protected</span> String filePath;
    <span class="kw">protected</span> INativeDecoder decoder;
    
    <span class="kw">public</span> <span class="fu">AudioDecoder</span>(INativeDecoder decoder, String pathToAudioFile) {
        <span class="kw">this</span>.<span class="fu">filePath</span> = pathToAudioFile;
        <span class="kw">this</span>.<span class="fu">decoder</span> = decoder;
    }
    <span class="kw">public</span> <span class="kw">abstract</span> AudioInputStream <span class="fu">loadStream</span>();
    <span class="kw">public</span> <span class="kw">abstract</span> <span class="dt">void</span> <span class="fu">decode</span>(AudioInputStream ais);
    
    <span class="co">// Hooks</span>
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">beforeDecode</span>(){}
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">afterDecode</span>(){}
    
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">play</span>() {
        AudioInputStream ais = <span class="fu">loadStream</span>();
        <span class="fu">beforeDecode</span>();
        <span class="fu">decode</span>(ais);
        <span class="fu">afterDecode</span>();
    }
}

<span class="kw">interface</span> INativeDecoder {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">decode</span>(AudioInputStream ais);
}

<span class="kw">class</span> NativeAACDecoder <span class="kw">implements</span> INativeDecoder {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">decode</span>(AudioInputStream ais) {
        <span class="co">// ... complex decode implementation omitted</span>
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;NativeAACDecoder decoding audio stream...&quot;</span>);
    }
}

<span class="kw">class</span> NativeMP3Decoder <span class="kw">implements</span> INativeDecoder {
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">decode</span>(AudioInputStream ais) {
        <span class="co">// ... complex decode implementation omitted</span>
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;NativeMP3Decoder decoding audio stream...&quot;</span>);
    }
}

<span class="kw">class</span> AACDecoder <span class="kw">extends</span> AudioDecoder {
    
    <span class="kw">public</span> <span class="fu">AACDecoder</span>(INativeDecoder decoder, String pathToAudioFile) {
        <span class="kw">super</span>(decoder, pathToAudioFile);
    }

    @Override
    <span class="kw">public</span> AudioInputStream <span class="fu">loadStream</span>() {
        <span class="co">// ... complex code to load an AAC audio stream</span>
        <span class="kw">return</span> <span class="kw">null</span>;
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">decode</span>(AudioInputStream ais) {
        <span class="kw">this</span>.<span class="fu">decoder</span>.<span class="fu">decode</span>(ais);
    }
    
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">beforeDecode</span>(){
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;AAC staring...&quot;</span>);
    }
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">afterDecode</span>(){
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;AAC stopped...&quot;</span>);
    }
}

<span class="kw">class</span> MP3Decoder <span class="kw">extends</span> AudioDecoder {

    <span class="kw">public</span> <span class="fu">MP3Decoder</span>(INativeDecoder decoder, String pathToAudioFile) {
        <span class="kw">super</span>(decoder, pathToAudioFile);
    }

    @Override
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">decode</span>(AudioInputStream ais) {
        <span class="kw">this</span>.<span class="fu">decoder</span>.<span class="fu">decode</span>(ais);
    }
    
    @Override
    <span class="kw">public</span> AudioInputStream <span class="fu">loadStream</span>() {
        <span class="co">// ... complex code to load an MP3 audio stream</span>
        <span class="kw">return</span> <span class="kw">null</span>;
    }
    
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">beforeDecode</span>(){
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;MP3 staring...&quot;</span>);
    }
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">afterDecode</span>(){
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;MP3 stopped...&quot;</span>);
    }
}</code></pre>
<p>The INativeDecoder related classes are not a part of Template Method pattern. However, they are convenient <a href="http://xunitpatterns.com/DOC.html">DOC’s</a> that we mocked in our tests to confirm that the correct corresponding native implementations get called. For example, when we set up the MP3Decoder, we ensure that the <em>mockNativeMP3Decoder.decode</em> method gets called.</p>
<p><em>The astute reader may notice that our INativeDecoder’s look as though they’re being used almost like algorithms in the Strategy pattern (don’t get confused…we’re about to cover this pattern next!). That’s sort of true, but realistically, these native audio API’s would be much more complex, and also, since we don’t control them, they’re really not proper <q>strategy algorithms</q> per se.</em></p>
<h2 id="exercises-2"><a href="#TOC">Exercises</a></h2>
<p><strong>FeedReader:</strong> Implement a FeedReader that works with Atom, RSS1, RSS2, etc., and create an abstract FeedParser interface and with concrete implementations for each. The <em>readFeeds</em> will be the Template Method. You may use the following pseudocode to get started but feel free to <q>roll your own</q>:</p>
<pre class="sourceCode java"><code class="sourceCode java">
<span class="kw">abstract</span> <span class="kw">class</span> FeedReader {
    <span class="kw">public</span> <span class="dt">final</span> ArrayList&lt;Feed&gt; <span class="fu">readFeeds</span>(String url) {
        <span class="co">// .. omitted</span>
    }
    <span class="kw">abstract</span> String <span class="fu">getFeedTitle</span>();
    <span class="kw">abstract</span> String <span class="fu">getFeedAuthor</span>();
    <span class="kw">abstract</span> String <span class="fu">getFeedContent</span>();
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">beforeFeedParsed</span>() {}
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">afterFeedParsed</span>() {}
    <span class="co">// .. omitted</span>
}

<span class="kw">class</span> AtomReader <span class="kw">extends</span> FeedReader { ...
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">beforeFeedParsed</span>() {
        <span class="co">// override...</span>
    }
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">afterFeedParsed</span>() {
        <span class="co">// override...</span>
    }
    <span class="kw">abstract</span> String <span class="fu">getFeedTitle</span>() {
        <span class="co">// gets title</span>
    }
    <span class="kw">abstract</span> String <span class="fu">getFeedAuthor</span>() {
        <span class="co">// gets author</span>
    }
    <span class="kw">abstract</span> String <span class="fu">getFeedContent</span>() {
        <span class="co">// gets content</span>
    }
}
<span class="kw">class</span> RSS1Reader <span class="kw">extends</span> FeedReader { 
    <span class="co">//...</span>
}
<span class="kw">class</span> RSS2Reader <span class="kw">extends</span> FeedReader {
    <span class="co">// ...</span>
}</code></pre>
<h2 id="pitfalls-6"><a href="#TOC">Pitfalls</a></h2>
<p>The following are some disadvantages to Template Method:</p>
<ul>
<li><strong>Class explosion:</strong> As the needs of an application grows, you will be required to create new classes for each new behavior desired. This can lead to an explosion of template object</li>
<li><strong>Understandability:</strong> Since Template Method requires inheritance, it can become hard to reason about the various sub-classes involved</li>
<li><strong>Superclass coupling:</strong> As the super-class defines all involved operations, sub-classes are tightly couples to it</li>
</ul>
<h2 id="summary-2"><a href="#TOC">Summary</a></h2>
<p>The Template Method pattern lets subclasses define certain steps of an algorithm while preserving the sequence of these steps. It is somewhat similar to the Strategy pattern, in that the implementation details of certain behaviors are encapsulated and interchangeable. However, the Template Method uses <em>inheritance</em> to achieve its goals, whereas the Strategy uses <em>composition</em>. Template method also provides an opportunity to add hooks that clients can optionally implement. These hooks get called at certain points in the Template Method’s run-time execution (e.g. beforeXXX, afterXXX, onXXX, etc.).</p>
<p>Let’s look at a somewhat related pattern next…the Strategy Pattern.</p>
<h1 id="strategy-pattern"><a href="#TOC">Strategy Pattern</a></h1>
<figure>
<img src="img/strategy-class.png"><figcaption></figcaption>
</figure>
<h2 id="overview-7"><a href="#TOC">Overview</a></h2>
<p>The Strategy pattern allows us to:</p>
<blockquote>
<p>Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it—<a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">Gang of Four</a></p>
</blockquote>
<h2 id="features-1"><a href="#TOC">Features</a></h2>
<p>Strategy pattern provides the following benefits:</p>
<ul>
<li>provides a way to add variants of an algorithm by means of composition (as opposed to using inheritance like we did in Template Method)</li>
<li>provides an alternative to conditional branching moving the variant algorithms in to their own Strategy classes</li>
<li>allows you to add algorithms without having to reopen the base class; thus it complies with open/closed principle</li>
</ul>
<h2 id="participants-1"><a href="#TOC">Participants</a></h2>
<ul>
<li><strong>Strategy:</strong> Provides the common interface that all strategy algorithms will implement</li>
<li><strong>ConcreteStrategy:</strong> The classes that implement above Strategy interface</li>
<li><strong>Context:</strong> Gets injected with a particular ConcreteStrategy object at run-time</li>
</ul>
<h2 id="implementation-6"><a href="#TOC">Implementation</a></h2>
<p>Sticking to the audio analogy, let’s imagine a simple web audio player that provides a way to <em>play</em> and <em>pause</em> (we’ll keep it simple). We’d like to be able to switch between using an HTML5 audio implementation and a custom SWF implementation (Flash). Let’s assume there’s a mechanism in place such that the system knows at run-time whether it should use HTML5 or Flash for playing audio (this might be achieved via browser detection, URL naming conventions, etc.).</p>
<p>In the future we can imagine needing to add additional support for other audio formats (e.g. we may use a Java applet to play Ogg Vorbis audio, etc.). Thus we need an implementation that provides flexibility.</p>
<p>In this example, we’ll be using JavaScript. Here are the mocha tests:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">
<span class="co">// Install node.js, npm, mocha.js, and sinon.js:</span>
<span class="co">// $ npm install -g mocha</span>
<span class="co">// $ npm install sinon</span>
<span class="co">// $ mocha --ignore-leaks</span>
<span class="kw">var</span> sinon, assert, IStrategy, 
    HTML5AudioPlayer, SWFAudioPlayer, AudioPlayer;

assert = require(<span class="ch">&#39;assert&#39;</span>);
sinon = require(<span class="ch">&#39;sinon&#39;</span>);
IStrategy = require(<span class="st">&quot;../strategy.js&quot;</span>).<span class="fu">IStrategy</span>;
HTML5AudioPlayer = require(<span class="st">&quot;../strategy.js&quot;</span>).<span class="fu">HTML5AudioPlayer</span>;
SWFAudioPlayer = require(<span class="st">&quot;../strategy.js&quot;</span>).<span class="fu">SWFAudioPlayer</span>;
AudioPlayer = require(<span class="st">&quot;../strategy.js&quot;</span>).<span class="fu">AudioPlayer</span>;

describe(<span class="st">&quot;strategy tests&quot;</span>, <span class="kw">function</span>() {
    <span class="kw">var</span> html5AudioPlayer, swfAudioPlayer;

    beforeEach(<span class="kw">function</span>() {
        html5AudioPlayer = <span class="kw">new</span> HTML5AudioPlayer();
        swfAudioPlayer = <span class="kw">new</span> SWFAudioPlayer();
    });
    afterEach (<span class="kw">function</span>() {
        html5AudioPlayer = null;
        swfAudioPlayer = null;
    });

    it(<span class="st">&quot;should play html5 audio&quot;</span>, <span class="kw">function</span>() {
        <span class="kw">var</span> playSpy, player;

        playSpy = <span class="kw">sinon</span>.<span class="fu">spy</span>(html5AudioPlayer, <span class="st">&quot;play&quot;</span>);
        player = <span class="kw">new</span> AudioPlayer(html5AudioPlayer);

        <span class="kw">player</span>.<span class="fu">playAudio</span>();
        assert(<span class="kw">playSpy</span>.<span class="fu">called</span>);
        <span class="kw">html5AudioPlayer.play</span>.<span class="fu">restore</span>();
    });

    it(<span class="st">&quot;should pause html5 audio&quot;</span>, <span class="kw">function</span>() {
        <span class="kw">var</span> pauseSpy, player;

        pauseSpy = <span class="kw">sinon</span>.<span class="fu">spy</span>(html5AudioPlayer, <span class="st">&quot;pause&quot;</span>);
        player = <span class="kw">new</span> AudioPlayer(html5AudioPlayer);

        <span class="kw">player</span>.<span class="fu">playAudio</span>();
        <span class="kw">player</span>.<span class="fu">pauseAudio</span>();
        assert(<span class="kw">pauseSpy</span>.<span class="fu">called</span>);
        <span class="kw">html5AudioPlayer.pause</span>.<span class="fu">restore</span>();
    });

    it(<span class="st">&quot;should play Flash audio&quot;</span>, <span class="kw">function</span>() {
        <span class="kw">var</span> playSpy, player;

        playSpy = <span class="kw">sinon</span>.<span class="fu">spy</span>(swfAudioPlayer, <span class="st">&quot;play&quot;</span>);
        player = <span class="kw">new</span> AudioPlayer(swfAudioPlayer);

        <span class="kw">player</span>.<span class="fu">playAudio</span>();
        assert(<span class="kw">playSpy</span>.<span class="fu">called</span>);
        <span class="kw">swfAudioPlayer.play</span>.<span class="fu">restore</span>();
    });

    it(<span class="st">&quot;should pause Flash audio&quot;</span>, <span class="kw">function</span>() {
        <span class="kw">var</span> pauseSpy, player;

        pauseSpy = <span class="kw">sinon</span>.<span class="fu">spy</span>(swfAudioPlayer, <span class="st">&quot;pause&quot;</span>);
        player = <span class="kw">new</span> AudioPlayer(swfAudioPlayer);

        <span class="kw">player</span>.<span class="fu">playAudio</span>();
        <span class="kw">player</span>.<span class="fu">pauseAudio</span>();
        assert(<span class="kw">pauseSpy</span>.<span class="fu">called</span>);
        <span class="kw">swfAudioPlayer.pause</span>.<span class="fu">restore</span>();
    });
});</code></pre>
<p>Here is our implementation (note that our AudioPlayer is the <em>Context</em> and gets the Strategy object injected in into its constructor. Another variation is to pass the Strategy object to each operation directly; this provides later binding. However, binding early in the constructor does ensure our object is consistently initialized <em>before</em> any of its methods get called.).</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">
<span class="kw">var</span> IStrategy = <span class="kw">function</span>() {};
<span class="kw">IStrategy</span>.<span class="fu">prototype</span> = {
    <span class="dt">play</span>: <span class="kw">function</span>() {
        <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
    },
    <span class="dt">pause</span>: <span class="kw">function</span>() {
        <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
    }
};

<span class="kw">var</span> HTML5AudioPlayer = <span class="kw">function</span>() {};
<span class="kw">HTML5AudioPlayer</span>.<span class="fu">prototype</span> = <span class="kw">new</span> IStrategy(); 
<span class="kw">HTML5AudioPlayer</span>.<span class="fu">prototype</span> = {
    <span class="dt">play</span>: <span class="kw">function</span>() {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Playing HTML5 audio...&quot;</span>);
    },
    <span class="dt">pause</span>: <span class="kw">function</span>() {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Pausing HTML5 audio...&quot;</span>);
    }
};

<span class="kw">var</span> SWFAudioPlayer = <span class="kw">function</span>() {};
<span class="kw">SWFAudioPlayer</span>.<span class="fu">prototype</span> = <span class="kw">new</span> IStrategy(); 
<span class="kw">SWFAudioPlayer</span>.<span class="fu">prototype</span> = {
    <span class="dt">play</span>: <span class="kw">function</span>() {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Playing SWF audio...&quot;</span>);
    },
    <span class="dt">pause</span>: <span class="kw">function</span>() {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Pausing SWF audio...&quot;</span>);
    }
};

<span class="kw">var</span> AudioPlayer = <span class="kw">function</span>(playerStrategy) {
    <span class="kw">this</span>.<span class="fu">player</span> = playerStrategy;
};
<span class="kw">AudioPlayer</span>.<span class="fu">prototype</span> = {
    <span class="dt">playAudio</span>: <span class="kw">function</span>() {
        <span class="kw">this</span>.<span class="fu">player</span>.<span class="fu">play</span>();
    },
    <span class="dt">pauseAudio</span>: <span class="kw">function</span>() {
        <span class="kw">this</span>.<span class="fu">player</span>.<span class="fu">pause</span>();
    }
};

<span class="kw">module.exports</span>.<span class="fu">IStrategy</span> = IStrategy;
<span class="kw">module.exports</span>.<span class="fu">HTML5AudioPlayer</span> = HTML5AudioPlayer;
<span class="kw">module.exports</span>.<span class="fu">SWFAudioPlayer</span> = SWFAudioPlayer;
<span class="kw">module.exports</span>.<span class="fu">AudioPlayer</span> = AudioPlayer;</code></pre>
<h2 id="pitfalls-7"><a href="#TOC">Pitfalls</a></h2>
<p>The following are some disadvantages to Strategy patter:</p>
<ul>
<li><strong>Interface coupling:</strong> As the context depends on the Strategy’s interface, there’s some coupling between the two</li>
<li><strong>Complexity:</strong> Sometimes conditional branching is more immediately understandable than dynamic strategy algorithms (while the later is more flexible, you may not need it)</li>
<li><strong>Clients must decide which strategy to use:</strong> Clients must be able to select the correct Strategy algorithm to be injected in to the Context; sometimes this knowledge is non-trivial and adds complexity</li>
</ul>
<h2 id="summary-3"><a href="#TOC">Summary</a></h2>
<p>The Strategy pattern puts families of algorithms in to classes that can be <q>plugged in</q> at runtime. As the strategy pattern uses composition instead of inheritance, it provides a nice alternative to subclassing. Because these strategy algorithms can be injected at run-time, it’s fairly trivial to add behaviors to the system. This complies with the open/closed principle which states that objects should be open for change but closed for modification.</p>
<h1 id="state-pattern"><a href="#TOC">State Pattern</a></h1>
<h2 id="overview-8"><a href="#TOC">Overview</a></h2>
<p>The State pattern allows us to:</p>
<blockquote>
<p>Allow an object to alter its behavior when its internal state changes. The object will appear to change its class.—<a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">Gang of Four</a></p>
</blockquote>
<p>The State pattern is a behavioral design pattern that, much like the Strategy pattern, uses composition to encapsulate behaviors that must change at run-time. However, unlike the Strategy pattern, these encapsulated behaviors (or actions) are dependent on a Context object’s <em>current state</em>. When a certain action is requested of the Context, it simply delegates to its state reference, which takes care of determining how to best handle the request. That state will take in to account any rules for how it should respond to such a request. For example, if a door is in the <q>locked state</q>, and the action requested is <q>open door</q>, the appropriate result might be <q>entry denied</q> (whereas if the door is in the <q>closed state</q> (closed but unlocked), the same <q>open door</q> action might result in <q>door opened</q>).</p>
<figure>
<img src="img/state-class.png" alt="State Diagram"><figcaption>State Diagram</figcaption>
</figure>
<h2 id="participants-and-collaborations-1"><a href="#TOC">Participants and Collaborations</a></h2>
<ul>
<li><strong>Context:</strong> Delegates to <em>current state</em> when requests are made</li>
<li><strong>State:</strong> Defines the interface for concrete state classes to implement</li>
<li><strong>ConcreteState:</strong> Implements functionality for a particular state</li>
</ul>
<h2 id="design-process"><a href="#TOC">Design Process</a></h2>
<figure>
<img src="img/actions-states-transitions.png" alt="Actions, States, and Transitions for a typical Door"><figcaption>Actions, States, and Transitions for a typical Door</figcaption>
</figure>
<p>The first step to putting this all together is to enumerate the states and actions for the system (transitions can be enumerated later in the process).</p>
<h4 id="states"><a href="#TOC">States</a></h4>
<p>Enumerating the various states for our door example we come up with:</p>
<ul>
<li>Opened</li>
<li>Closed</li>
<li>Locked</li>
</ul>
<h4 id="actions"><a href="#TOC">Actions</a></h4>
<p>The actions required for our door example might be:</p>
<ul>
<li>unlock door</li>
<li>turn door knob</li>
<li>push door open</li>
<li>close door</li>
<li>lock door …and so on.</li>
</ul>
<h4 id="putting-it-all-together"><a href="#TOC">Putting it all together</a></h4>
<p>Now that we’ve determined the <em>states</em> and <em>actions</em>, we next need to determine the <em>transitions</em> (and get a picture of how these interactions will work together). Using a pen and pad (or graphics program), we can take the following steps:</p>
<ul>
<li>create a three column diagram ordered with actions, states, and transitions</li>
<li>under actions, list all the actions you’ll need</li>
<li>under the state column use circles to represent your states</li>
<li>for each action for a given state, determine if successfully completing that action results in a transition to another state; if so, add a rectangle with the name of the action under your transitions column adjacent to the state the action took place in</li>
<li>draw an arrow from the transition to the state it transitions to</li>
</ul>
<p>This process will give a good first glance at how the states will evolve. We used this approach to create the figures in this chapter.</p>
<h2 id="case-study-audio-application"><a href="#TOC">Case Study: Audio Application</a></h2>
<figure>
<img src="img/audio-state-design.png" alt="Audio State Design"><figcaption>Audio State Design</figcaption>
</figure>
<p>If you read the previous chapter on Strategy pattern, you may have noticed that we overlooked something when implementing the audio player—what happens if I hit play, but I’m already playing audio? Correspondingly, what happens if I hit pause, when not in the play mode? As we’ll see, the State pattern handles these types of quandaries wonderfully.</p>
<h3 id="implementation-7"><a href="#TOC">Implementation</a></h3>
<p>For our tests, we need to test each action for each state to confirm that the behavior is correct. So in the Playing state we test that:</p>
<ul>
<li><strong>play:</strong> does nothing</li>
<li><strong>stop:</strong> stops audio</li>
<li><strong>pause:</strong> pauses audio</li>
</ul>
<p>And of course we need similar tests for our Stopped and Paused states. We won’t show all the tests we came up with (see the book’s repo for that), but here are the ones for just the Paused state:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    describe(<span class="st">&quot;Paused&quot;</span>, <span class="kw">function</span>() {
        it(<span class="st">&quot;should transition from paused to playing state&quot;</span>,
        <span class="kw">function</span>() {
            <span class="kw">var</span> spyPausedPlay, spyLibPlay, player;

            spyPausedPlay = <span class="kw">sinon</span>.<span class="fu">spy</span>(paused, <span class="st">&quot;play&quot;</span>);
            spyLibPlay = <span class="kw">sinon</span>.<span class="fu">spy</span>(lib, <span class="st">&quot;play&quot;</span>);
            player = <span class="kw">new</span> AudioPlayer({  <span class="ch">&#39;playing&#39;</span>: playing, 
                                        <span class="ch">&#39;paused&#39;</span>: paused},
                                        <span class="ch">&#39;paused&#39;</span>);
            <span class="kw">player</span>.<span class="fu">playAudio</span>();
            assert(<span class="kw">spyPausedPlay</span>.<span class="fu">called</span>);
            assert(<span class="kw">spyLibPlay</span>.<span class="fu">called</span>);
            assert(<span class="kw">player</span>.<span class="fu">getState</span>()[<span class="ch">&#39;name&#39;</span>] === <span class="ch">&#39;Playing&#39;</span>);
            <span class="kw">spyPausedPlay</span>.<span class="fu">restore</span>();
        });
        it(<span class="st">&quot;should transition from paused to stopped state&quot;</span>,
        <span class="kw">function</span>() {
            <span class="kw">var</span> spyPausedStop, spyLibStop, player;

            spyPausedStop = <span class="kw">sinon</span>.<span class="fu">spy</span>(paused, <span class="st">&quot;stop&quot;</span>);
            spyLibStop = <span class="kw">sinon</span>.<span class="fu">spy</span>(lib, <span class="st">&quot;stop&quot;</span>);
            player = <span class="kw">new</span> AudioPlayer({  <span class="ch">&#39;playing&#39;</span>: playing, 
                                        <span class="ch">&#39;stopped&#39;</span>: stopped,
                                        <span class="ch">&#39;paused&#39;</span>: paused},
                                        <span class="ch">&#39;paused&#39;</span>);
            <span class="kw">player</span>.<span class="fu">stopAudio</span>();
            assert(<span class="kw">spyPausedStop</span>.<span class="fu">called</span>);
            assert(<span class="kw">spyLibStop</span>.<span class="fu">called</span>);
            assert(<span class="kw">player</span>.<span class="fu">getState</span>()[<span class="ch">&#39;name&#39;</span>] === <span class="ch">&#39;Stopped&#39;</span>);
            <span class="kw">spyPausedStop</span>.<span class="fu">restore</span>();
        });
        it(<span class="st">&quot;should not pause if already paused&quot;</span>,
        <span class="kw">function</span>() {
            <span class="kw">var</span> spyPausePause, spyLibPause, player;

            spyPausePause = <span class="kw">sinon</span>.<span class="fu">spy</span>(paused, <span class="st">&quot;pause&quot;</span>);
            spyLibPause = <span class="kw">sinon</span>.<span class="fu">spy</span>(lib, <span class="st">&quot;pause&quot;</span>);
            player = <span class="kw">new</span> AudioPlayer({  <span class="ch">&#39;playing&#39;</span>: playing, 
                                        <span class="ch">&#39;stopped&#39;</span>: stopped,
                                        <span class="ch">&#39;paused&#39;</span>: paused},
                                        <span class="ch">&#39;paused&#39;</span>);
            <span class="kw">player</span>.<span class="fu">pauseAudio</span>();
            assert(!<span class="kw">spyLibPause</span>.<span class="fu">called</span>);
            assert(<span class="kw">player</span>.<span class="fu">getState</span>()[<span class="ch">&#39;name&#39;</span>] === <span class="ch">&#39;Paused&#39;</span>);
            <span class="kw">spyPausePause</span>.<span class="fu">restore</span>();
        }); 
    });</code></pre>
<p><em>As we’ve mentioned in an earlier disclaimer, our test and production code are <q>overly optimistic</q> as we don’t test for bad inputs, etc. Again, we’ve purposely sacrificed robustness for more understandable code. In practice, we’d aim for much more thorough code!</em></p>
<p>The flow of the three tests are quite similar (with the last one simply negating that audio will be paused if already in the paused state):</p>
<ul>
<li>We create two test spies: One that corresponds with the low-level underlying audio library that is carrying out <em>play</em>, <em>pause</em>, and <em>stop</em>; and the other that corresponds to our ConcreteState’s action (e.g. the Paused state’s <em>play</em> method, etc.). With these two spies, we can simply assert whether or not they got called as appropriate.</li>
<li>We instantiate the AudioPlayer (our Context) injecting a map of our instantiated states as our first argument, and the key to the initial state as our second argument. Arranging the initialization of these objects outside of the AudioPlayer’s constructor makes it easy to create test doubles with state appropriate for that particular test case’s needs.</li>
<li>Once we have the above set up, we call the production method on the AudioPlayer (e.g. player.pauseAudio, etc.), and then assert that our spies got called as expected.</li>
<li>The last line of each test restores the spied on method to its original state. Sinon.js, essentially, hijacks these spy methods by intercepting any calls and then proxying to the original.</li>
</ul>
<p><em>These restore calls weren’t actually necessary for the above tests (we’re nulling out these objects in our teardown and re-creating them in subsequent setup methods), but we’ve left them in to show how this is done. For example, we would need to do restore if the spy pointed to the jQuery.ajax method (since jQuery is really a one time globally loaded lib).</em></p>
<p>Here’s our Audio State implementation:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// 3rd Party Lib</span>
<span class="kw">var</span> AudioLib = <span class="kw">function</span>() {};
<span class="kw">AudioLib</span>.<span class="fu">prototype</span> = {
    <span class="dt">play</span>: <span class="kw">function</span>() {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="ch">&#39;Playing audio...&#39;</span>);
    },
    <span class="dt">pause</span>: <span class="kw">function</span>() {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="ch">&#39;Pausing audio...&#39;</span>);
    },
    <span class="dt">stop</span>: <span class="kw">function</span>() {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="ch">&#39;Stopping audio...&#39;</span>);
    }
};

<span class="co">// Context</span>
<span class="kw">var</span> AudioPlayer = <span class="kw">function</span>(states, initialState) {
    <span class="kw">this</span>.<span class="fu">states</span> = states;
    <span class="kw">this</span>.<span class="fu">currentState</span> = states[initialState];
};
<span class="kw">AudioPlayer</span>.<span class="fu">prototype</span> = {
    <span class="dt">playAudio</span>: <span class="kw">function</span>() {
        <span class="kw">this</span>.<span class="fu">currentState</span>.<span class="fu">play</span>(<span class="kw">this</span>);
    },
    <span class="dt">pauseAudio</span>: <span class="kw">function</span>() {
        <span class="kw">this</span>.<span class="fu">currentState</span>.<span class="fu">pause</span>(<span class="kw">this</span>);
    },
    <span class="dt">stopAudio</span>: <span class="kw">function</span>() {
        <span class="kw">this</span>.<span class="fu">currentState</span>.<span class="fu">stop</span>(<span class="kw">this</span>);
    },
    <span class="dt">getState</span>: <span class="kw">function</span>() {
        <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">currentState</span>;
    },
    <span class="dt">setState</span>: <span class="kw">function</span>(newState) {
        <span class="kw">this</span>.<span class="fu">currentState</span> = <span class="kw">this</span>.<span class="fu">states</span>[newState];
    }
};

<span class="co">// State</span>
<span class="kw">var</span> IState = <span class="kw">function</span>(name) {
    <span class="kw">this</span>.<span class="fu">name</span> = name;
};
<span class="kw">IState</span>.<span class="fu">prototype</span> = {
    <span class="dt">play</span>: <span class="kw">function</span>(context) {
        <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
    },
    <span class="dt">pause</span>: <span class="kw">function</span>(context) {
        <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
    },
    <span class="dt">stop</span>: <span class="kw">function</span>(context) {
        <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
    }
};

<span class="co">// Concrete States</span>
<span class="kw">var</span> Playing = <span class="kw">function</span>(name, audioLib) {
    <span class="kw">this</span>.<span class="fu">name</span> = name;
    <span class="kw">this</span>.<span class="fu">audioLib</span> = audioLib;
};
<span class="kw">Playing</span>.<span class="fu">prototype</span> = <span class="kw">new</span> IState(); 
<span class="kw">Playing</span>.<span class="fu">prototype</span> = {
    <span class="dt">play</span>: <span class="kw">function</span>(context) {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Already playing ... nothing to do...&quot;</span>);
    },
    <span class="dt">pause</span>: <span class="kw">function</span>(context) {
        <span class="kw">this</span>.<span class="fu">audioLib</span>.<span class="fu">pause</span>();
        <span class="kw">context</span>.<span class="fu">setState</span>(<span class="ch">&#39;paused&#39;</span>);
    },
    <span class="dt">stop</span>: <span class="kw">function</span>(context) {
        <span class="kw">this</span>.<span class="fu">audioLib</span>.<span class="fu">stop</span>();
        <span class="kw">context</span>.<span class="fu">setState</span>(<span class="ch">&#39;stopped&#39;</span>);
    }
};

<span class="kw">var</span> Paused = <span class="kw">function</span>(name, audioLib) {
    <span class="kw">this</span>.<span class="fu">name</span> = name;
    <span class="kw">this</span>.<span class="fu">audioLib</span> = audioLib;
};
<span class="kw">Paused</span>.<span class="fu">prototype</span> = <span class="kw">new</span> IState(); 
<span class="kw">Paused</span>.<span class="fu">prototype</span> = {
    <span class="dt">play</span>: <span class="kw">function</span>(context) {
        <span class="kw">this</span>.<span class="fu">audioLib</span>.<span class="fu">play</span>();
        <span class="kw">context</span>.<span class="fu">setState</span>(<span class="ch">&#39;playing&#39;</span>);
    },
    <span class="dt">pause</span>: <span class="kw">function</span>(context) {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Already paused ... nothing to do&quot;</span>);
    },
    <span class="dt">stop</span>: <span class="kw">function</span>(context) {
        <span class="kw">this</span>.<span class="fu">audioLib</span>.<span class="fu">stop</span>();
        <span class="kw">context</span>.<span class="fu">setState</span>(<span class="ch">&#39;stopped&#39;</span>);
    }
};

<span class="kw">var</span> Stopped = <span class="kw">function</span>(name, audioLib) {
    <span class="kw">this</span>.<span class="fu">name</span> = name;
    <span class="kw">this</span>.<span class="fu">audioLib</span> = audioLib;
};
<span class="kw">Stopped</span>.<span class="fu">prototype</span> = <span class="kw">new</span> IState(); 
<span class="kw">Stopped</span>.<span class="fu">prototype</span> = {
    <span class="dt">play</span>: <span class="kw">function</span>(context) {
        <span class="kw">this</span>.<span class="fu">audioLib</span>.<span class="fu">play</span>();
        <span class="kw">context</span>.<span class="fu">setState</span>(<span class="ch">&#39;playing&#39;</span>);
    },
    <span class="dt">pause</span>: <span class="kw">function</span>(context) {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Can&#39;t pause when stopped...&quot;</span>);
    },
    <span class="dt">stop</span>: <span class="kw">function</span>(context) {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Already stopped... nothing to do&quot;</span>);
    }
};

<span class="kw">module.exports</span>.<span class="fu">IState</span> = IState;
<span class="kw">module.exports</span>.<span class="fu">AudioPlayer</span> = AudioPlayer;
<span class="kw">module.exports</span>.<span class="fu">AudioLib</span> = AudioLib;
<span class="kw">module.exports</span>.<span class="fu">Playing</span> = Playing;
<span class="kw">module.exports</span>.<span class="fu">Paused</span> = Paused;
<span class="kw">module.exports</span>.<span class="fu">Stopped</span> = Stopped;</code></pre>
<p>AudioLib is an imaginary library for doing the low-level audio work. As can be seen from the above code, our State’s implement all of the possible actions we’ve accounted for.</p>
<p>Essentially, one of three things can happen for a given action method: 1) the corresonding action is carried out 2) same as 1 but a transition to a new state is initiated 3) the method <q>no ops</q> (does nothing). In our system only 2 and 3 ever happen, but a more complicated system will have all three.</p>
<p>Since these action handlers are just methods, the implementer is free to put in whatever logic is required. This makes the State pattern particularly flexible (but also prone to too much complexity if a disciplined approach is not used).</p>
<p>As there’s always some flexibility in how we use a design pattern, we could have chosen to use an abstract intermediary class creating empty <q>no op</q> methods there, so that ConcreteState implementations only had to implement methods they care about. We’ll opt out of digressing in to how that might be implemented, but bring it up in case you’re bothered by the <q>no ops</q> above.</p>
<p>If you compare the above implementation to our Strategy one, you may be wondering if we’ve <q>lost out</q> since we now only have the one AudioLib (recall in our Strategy example we had HTML5, Flash, etc., audio implementations); with a bit of ingenuity we couldn certainly pass in various types of audio libraries at run-time if we wanted. We could even mix in Strategy and State (as design patterns are just guidelines to help us tackle problems. Using such <em>compound patterns</em> is quite common in practice.).</p>
<h2 id="other-use-cases"><a href="#TOC">Other Use Cases</a></h2>
<ul>
<li><strong>Sales Order:</strong> One classic example is a sales order that has discrete states like <q>New order</q>, <q>Dispatched</q>, <q>Shipped</q>, <q>Cancelled</q>, <q>Billed</q>, and so on.</li>
<li><strong>Transactions:</strong> Imagine a transaction that can be in the states: <q>not_in_transaction</q>, <q>in_transaction</q>, <q>commited</q>, <q>rolled_back</q>, etc.</li>
<li><strong>Graphics Tool:</strong> A simple paint tool might be able take on states like: <q>blur</q>, <q>erase</q>, <q>smudge</q>, <q>line</q>, <q>arrow</q>, etc., and draw accordingly.</li>
<li><strong>Intern to employee:</strong> Perhaps a company has states for their employees straight out of school. To become a <q>full blown employee</q> from intern that have to go through: <q>gopher</q>, <q>intern</q>, <q>skilled_helper</q>, <q>appreciated_apprentice</q>, etc. Perhaps the salary the intern is paid changes based on these levels. Further, perhaps, they must go through each level in sequence (you can’t jump from <q>gopher</q> to <q>appreciated_apprentice</q> for example).</li>
<li><strong>Vending machine:</strong> Another classic example with states like <q>waiting</q>, <q>coin_in</q>, <q>beverage_sent</q>, <q>coin_returned</q>, etc.</li>
</ul>
<h2 id="exercises-3"><a href="#TOC">Exercises</a></h2>
<p>Implement one or more of the above example use cases.</p>
<h2 id="benefits"><a href="#TOC">Benefits</a></h2>
<ul>
<li>Replaces long if or switch statements with encapsulated classes representing each state (<a href="http://www.artima.com/intv/dry.html">DRY</a>)</li>
<li>Gets rid of duplicate branching (related to first bullet point)</li>
<li>The encapsulated classes increase cohesion in the system</li>
<li>uses composition so we’re programming to an interface</li>
<li>Since the Context simply delegates to State classes more can be added as needed as long as they conform to the State interface</li>
</ul>
<h2 id="issues"><a href="#TOC">Issues</a></h2>
<ul>
<li>Increases complexity and might cause State class explosion</li>
<li>Since States are generally in charge of initiating transitions, they become coupled to the state(s) they transition to. However, it could be argued that this structured program flow is really more of a benefit than a burden</li>
</ul>
<h2 id="summary-4"><a href="#TOC">Summary</a></h2>
<p>The state pattern can be a helpful way to model problems that involve discrete states and actions that would typically require duplicate conditional logic throughout a code base. It’s a good example of using compositional delegation and programming to an interface. A well implemented state design can increase understandability since the states, actions, and transitions all relate very closely to the domain being modelled.</p>
<h1 id="composite-pattern"><a href="#TOC">Composite Pattern</a></h1>
<h2 id="overview-9"><a href="#TOC">Overview</a></h2>
<p>The Composite pattern allows us to:</p>
<blockquote>
<p>Compose objects into tree structures to represent part-whole hierarchies. Composite lets clients treat individual objects and compositions of objects uniformly.—<a href="http://www.amazon.com/Design-Patterns-Elements-Reusable-Object-Oriented/dp/0201633612/ref=pd_bxgy_b_text_y">Gang of Four</a></p>
</blockquote>
<p>Before we can understand how Composite pattern works, we need to understand some terms:</p>
<ul>
<li><em>Leaf</em>: A leaf is an individual component that has no children</li>
<li><em>Composite</em> A composite (also known as a <em>node</em> in tree terminology) is a component which may, in turn, contain other components (either leaf or composite).</li>
</ul>
<p>The structure we’re describing is, essentially, an inverted tree.</p>
<p>Using the Composite pattern, our leaf and composite components share one or more common operations—removing the need for client code to have to distinguish between the two—thus reducing the complexity of our code.</p>
<p>For example, imagine an online store that sells individual computer components, but also lets its customers assemble custom computers by arranging combinations of these components (they can choose their motherboard, cpu, power supply, etc.). When a customer proceeds to checkout, they might have any combination of individual parts, assembled computers, or both! How does the system get the price of each item given that the computers are really <em>composites</em> of individual components?</p>
<p>Using the composite pattern, the shopping cart system would be able to call <em>getPrice</em> on either an invidual component or an assembled computer. This is because the pattern defines a shared <em>Component</em> interface that both the leaf and composite implement (we’ll see later that this does come at a price).</p>
<h2 id="implementation-8"><a href="#TOC">Implementation</a></h2>
<p>At the core of this pattern is the ability for clients to treat individual items and aggregates the same. In our example, we want to be able to get the prices for individual computer parts, or, fully assembled computers. In the diagram below, you’ll notice that both the Leaf and the Composite components share the <em>operation</em> method—in our shopping cart example, this would map to the <em>getPrice</em> method:</p>
<figure>
<img src="img/composite-class.png"><figcaption></figcaption>
</figure>
<p>The following is an implementation solving the issue of totalling the prices for both computer parts and assembled computers as described earlier. This code is in JavaScript and uses the mocha.js testing library. If you’d like to run this code, you will need to install <a href="https://github.com/joyent/node">node.js</a>, <a href="https://npmjs.org/">npm</a>, and <a href="http://visionmedia.github.com/mocha/">mocha.js</a>. First let’s look at the tests:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="co">// Install node.js, npm, and then mocha:</span>
<span class="co">// $ npm install -g mocha</span>
<span class="co">// $ mocha --ignore-leaks</span>
<span class="kw">var</span> assert, Component, Computer, ComputerPart;

assert = require(<span class="ch">&#39;assert&#39;</span>);
Component = require(<span class="st">&quot;../composite.js&quot;</span>).<span class="fu">IComponent</span>;
Computer = require(<span class="st">&quot;../composite.js&quot;</span>).<span class="fu">Computer</span>;
ComputerPart = require(<span class="st">&quot;../composite.js&quot;</span>).<span class="fu">ComputerPart</span>;

describe(<span class="st">&quot;Composite tests&quot;</span>, <span class="kw">function</span>() {

    describe(<span class="st">&quot;Shared methods&quot;</span>, <span class="kw">function</span>() {

        it(<span class="st">&quot;should get price of a computer part&quot;</span>,
            <span class="kw">function</span>() {
            <span class="kw">var</span> computerPart, 
                expected = <span class="dv">99</span>;
            computerPart = <span class="kw">new</span> ComputerPart(expected);
            <span class="kw">assert</span>.<span class="fu">equal</span>(expected, <span class="kw">computerPart</span>.<span class="fu">getPrice</span>());
        });
        it(<span class="st">&quot;should get price of a part&quot;</span>, <span class="kw">function</span>() {
            <span class="kw">var</span> part = <span class="kw">new</span> ComputerPart(<span class="dv">10</span>);
            <span class="kw">assert</span>.<span class="fu">equal</span>(<span class="dv">10</span>, <span class="kw">part</span>.<span class="fu">getPrice</span>());
        });
        it(<span class="st">&quot;should be able to get price of a computer&quot;</span>,
            <span class="kw">function</span>() {
            <span class="kw">var</span> computer, expected;
            expected = <span class="dv">1234</span>;
            computer = <span class="kw">new</span> Computer(expected);
            <span class="kw">assert</span>.<span class="fu">equal</span>(expected, <span class="kw">computer</span>.<span class="fu">getPrice</span>());
        });
        it(<span class="st">&quot;should add parts and get total price&quot;</span>,
            <span class="kw">function</span>() {
            <span class="kw">var</span> computer, computerPart, computerPart2;
            computerPart = <span class="kw">new</span> ComputerPart(<span class="dv">10</span>);
            computerPart2 = <span class="kw">new</span> ComputerPart(<span class="dv">10</span>);
            computer = <span class="kw">new</span> Computer(<span class="dv">10</span>);
            <span class="kw">computer</span>.<span class="fu">add</span>(computerPart);
            <span class="kw">computer</span>.<span class="fu">add</span>(computerPart2);
            <span class="kw">assert</span>.<span class="fu">equal</span>(<span class="dv">30</span>, <span class="kw">computer</span>.<span class="fu">getPrice</span>());
        });
        it(<span class="st">&quot;should nest composite and leafs&quot;</span>,
            <span class="kw">function</span>() {
            <span class="kw">var</span> c1, c2, c3, p1, p2, p3;
            p1 = <span class="kw">new</span> ComputerPart(<span class="dv">1</span>);
            p2 = <span class="kw">new</span> ComputerPart(<span class="dv">1</span>);
            p3 = <span class="kw">new</span> ComputerPart(<span class="dv">1</span>);
            c1 = <span class="kw">new</span> Computer(<span class="dv">1</span>);
            c2 = <span class="kw">new</span> Computer(<span class="dv">1</span>);
            c3 = <span class="kw">new</span> Computer(<span class="dv">1</span>);
            <span class="kw">c3</span>.<span class="fu">add</span>(p3);
            <span class="kw">c2</span>.<span class="fu">add</span>(p2);
            <span class="kw">c2</span>.<span class="fu">add</span>(c3);
            <span class="kw">c1</span>.<span class="fu">add</span>(p1);
            <span class="kw">c1</span>.<span class="fu">add</span>(c2);
            <span class="kw">assert</span>.<span class="fu">equal</span>(<span class="dv">6</span>, <span class="kw">c1</span>.<span class="fu">getPrice</span>());
        });
        it(<span class="st">&quot;should remove parts from computers&quot;</span>, 
            <span class="kw">function</span>() {
            <span class="kw">var</span> computer, computerPart, computerPart2;
            computerPart = <span class="kw">new</span> ComputerPart(<span class="dv">10</span>);
            computerPart2 = <span class="kw">new</span> ComputerPart(<span class="dv">10</span>);
            computer = <span class="kw">new</span> Computer(<span class="dv">10</span>);
            <span class="kw">computer</span>.<span class="fu">add</span>(computerPart);
            <span class="kw">computer</span>.<span class="fu">add</span>(computerPart2);
            <span class="kw">computer</span>.<span class="fu">remove</span>(computerPart);
            <span class="kw">assert</span>.<span class="fu">equal</span>(<span class="dv">20</span>, <span class="kw">computer</span>.<span class="fu">getPrice</span>());
        });
        it(<span class="st">&quot;should not throw Error for no op methods&quot;</span>,
            <span class="kw">function</span>() {
            <span class="kw">var</span> part = <span class="kw">new</span> ComputerPart(<span class="dv">10</span>);
            <span class="kw">assert</span>.<span class="fu">equal</span>(<span class="kw">part</span>.<span class="fu">add</span>(null), undefined);
            <span class="kw">assert</span>.<span class="fu">equal</span>(<span class="kw">part</span>.<span class="fu">remove</span>(null), undefined);
        });
    });
});</code></pre>
<p>These tests show that we can, in fact, get the total price of recursively nested components (both leafs and composites). The very last test shows that we’ve opted to <q>no op</q> for the methods that aren’t appropriate for the Leaf component. These are <em>add</em> and <em>remove</em>, operations really meant for dealing with the nested composites (which doesn’t make sense for Leaf). This is an unfortunate aspect of Composite pattern—the Leaf component dredges up inappropriate methods from the Component interface it implements (we’ll discuss this more later in the chapter).</p>
<p>Let’s look at the implementation. Note that since JavaScript doesn’t offer interfaces (at the language level), we define <q>mandatory methods</q> on the prototype as a way to enfore they will be overriden.</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> IComponent = <span class="kw">function</span>() {
};
<span class="kw">IComponent.prototype</span>.<span class="fu">getPrice</span> = <span class="kw">function</span>() {
    <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
};
<span class="kw">IComponent.prototype</span>.<span class="fu">add</span> = <span class="kw">function</span>(component) {
    <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
};
<span class="kw">IComponent.prototype</span>.<span class="fu">remove</span> = <span class="kw">function</span>(component) {
    <span class="kw">throw</span> <span class="kw">new</span> Error(<span class="st">&quot;Method must be implemented.&quot;</span>); 
};

<span class="kw">var</span> Computer = <span class="kw">function</span>(price) {
    <span class="kw">this</span>.<span class="fu">price</span> = price;
    <span class="kw">this</span>.<span class="fu">components</span> = [];
};
<span class="kw">Computer</span>.<span class="fu">prototype</span> = <span class="kw">new</span> IComponent();
<span class="kw">Computer.prototype</span>.<span class="fu">getPrice</span> = <span class="kw">function</span>() {
    <span class="kw">var</span> i,
        len=<span class="kw">this</span>.<span class="fu">components</span>.<span class="fu">length</span>,
        total = <span class="kw">this</span>.<span class="fu">price</span>;

    <span class="kw">if</span> (len) {
        <span class="kw">for</span>(i=<span class="dv">0</span>; i&lt;len; i++) {
            total += <span class="kw">this</span>.<span class="fu">components</span>[i].<span class="fu">getPrice</span>();
        }
    }
    <span class="kw">return</span> total;
};
<span class="kw">Computer.prototype</span>.<span class="fu">add</span> = <span class="kw">function</span>(component) {
    <span class="kw">this</span>.<span class="fu">components</span>.<span class="fu">push</span>(component);
};
<span class="kw">Computer.prototype</span>.<span class="fu">remove</span> = <span class="kw">function</span>(componentToRemove) {
    <span class="kw">var</span> i,
        len = <span class="kw">this</span>.<span class="fu">components</span>.<span class="fu">length</span>,
        updatedArray = [];

    <span class="kw">for</span> (i = <span class="dv">0</span>; i &lt; len; i++) {
        <span class="co">// Pushes all but the one being removed </span>
        <span class="kw">if</span>(componentToRemove !== <span class="kw">this</span>.<span class="fu">components</span>[i]) {
            <span class="kw">updatedArray</span>.<span class="fu">push</span>(<span class="kw">this</span>.<span class="fu">components</span>[i]);
        }
    }
    <span class="kw">this</span>.<span class="fu">components</span> = updatedArray;
};

<span class="kw">var</span> ComputerPart = <span class="kw">function</span>(price) {
    <span class="kw">this</span>.<span class="fu">price</span> = price;
};
<span class="kw">ComputerPart</span>.<span class="fu">prototype</span> = <span class="kw">new</span> IComponent();
<span class="kw">ComputerPart.prototype</span>.<span class="fu">getPrice</span> = <span class="kw">function</span>() {
    <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">price</span>;
};
<span class="co">// No ops</span>
<span class="kw">ComputerPart.prototype</span>.<span class="fu">add</span> = <span class="kw">function</span>(component) {};
<span class="kw">ComputerPart.prototype</span>.<span class="fu">remove</span> = <span class="kw">function</span>(component) {};


<span class="kw">module.exports</span>.<span class="fu">IComponent</span> = IComponent;
<span class="kw">module.exports</span>.<span class="fu">Computer</span> = Computer;
<span class="kw">module.exports</span>.<span class="fu">ComputerPart</span> = ComputerPart;</code></pre>
<h2 id="issues-1"><a href="#TOC">Issues</a></h2>
<p>Two S.O.L.I.D. principles are violated by this pattern:</p>
<ul>
<li>The interface has two responsibilities, those related to leafs, and those related to composites. Thus we can say that it violates the Single Responsibility Principle.</li>
<li>Since Leaf components will need to implement <em>add</em> and <em>remove</em>, they will, in doing so, break the Liskov Substitution Principle (LSP) (one is quite <em>surprised</em> to see an <em>add</em> or <em>remove</em> method in a Leaf!).</li>
</ul>
<p>As you recall, we simply chose to <q>no op</q> in the Leaf implementation for these methods. The drawback to this approach is that there’s a chance we’re masking buggy client code.</p>
<p>There are some other alternatives (all with their own tradeoffs):</p>
<ul>
<li>Only define the composite related methods in the Composite class</li>
</ul>
<p>This has the drawback that client code now has to do run-time checks to determine if it’s dealing with a Leaf or a Composite component. Thus we can no longer treat all components uniformly (one of the main supposed benefits!)</p>
<ul>
<li>Throw exceptions in composite methods if called on the Leaf</li>
</ul>
<p>This trades robustness (the ability of a system to cope with errors, or, not crash), for type safety, ensuring that buggy client code isn’t masked.</p>
<p>You may also need to deal with some of the following challenges:</p>
<ul>
<li>Enforcing the restriction of certain components from composites</li>
<li>Ordering nested components</li>
<li>Performance issues due to deeply nested composites</li>
</ul>
<h2 id="summary-5"><a href="#TOC">Summary</a></h2>
<p>As we have seen, there are some design tradeoffs to take in to account when deciding whether or not to implement the Composite pattern. It favors <em>transparency</em> (being able to treat all components uniformly) over <em>safety</em>; and so you will be able to treat leaf and composite components operations the same. However, you will be violating SRP and LSP to some degree. As tradeoffs are a reality, you will have to use your judgement to decide if the benefits outweigh the costs.</p>
<script type="text/javascript">
/*
TODO
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'TODO-PUT-GA-ACOUNT-HERE']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
*/
</script>
</body>
</html>
